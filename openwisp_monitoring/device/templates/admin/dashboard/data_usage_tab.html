{% load static %}

<!-- Chart.js v3+ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<div class="home-datausage-wrap">

    <!-- ================= SUMMARY ROW ================= -->
    <div class="home-datausage-summary-section">
        <h4 class="home-datausage-summary-title">Summary</h4>

        <div class="home-datausage-summary-grid">
            <!-- Total Data Usage -->
            <div class="home-datausage-summary-card">
                <div class="home-datausage-summary-label">Total Data Usage</div>
                <div class="home-datausage-summary-main">
                    <span id="home-datausage-total-value" class="home-datausage-summary-value">0.00</span>
                    <span class="home-datausage-summary-unit">GB</span>
                </div>
                <div class="home-datausage-summary-metrics">
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Sent:</span>
                        <span id="home-datausage-total-sent" class="home-datausage-summary-metric-value">0.00 GB</span>
                    </div>
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Received:</span>
                        <span id="home-datausage-total-recv" class="home-datausage-summary-metric-value">0.00 GB</span>
                    </div>
                </div>
            </div>

            <!-- Cellular -->
            <div class="home-datausage-summary-card">
                <div class="home-datausage-summary-label">Cellular</div>
                <div class="home-datausage-summary-main">
                    <span id="home-datausage-cellular-value" class="home-datausage-summary-value">0.00</span>
                    <span class="home-datausage-summary-unit">GB</span>
                </div>
                <div class="home-datausage-summary-metrics">
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Sent:</span>
                        <span id="home-datausage-cellular-sent" class="home-datausage-summary-metric-value">0.00
                            GB</span>
                    </div>
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Received:</span>
                        <span id="home-datausage-cellular-recv" class="home-datausage-summary-metric-value">0.00
                            GB</span>
                    </div>
                </div>
            </div>

            <!-- Wired -->
            <div class="home-datausage-summary-card">
                <div class="home-datausage-summary-label">Wired</div>
                <div class="home-datausage-summary-main">
                    <span id="home-datausage-wired-value" class="home-datausage-summary-value">0.00</span>
                    <span class="home-datausage-summary-unit">GB</span>
                </div>
                <div class="home-datausage-summary-metrics">
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Sent:</span>
                        <span id="home-datausage-wired-sent" class="home-datausage-summary-metric-value">0.00 GB</span>
                    </div>
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Received:</span>
                        <span id="home-datausage-wired-recv" class="home-datausage-summary-metric-value">0.00 GB</span>
                    </div>
                </div>
            </div>

            <!-- Wireless -->
            <div class="home-datausage-summary-card">
                <div class="home-datausage-summary-label">Wireless</div>
                <div class="home-datausage-summary-main">
                    <span id="home-datausage-wireless-value" class="home-datausage-summary-value">0.00</span>
                    <span class="home-datausage-summary-unit">GB</span>
                </div>
                <div class="home-datausage-summary-metrics">
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Sent:</span>
                        <span id="home-datausage-wireless-sent" class="home-datausage-summary-metric-value">0.00
                            GB</span>
                    </div>
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Received:</span>
                        <span id="home-datausage-wireless-recv" class="home-datausage-summary-metric-value">0.00
                            GB</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= GRAPHS ROW ================= -->
    <div class="home-datausage-graph-grid">
        <!-- Top Applications -->
        <div class="home-datausage-card home-datausage-top-apps">
            <h4><span>Top Applications</span></h4>
            <div class="home-datausage-chart-container" id="top-apps-chart-container">
                <div id="chart-loading" class="home-datausage-loading-text">Loading…</div>
                <canvas id="topAppsChart"></canvas>
            </div>
        </div>

        <!-- Top Branches -->
        <div class="home-datausage-card home-datausage-top-branches">
            <h4><span>Top Branches</span></h4>
            <div class="home-datausage-chart-container" id="top-devices-chart-container">
                <div id="chart-loading-devices" class="home-datausage-loading-text">Loading…</div>
                <canvas id="topDevicesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);

    /* ========== TOP APPLICATIONS (from device_map, adapted to this DOM) ========== */
    async function fetchAndDisplayTopAppsChart() {
        const loadingEl = document.getElementById('chart-loading');
        const canvas = document.getElementById('topAppsChart');

        if (loadingEl) loadingEl.style.display = 'block';
        if (canvas) canvas.style.display = 'none';

        try {
            // Fetch global top apps
            const response = await fetch('https://controller.nexapp.co.in/api/v1/monitoring/global-top-apps/', {
                headers: { 'accept': 'application/json' }
            });

            console.log('Fetching Global Top Apps with URL:===', response.url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status} – ${response.statusText}`);
            }

            const data = await response.json();
            const topApps = Array.isArray(data?.top_10_apps) ? data.top_10_apps : [];

            // Prepare labels and values (bytes → MB or GB)
            const labels = topApps.map(item => String(item.label ?? ''));
            const values = topApps.map(item => {
                const bytes = Number(item.traffic) || 0;
                const mb = bytes / (1024 * 1024);
                if (mb >= 1000) {
                    return { value: +(mb / 1024).toFixed(2), unit: 'GB' };
                } else {
                    return { value: +mb.toFixed(1), unit: 'MB' };
                }
            });

            // Hide loading
            const chartContainer = document.getElementById('top-apps-chart-container');
            if (chartContainer) {
                const loadingElem = chartContainer.querySelector('.home-datausage-loading-text');
                if (loadingElem) loadingElem.style.display = 'none';
            }

            // Destroy old chart
            const existingChart = Chart.getChart('topAppsChart');
            if (existingChart) existingChart.destroy();

            const ctx = document.getElementById('topAppsChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            data: values.map(v => v.value),
                            backgroundColor: '#00acea',
                            borderRadius: 10,
                            barPercentage: 0.5,
                            categoryPercentage: 0.5,
                            barThickness: 8,
                            stack: 'stack0',
                            order: 2
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    layout: { padding: { right: 60 } },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: (val, index) => {
                                    const unit = values[index]?.unit || 'MB';
                                    return `${val} ${unit}`;
                                }
                            },
                            grid: { display: false }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { font: { size: 12, weight: '500' } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const unit = values[ctx.dataIndex]?.unit || 'MB';
                                    return ` ${ctx.parsed.x} ${unit}`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            offset: 6,
                            formatter: (val, ctx) => {
                                const unit = values[ctx.dataIndex]?.unit || 'MB';
                                return `${val} ${unit}`;
                            },
                            font: { weight: '500', size: 10 }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            if (loadingEl) loadingEl.remove();
            if (canvas) canvas.style.display = '';
        } catch (error) {
            console.error('Error fetching global top apps:', error);
            const chartContainer = document.getElementById('top-apps-chart-container');
            if (chartContainer) chartContainer.innerText = 'Error loading top apps';
        }
    }

    /* ========== TOP BRANCHES (top-devices-simple from device_map) ========== */

    async function fetchAndDisplayTopDevicesChart({
        org = 'ALL', time = '7d', limit = 10, wan_ifs = ''   // leave wan_ifs blank to sum all interfaces
    } = {}) {

        const loader = document.getElementById('chart-loading-devices');
        const canvas = document.getElementById('topDevicesChart');
        const container = document.getElementById('top-devices-chart-container');

        loader.style.display = 'block';
        canvas.style.display = 'none';

        const qs = new URLSearchParams({ org, time, limit, include_org: '1' });
        if (wan_ifs) qs.set('wan_ifs', wan_ifs);

        try {
            const resp = await fetch(`${window.API_BASE_URL}/api/v1/monitoring/top-devices-simple/?${qs.toString()}`, { credentials: 'include' });
            console.log('Fetching Top Devices with URL:===', resp);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const json = await resp.json();
            console.log('Top Devices data:', json);

            const rows = (json.top || []).slice(0, limit);
            if (!rows.length) {
                loader.textContent = 'No Data';
                return;
            }

            const labels = rows.map(r => r.name || r.device_id);
            const valuesGB = rows.map(r => (typeof r.total_gb === 'number')
                ? +r.total_gb
                : +((r.total_bytes || 0) / (1024 ** 3)).toFixed(3)
            );

            // Destroy previous chart if present
            const existing = Chart.getChart('topDevicesChart');
            if (existing) existing.destroy();

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data: valuesGB,
                        backgroundColor: '#00acea',
                        borderRadius: 10,
                        barThickness: 8,
                        barPercentage: 0.5,
                        categoryPercentage: 0.5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { display: false },
                            //title: { display: true, text: 'Total (GB)', font: { size: 10, weight: '500' } },
                            ticks: {
                                callback: (v) => `${v} GB`
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { font: { size: 12, weight: '500' } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ` ${ctx.parsed.x.toFixed(2)} GB`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            offset: 6,
                            formatter: (v, ctx) => `${v.toFixed(2)} GB`,
                            font: { weight: '500', size: 10 }
                        }
                    }
                }
            });

            loader.style.display = 'none';
            canvas.style.display = '';
        } catch (e) {
            console.error('Top Devices error:', e);
        }
    }

    // Initial render + refresh intervals WHEN PAGE LOADS
    document.addEventListener('DOMContentLoaded', () => {
        fetchAndDisplayTopAppsChart();
        fetchAndDisplayTopDevicesChart();

        setInterval(fetchAndDisplayTopAppsChart, 30000);      // 30s
        setInterval(fetchAndDisplayTopDevicesChart, 30000);   // 30s
    });
</script>
<script>
    async function fetchAndDisplaySummary() {
        try {
            const resp = await fetch("https://controller.nexapp.co.in/api/v1/monitoring/data-usage/", {
                headers: { accept: "application/json" }
            });

            if (!resp.ok) throw new Error("HTTP " + resp.status);

            const data = await resp.json();

            // Convert bytes → GB
            const toGB = (bytes) => +(bytes / (1024 * 1024 * 1024)).toFixed(2);

            /* ===== TOTAL ===== */
            const totalSentGB = toGB(data.total.sent);
            const totalRecvGB = toGB(data.total.received);
            const totalGB = toGB(data.total.total);

            document.getElementById("home-datausage-total-value").innerText = totalGB;
            document.getElementById("home-datausage-total-sent").innerText = totalSentGB + " GB";
            document.getElementById("home-datausage-total-recv").innerText = totalRecvGB + " GB";

            /* ===== CELLULAR ===== */
            document.getElementById("home-datausage-cellular-value").innerText = toGB(data.cellular.total);
            document.getElementById("home-datausage-cellular-sent").innerText = toGB(data.cellular.sent) + " GB";
            document.getElementById("home-datausage-cellular-recv").innerText = toGB(data.cellular.received) + " GB";

            /* ===== WIRED ===== */
            document.getElementById("home-datausage-wired-value").innerText = toGB(data.wired.total);
            document.getElementById("home-datausage-wired-sent").innerText = toGB(data.wired.sent) + " GB";
            document.getElementById("home-datausage-wired-recv").innerText = toGB(data.wired.received) + " GB";

            /* ===== WIRELESS ===== */
            document.getElementById("home-datausage-wireless-value").innerText = toGB(data.wireless.total);
            document.getElementById("home-datausage-wireless-sent").innerText = toGB(data.wireless.sent) + " GB";
            document.getElementById("home-datausage-wireless-recv").innerText = toGB(data.wireless.received) + " GB";

        } catch (e) {
            console.error("Summary load error:", e);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        fetchAndDisplaySummary();
        setInterval(fetchAndDisplaySummary, 30000);
    });
</script>


<style>
    .home-datausage-wrap {
        padding-top: 4px;
    }

    /* #ow-chart-contents {
        display: none !important;
    } */

    #ow-chart-inner-container {
        display: none !important;
    }

    /* ====== SUMMARY ROW ====== */

    .home-datausage-summary-section {
        padding: 25px 40px 10px 40px;
    }

    .home-datausage-summary-title {
        margin: 0 0 6px 0;
        font-size: 14px;
        font-weight: 600;
        color: #4b5563;
    }

    .home-datausage-summary-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(160px, 1fr));
        gap: 20px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        padding: 16px 18px;
        border: 1px solid #f3f4f6;
    }

    .home-datausage-summary-card {
        padding: 4px 6px;
        border-right: 1px solid #e5e7eb;
    }

    .home-datausage-summary-card:last-child {
        border-right: none;
    }

    .home-datausage-summary-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
    }

    .home-datausage-summary-main {
        display: flex;
        align-items: baseline;
        gap: 4px;
        margin-bottom: 6px;
    }

    .home-datausage-summary-value {
        font-size: 22px;
        font-weight: 700;
        color: #111827;
    }

    .home-datausage-summary-unit {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
    }

    .home-datausage-summary-metrics {
        font-size: 11px;
        color: #4b5563;
    }

    .home-datausage-summary-metric {
        display: flex;
        gap: 4px;
        line-height: 1.3;
    }

    .home-datausage-summary-metric-label {
        color: #6b7280;
    }

    .home-datausage-summary-metric-value {
        color: #16a34a;
        font-weight: 500;
    }

    /* ====== GRAPH ROW ====== */

    .home-datausage-graph-grid {
        display: grid;
        grid-gap: 20px;
        grid-template-columns: repeat(2, 1fr);
        margin: 0 auto;
        padding: 10px 40px 10px 40px;
    }

    .home-datausage-card {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        text-align: center;
    }

    .home-datausage-card h4 {
        margin-top: 0;
        font-size: 14px;
        margin-bottom: 0.4rem;
        color: #777;
        text-align: left;
    }

    .home-datausage-chart-container {
        position: relative;
        width: 100%;
        height: 270px;
    }

    .home-datausage-chart-container canvas {
        width: 100% !important;
        height: 270px !important;
    }

    .home-datausage-loading-text {
        font-size: 13px;
        color: #666;
        text-align: center;
        margin-top: 40px;
    }

    @media screen and (max-width: 1280px) {
        .home-datausage-summary-grid {
            grid-template-columns: repeat(2, minmax(180px, 1fr));
        }

        .home-datausage-summary-card {
            border-right: none;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .home-datausage-summary-card:nth-child(3),
        .home-datausage-summary-card:nth-child(4) {
            padding-top: 8px;
        }

        .home-datausage-summary-card:last-child {
            border-bottom: none;
        }
    }

    @media screen and (max-width: 1024px) {
        .home-datausage-graph-grid {
            grid-template-columns: 1fr;
        }
    }

    @media screen and (max-width: 600px) {

        .home-datausage-summary-section,
        .home-datausage-graph-grid {
            padding: 10px 16px;
        }

        .home-datausage-summary-grid {
            grid-template-columns: 1fr;
            padding: 12px 12px;
        }

        .home-datausage-summary-card {
            border-right: none;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .home-datausage-summary-card:last-child {
            border-bottom: none;
        }

        .home-datausage-chart-container canvas {
            height: 220px !important;
        }
    }
</style>