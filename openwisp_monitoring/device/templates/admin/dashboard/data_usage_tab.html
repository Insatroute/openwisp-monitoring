{% load static %}

<!-- Chart.js v3+ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<div class="home-datausage-wrap">

    <!-- ================= SUMMARY ROW ================= -->
    <div class="home-datausage-summary-section">
        <h4 class="home-datausage-summary-title">Summary</h4>

        <div class="home-datausage-summary-grid">
            <!-- Total Data Usage -->
            <div class="home-datausage-summary-card">
                <div class="home-datausage-summary-label">Total Data Usage</div>
                <div class="home-datausage-summary-main">
                    <span id="home-datausage-total-value" class="home-datausage-summary-value">0.00</span>
                    <span class="home-datausage-summary-unit">GB</span>
                </div>
                <div class="home-datausage-summary-metrics">
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Sent:</span>
                        <span id="home-datausage-total-sent" class="home-datausage-summary-metric-value">0.00 GB</span>
                    </div>
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Received:</span>
                        <span id="home-datausage-total-recv" class="home-datausage-summary-metric-value">0.00 GB</span>
                    </div>
                </div>
            </div>

            <!-- Cellular -->
            <div class="home-datausage-summary-card">
                <div class="home-datausage-summary-label">Cellular</div>
                <div class="home-datausage-summary-main">
                    <span id="home-datausage-cellular-value" class="home-datausage-summary-value">0.00</span>
                    <span class="home-datausage-summary-unit">GB</span>
                </div>
                <div class="home-datausage-summary-metrics">
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Sent:</span>
                        <span id="home-datausage-cellular-sent" class="home-datausage-summary-metric-value">0.00
                            GB</span>
                    </div>
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Received:</span>
                        <span id="home-datausage-cellular-recv" class="home-datausage-summary-metric-value">0.00
                            GB</span>
                    </div>
                </div>
            </div>

            <!-- Wired -->
            <div class="home-datausage-summary-card">
                <div class="home-datausage-summary-label">Wired</div>
                <div class="home-datausage-summary-main">
                    <span id="home-datausage-wired-value" class="home-datausage-summary-value">0.00</span>
                    <span class="home-datausage-summary-unit">GB</span>
                </div>
                <div class="home-datausage-summary-metrics">
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Sent:</span>
                        <span id="home-datausage-wired-sent" class="home-datausage-summary-metric-value">0.00 GB</span>
                    </div>
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Received:</span>
                        <span id="home-datausage-wired-recv" class="home-datausage-summary-metric-value">0.00 GB</span>
                    </div>
                </div>
            </div>

            <!-- Wireless -->
            <div class="home-datausage-summary-card">
                <div class="home-datausage-summary-label">Wireless</div>
                <div class="home-datausage-summary-main">
                    <span id="home-datausage-wireless-value" class="home-datausage-summary-value">0.00</span>
                    <span class="home-datausage-summary-unit">GB</span>
                </div>
                <div class="home-datausage-summary-metrics">
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Sent:</span>
                        <span id="home-datausage-wireless-sent" class="home-datausage-summary-metric-value">0.00
                            GB</span>
                    </div>
                    <div class="home-datausage-summary-metric">
                        <span class="home-datausage-summary-metric-label">Received:</span>
                        <span id="home-datausage-wireless-recv" class="home-datausage-summary-metric-value">0.00
                            GB</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= GRAPHS ROW ================= -->
    <div class="home-datausage-graph-grid">
        <!-- Top Applications -->
        <div class="home-datausage-card home-datausage-top-apps">
            <h4><span>Top Applications</span></h4>
            <div class="home-datausage-chart-container" id="top-apps-chart-container">
                <div id="chart-loading" class="home-datausage-loading-text">Loading…</div>
                <canvas id="topAppsChart"></canvas>
            </div>
        </div>

        <!-- Top Branches -->
        <div class="home-datausage-card home-datausage-top-branches">
            <h4><span>Top Branches</span></h4>
            <div class="home-datausage-chart-container" id="top-devices-chart-container">
                <div id="chart-loading-devices" class="home-datausage-loading-text">Loading…</div>
                <canvas id="topDevicesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ===== data-usage distribution cards ===== -->
    <div id="datausage-distribution-row" class="datausage-distribution-row">
        <div class="datausage-distribution-grid">

            <div class="ow-mini-card datausage-mini-card datausage-carrier-div">
                <h4 class="ow-mini-title datausage-mini-title datausage-carrier-span">
                    Top Group by data utilisation
                </h4>
                <div class="ow-mini-inner datausage-mini-inner">
                    <div id="DataUsage-Carrier-Distribution-chart" class="ow-mini-plot datausage-mini-plot">
                    </div>
                </div>
                <div class="ow-mini-legend datausage-mini-legend" id="DataUsage-Carrier-Distribution-legend">
                </div>
            </div>

            <div class="ow-mini-card datausage-mini-card datausage-network-div">
                <h4 class="ow-mini-title datausage-mini-title datausage-network-span">
                    Least Group by data utilisation
                </h4>
                <div class="ow-mini-inner datausage-mini-inner">
                    <div id="DataUsage-Network-Distribution-chart" class="ow-mini-plot datausage-mini-plot">
                    </div>
                </div>
                <div class="ow-mini-legend datausage-mini-legend" id="DataUsage-Network-Distribution-legend">
                </div>
            </div>

        </div>
    </div>
    <!-- =============================================== -->

</div>

<script>
    /* ---------- Donut with clickable legend (same helper, unchanged) ---------- */
    function renderDonutWithLegend(opts) {
        const { elId, legendId, labels, values, colors, redirectUrl } = opts;

        const el = document.getElementById(elId);
        const legendRoot = document.getElementById(legendId);
        if (!el || !legendRoot) return;

        const baseValues = (Array.isArray(values) ? values : []).map(v => Number(v) || 0);

        let active = baseValues.map(v => v > 0);
        if (active.every(a => !a) && active.length) {
            active[0] = true;
        }

        function totalActive() {
            return baseValues.reduce((acc, v, i) => acc + (active[i] ? v : 0), 0);
        }

        function makePlotValues() {
            const masked = baseValues.map((v, i) => (active[i] ? v : 0));
            const hasPositive = masked.some(v => v > 0);
            if (hasPositive) return masked;

            if (!masked.length) return masked;

            const clone = masked.slice();
            clone[0] = 1;
            return clone;
        }

        const plotValues = makePlotValues();

        const rect = el.getBoundingClientRect();
        const data = [{
            type: 'pie',
            labels: labels,
            values: plotValues,
            hole: 0.69,
            sort: false,
            direction: 'clockwise',
            texttemplate: '%{value} (%{percent})',
            textposition: 'inside',
            insidetextorientation: 'auto',
            textfont: { size: 9, color: '#ffffff' },
            textinfo: 'none',
            hoverinfo: 'label+value+percent',
            marker: { colors: colors || [] }
        }];
        const layout = {
            height: Math.max(140, Math.floor(rect.height || 150)),
            width: rect.width || el.clientWidth || 200,
            margin: { l: 6, r: 6, t: 6, b: 6 },
            showlegend: false,
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            annotations: [{
                showarrow: false,
                text: String(totalActive() || 0),
                x: 0.5, y: 0.5,
                font: { size: 13, color: '#2b2f36' }
            }]
        };
        if (typeof Plotly === 'undefined') return;

        Plotly.newPlot(el, data, layout, { responsive: true, displayModeBar: false });

        if (redirectUrl) {
            el.on('plotly_click', function () {
                window.location.href = redirectUrl;
            });
        }

        legendRoot.innerHTML = '';
        labels.forEach((label, i) => {
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.dataset.index = i;
            const sw = document.createElement('span');
            sw.className = 'legend-swatch';
            sw.style.background = (colors && colors[i]) ? colors[i] : '#353c44';
            const txt = document.createElement('span');
            txt.textContent = label;
            item.appendChild(sw);
            item.appendChild(txt);
            legendRoot.appendChild(item);
            if (!active[i]) item.classList.add('is-off');
        });

        legendRoot.addEventListener('click', (e) => {
            const node = e.target.closest('.legend-item');
            if (!node) return;
            const idx = parseInt(node.dataset.index, 10);

            active[idx] = !active[idx];

            const newPlotValues = makePlotValues();
            Plotly.restyle(el, { values: [newPlotValues] });
            Plotly.relayout(el, { 'annotations[0].text': String(totalActive() || 0) });
            node.classList.toggle('is-off', !active[idx]);
        });
    }

    /* ================== FETCH INTERFACES-SUMMARY (same, reused) ================== */

    async function fetchInterfacesSummaryForDataUsage() {
        const path = window.location.pathname;
        const match = path.match(/[0-9a-fA-F-]{36}/);
        const DEVICE_UUID = match ? match[0] : 'b5224a8d-ee4c-44a3-a7b0-5f30fac484b9';

        const base = window.API_BASE_URL || 'https://controller.nexapp.co.in';
        const url = `${base}/api/v1/monitoring/device/${DEVICE_UUID}/interfaces-summary/`;

        let token = null;
        try {
            token = await fetchAuthToken();
        } catch (e) {
            console.warn('fetchAuthToken error for interfaces-summary:', e);
        }

        const headers = { 'Accept': 'application/json' };
        if (token) headers['Authorization'] = `Token ${token}`;

        const resp = await fetch(url, { headers });
        console.log('datausage interfaces-summary response:===', resp);
        if (!resp.ok) {
            throw new Error(`interfaces-summary HTTP ${resp.status}`);
        }
        return resp.json();
    }

    /* ================== NEW: FETCH MOBILE-DISTRIBUTION FOR DATA USAGE ================== */

    async function fetchMobileDistributionForDataUsage() {
        const base = window.API_BASE_URL || 'https://controller.nexapp.co.in';
        const url = `${base}/api/v1/monitoring/mobile-distribution/`;

        let token = null;
        try {
            token = await fetchAuthToken();
        } catch (e) {
            console.warn('fetchAuthToken error for mobile-distribution:', e);
        }

        const headers = { 'Accept': 'application/json' };
        if (token) headers['Authorization'] = `Token ${token}`;

        const resp = await fetch(url, { headers });
        console.log('datausage mobile-distribution response:===', resp);
        if (!resp.ok) {
            throw new Error(`mobile-distribution HTTP ${resp.status}`);
        }
        return resp.json();
    }

    /* ================== INIT DATA USAGE CARRIER / NETWORK DONUTS ================== */

    async function initDataUsageDistributionChartsFromApi() {
        let ifSummary = {};
        let mobileDist = {};

        try {
            ifSummary = await fetchInterfacesSummaryForDataUsage();
            console.log('DataUsage: interfaces-summary:====', ifSummary);
        } catch (e) {
            console.error('DataUsage: Error fetching interfaces-summary:', e);
            ifSummary = {};
        }

        try {
            mobileDist = await fetchMobileDistributionForDataUsage();
            console.log('DataUsage: mobile-distribution:====', mobileDist);
        } catch (e) {
            console.error('DataUsage: Error fetching mobile-distribution:', e);
            mobileDist = {};
        }

        const interfaces = Array.isArray(ifSummary.interfaces) ? ifSummary.interfaces : [];
        const carriersCount = new Map();
        const techCount = new Map();

        for (const iface of interfaces) {
            if (!iface) continue;

            if (iface.type === 'mobile' && iface.mobile) {
                const op = (iface.mobile.operator_name || 'Unknown').trim() || 'Unknown';
                carriersCount.set(op, (carriersCount.get(op) || 0) + 1);

                const sig = iface.mobile.signal || {};
                const sigKey = Object.keys(sig)[0];
                if (sigKey) {
                    let label;
                    const low = sigKey.toLowerCase();
                    if (low === 'lte') label = '4G';
                    else if (low === '5g') label = '5G';
                    else label = sigKey.toUpperCase();
                    techCount.set(label, (techCount.get(label) || 0) + 1);
                }
            }
        }

        let carrierLabels = carriersCount.size
            ? Array.from(carriersCount.keys())
            : ['No data'];
        let carrierValues = carriersCount.size
            ? carrierLabels.map(k => carriersCount.get(k))
            : [0];

        const preferredOrder = ['5G', '4G'];
        const allTechKeys = Array.from(techCount.keys());
        const orderedTech = [
            ...preferredOrder.filter(k => techCount.has(k)),
            ...allTechKeys.filter(k => !preferredOrder.includes(k))
        ];
        let networkLabels = orderedTech.length ? orderedTech : ['No data'];
        let networkValues = orderedTech.length
            ? networkLabels.map(k => techCount.get(k))
            : [0];

        if (
            mobileDist &&
            mobileDist.carrier &&
            Array.isArray(mobileDist.carrier.labels) &&
            Array.isArray(mobileDist.carrier.data) &&
            mobileDist.carrier.labels.length
        ) {
            carrierLabels = mobileDist.carrier.labels.length
                ? mobileDist.carrier.labels
                : ['No data'];

            carrierValues = mobileDist.carrier.data.length
                ? mobileDist.carrier.data
                : new Array(mobileDist.carrier.labels.length || 1).fill(0);
        }

        if (
            mobileDist &&
            mobileDist.network &&
            Array.isArray(mobileDist.network.labels) &&
            Array.isArray(mobileDist.network.data) &&
            mobileDist.network.labels.length
        ) {
            networkLabels = mobileDist.network.labels.length
                ? mobileDist.network.labels
                : ['No data'];

            networkValues = mobileDist.network.data.length
                ? mobileDist.network.data
                : new Array(mobileDist.network.labels.length || 1).fill(0);
        }

        /* ===== STATIC DATA FOR DISPLAY (YOU REQUESTED DIFFERENT COLORS) ===== */
        carrierLabels = ["Airtel", "Jio", "Vi"];
        carrierValues = [12, 8, 5];
        const palette1 = ["#1f77b4", "#ff7f0e", "#2ca02c"];

        networkLabels = ["4G", "5G", "3G"];
        networkValues = [20, 9, 4];
        const palette2 = ["#2ca02c", "#6366f1", "#f43f5e"];

        renderDonutWithLegend({
            elId: 'DataUsage-Carrier-Distribution-chart',
            legendId: 'DataUsage-Carrier-Distribution-legend',
            labels: carrierLabels,
            values: carrierValues,
            colors: palette1,
        });

        renderDonutWithLegend({
            elId: 'DataUsage-Network-Distribution-chart',
            legendId: 'DataUsage-Network-Distribution-legend',
            labels: networkLabels,
            values: networkValues,
            colors: palette2,
        });
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initDataUsageDistributionChartsFromApi();
    } else {
        document.addEventListener('DOMContentLoaded', initDataUsageDistributionChartsFromApi);
    }

    // ensure donuts resize correctly on zoom / orientation / device change
    window.addEventListener('resize', function () {
        if (typeof Plotly === 'undefined') return;
        [
            'DataUsage-Carrier-Distribution-chart',
            'DataUsage-Network-Distribution-chart',
            'DataUsage-Interface-Distribution-chart'
        ].forEach(function (id) {
            var el = document.getElementById(id);
            if (el) {
                try { Plotly.Plots.resize(el); } catch (e) { }
            }
        });
    });
</script>


<script>
    Chart.register(ChartDataLabels);

    /* ========== TOP APPLICATIONS (from device_map, adapted to this DOM) ========== */
    async function fetchAndDisplayTopAppsChart() {
        const loadingEl = document.getElementById('chart-loading');
        const canvas = document.getElementById('topAppsChart');

        if (loadingEl) loadingEl.style.display = 'block';
        if (canvas) canvas.style.display = 'none';

        try {
            // Fetch global top apps
            const response = await fetch('https://controller.nexapp.co.in/api/v1/monitoring/global-top-apps/', {
                headers: { 'accept': 'application/json' }
            });

            console.log('Fetching Global Top Apps with URL:===', response.url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status} – ${response.statusText}`);
            }

            const data = await response.json();
            const topApps = Array.isArray(data?.top_10_apps) ? data.top_10_apps : [];

            // Prepare labels and values (bytes → MB or GB)
            const labels = topApps.map(item => String(item.label ?? ''));
            const values = topApps.map(item => {
                const bytes = Number(item.traffic) || 0;
                const mb = bytes / (1024 * 1024);
                if (mb >= 1000) {
                    return { value: +(mb / 1024).toFixed(2), unit: 'GB' };
                } else {
                    return { value: +mb.toFixed(1), unit: 'MB' };
                }
            });

            // Hide loading
            const chartContainer = document.getElementById('top-apps-chart-container');
            if (chartContainer) {
                const loadingElem = chartContainer.querySelector('.home-datausage-loading-text');
                if (loadingElem) loadingElem.style.display = 'none';
            }

            // Destroy old chart
            const existingChart = Chart.getChart('topAppsChart');
            if (existingChart) existingChart.destroy();

            const ctx = document.getElementById('topAppsChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            data: values.map(v => v.value),
                            backgroundColor: '#00acea',
                            borderRadius: 10,
                            barPercentage: 0.5,
                            categoryPercentage: 0.5,
                            barThickness: 8,
                            stack: 'stack0',
                            order: 2
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    layout: { padding: { right: 60 } },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: (val, index) => {
                                    const unit = values[index]?.unit || 'MB';
                                    return `${val} ${unit}`;
                                }
                            },
                            grid: { display: false }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { font: { size: 12, weight: '500' } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const unit = values[ctx.dataIndex]?.unit || 'MB';
                                    return ` ${ctx.parsed.x} ${unit}`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            offset: 6,
                            formatter: (val, ctx) => {
                                const unit = values[ctx.dataIndex]?.unit || 'MB';
                                return `${val} ${unit}`;
                            },
                            font: { weight: '500', size: 10 }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            if (loadingEl) loadingEl.remove();
            if (canvas) canvas.style.display = '';
        } catch (error) {
            console.error('Error fetching global top apps:', error);
            const chartContainer = document.getElementById('top-apps-chart-container');
            if (chartContainer) chartContainer.innerText = 'Error loading top apps';
        }
    }

    /* ========== TOP BRANCHES (top-devices-simple from device_map) ========== */

    async function fetchAndDisplayTopDevicesChart({
        org = 'ALL', time = '7d', limit = 10, wan_ifs = ''   // leave wan_ifs blank to sum all interfaces
    } = {}) {

        const loader = document.getElementById('chart-loading-devices');
        const canvas = document.getElementById('topDevicesChart');
        const container = document.getElementById('top-devices-chart-container');

        loader.style.display = 'block';
        canvas.style.display = 'none';

        const qs = new URLSearchParams({ org, time, limit, include_org: '1' });
        if (wan_ifs) qs.set('wan_ifs', wan_ifs);

        try {
            const resp = await fetch(`${window.API_BASE_URL}/api/v1/monitoring/top-devices-simple/?${qs.toString()}`, { credentials: 'include' });
            console.log('Fetching Top Devices with URL:===', resp);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const json = await resp.json();
            console.log('Top Devices data:', json);

            const rows = (json.top || []).slice(0, limit);
            if (!rows.length) {
                loader.textContent = 'No Data';
                return;
            }

            const labels = rows.map(r => r.name || r.device_id);
            const valuesGB = rows.map(r => (typeof r.total_gb === 'number')
                ? +r.total_gb
                : +((r.total_bytes || 0) / (1024 ** 3)).toFixed(3)
            );

            // Destroy previous chart if present
            const existing = Chart.getChart('topDevicesChart');
            if (existing) existing.destroy();

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data: valuesGB,
                        backgroundColor: '#00acea',
                        borderRadius: 10,
                        barThickness: 8,
                        barPercentage: 0.5,
                        categoryPercentage: 0.5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { display: false },
                            //title: { display: true, text: 'Total (GB)', font: { size: 10, weight: '500' } },
                            ticks: {
                                callback: (v) => `${v} GB`
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { font: { size: 12, weight: '500' } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ` ${ctx.parsed.x.toFixed(2)} GB`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            offset: 6,
                            formatter: (v, ctx) => `${v.toFixed(2)} GB`,
                            font: { weight: '500', size: 10 }
                        }
                    }
                }
            });

            loader.style.display = 'none';
            canvas.style.display = '';
        } catch (e) {
            console.error('Top Devices error:', e);
        }
    }

    // Initial render + refresh intervals WHEN PAGE LOADS
    document.addEventListener('DOMContentLoaded', () => {
        fetchAndDisplayTopAppsChart();
        fetchAndDisplayTopDevicesChart();

        setInterval(fetchAndDisplayTopAppsChart, 30000);      // 30s
        setInterval(fetchAndDisplayTopDevicesChart, 30000);   // 30s
    });
</script>

<script>
    window.OW_HIDE_CHARTS = true;

    console.log('Data usage tab script loaded, OW_HIDE_CHARTS set to true.=====', window.OW_HIDE_CHARTS);

    async function fetchAndDisplaySummary() {
        try {
            const resp = await fetch("https://controller.nexapp.co.in/api/v1/monitoring/data-usage/", {
                headers: { accept: "application/json" }
            });

            if (!resp.ok) throw new Error("HTTP " + resp.status);

            const data = await resp.json();

            // Convert bytes → GB
            const toGB = (bytes) => +(bytes / (1024 * 1024 * 1024)).toFixed(2);

            /* ===== TOTAL ===== */
            const totalSentGB = toGB(data.total.sent);
            const totalRecvGB = toGB(data.total.received);
            const totalGB = toGB(data.total.total);

            document.getElementById("home-datausage-total-value").innerText = totalGB;
            document.getElementById("home-datausage-total-sent").innerText = totalSentGB + " GB";
            document.getElementById("home-datausage-total-recv").innerText = totalRecvGB + " GB";

            /* ===== CELLULAR ===== */
            document.getElementById("home-datausage-cellular-value").innerText = toGB(data.cellular.total);
            document.getElementById("home-datausage-cellular-sent").innerText = toGB(data.cellular.sent) + " GB";
            document.getElementById("home-datausage-cellular-recv").innerText = toGB(data.cellular.received) + " GB";

            /* ===== WIRED ===== */
            document.getElementById("home-datausage-wired-value").innerText = toGB(data.wired.total);
            document.getElementById("home-datausage-wired-sent").innerText = toGB(data.wired.sent) + " GB";
            document.getElementById("home-datausage-wired-recv").innerText = toGB(data.wired.received) + " GB";

            /* ===== WIRELESS ===== */
            document.getElementById("home-datausage-wireless-value").innerText = toGB(data.wireless.total);
            document.getElementById("home-datausage-wireless-sent").innerText = toGB(data.wireless.sent) + " GB";
            document.getElementById("home-datausage-wireless-recv").innerText = toGB(data.wireless.received) + " GB";

        } catch (e) {
            console.error("Summary load error:", e);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        fetchAndDisplaySummary();
        setInterval(fetchAndDisplaySummary, 30000);
    });
</script>

<style>
    /* ===== DATA USAGE mini donut cards (copies of overview styles with new names) ===== */

    .datausage-distribution-row {
        margin: 0 auto;
        padding: 10px clamp(8px, 3vw, 32px);
        box-sizing: border-box;
    }

    .datausage-distribution-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 22px;
    }

    .datausage-mini-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
        padding: 14px;
        height: 280px;
        box-sizing: border-box;
    }

    .datausage-mini-title {
        text-align: center;
        margin: 0 0 8px 0;
        font-size: 13px;
        font-weight: 480;
        color: #2b2f36;
    }

    .datausage-mini-inner {
        margin-top: 30px;
        background: #fbfbfb;
        border-radius: 12px;
        height: 150px;
        overflow: hidden;
        position: relative;
    }

    .datausage-mini-plot {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
    }

    .datausage-mini-legend {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 6px 2px 6px;
        gap: 10px;
    }

    /* legend-item & legend-swatch can stay shared with overview */
    .legend-item {
        display: inline-flex;
        align-items: center;
        font-size: 12px;
        color: #374151;
        white-space: nowrap;
        cursor: pointer;
        user-select: none;
        transition: opacity .15s ease, color .15s ease;
    }

    .legend-item.is-off {
        opacity: .45;
        text-decoration: line-through;
    }

    .legend-swatch {
        width: 12px;
        height: 12px;
        margin-right: 6px;
        background: #353c44;
        flex: 0 0 auto;
    }

    @media screen and (max-width: 768px) {
        .datausage-distribution-grid {
            grid-template-columns: 1fr;
        }
    }
</style>


<style>
    .home-datausage-wrap {
        padding-top: 4px;
    }

    /* ====== SUMMARY ROW ====== */

    .home-datausage-summary-section {
        padding: 25px 40px 10px 40px;
    }

    .home-datausage-summary-title {
        margin: 0 0 6px 0;
        font-size: 14px;
        font-weight: 600;
        color: #4b5563;
    }

    .home-datausage-summary-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(160px, 1fr));
        gap: 20px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        padding: 16px 18px;
        border: 1px solid #f3f4f6;
    }

    .home-datausage-summary-card {
        padding: 4px 6px;
        border-right: 1px solid #e5e7eb;
    }

    .home-datausage-summary-card:last-child {
        border-right: none;
    }

    .home-datausage-summary-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
    }

    .home-datausage-summary-main {
        display: flex;
        align-items: baseline;
        gap: 4px;
        margin-bottom: 6px;
    }

    .home-datausage-summary-value {
        font-size: 22px;
        font-weight: 700;
        color: #111827;
    }

    .home-datausage-summary-unit {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
    }

    .home-datausage-summary-metrics {
        font-size: 11px;
        color: #4b5563;
    }

    .home-datausage-summary-metric {
        display: flex;
        gap: 4px;
        line-height: 1.3;
    }

    .home-datausage-summary-metric-label {
        color: #6b7280;
    }

    .home-datausage-summary-metric-value {
        color: #16a34a;
        font-weight: 500;
    }

    /* ====== GRAPH ROW ====== */

    .home-datausage-graph-grid {
        display: grid;
        grid-gap: 20px;
        grid-template-columns: repeat(2, 1fr);
        margin: 0 auto;
        padding: 10px 40px 10px 40px;
    }

    .home-datausage-card {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        text-align: center;
    }

    .home-datausage-card h4 {
        margin-top: 0;
        font-size: 14px;
        margin-bottom: 0.4rem;
        color: #777;
        text-align: left;
    }

    .home-datausage-chart-container {
        position: relative;
        width: 100%;
        height: 270px;
    }

    .home-datausage-chart-container canvas {
        width: 100% !important;
        height: 270px !important;
    }

    .home-datausage-loading-text {
        font-size: 13px;
        color: #666;
        text-align: center;
        margin-top: 40px;
    }

    @media screen and (max-width: 1280px) {
        .home-datausage-summary-grid {
            grid-template-columns: repeat(2, minmax(180px, 1fr));
        }

        .home-datausage-summary-card {
            border-right: none;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .home-datausage-summary-card:nth-child(3),
        .home-datausage-summary-card:nth-child(4) {
            padding-top: 8px;
        }

        .home-datausage-summary-card:last-child {
            border-bottom: none;
        }
    }

    @media screen and (max-width: 1024px) {
        .home-datausage-graph-grid {
            grid-template-columns: 1fr;
        }
    }

    @media screen and (max-width: 600px) {

        .home-datausage-summary-section,
        .home-datausage-graph-grid {
            padding: 10px 16px;
        }

        .home-datausage-summary-grid {
            grid-template-columns: 1fr;
            padding: 12px 12px;
        }

        .home-datausage-summary-card {
            border-right: none;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .home-datausage-summary-card:last-child {
            border-bottom: none;
        }

        .home-datausage-chart-container canvas {
            height: 220px !important;
        }
    }
</style>