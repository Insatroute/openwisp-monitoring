{# wan_uplink.html - WAN Uplink tab: single summary card + table (abnormal removed) #}

<style>
  /* ======= SUMMARY CARD (LIKE DATA USAGE SUMMARY) ======= */
  .wan-summary-wrap {
    margin: 10px auto 18px;
    font-family: inherit;
  }

  .wan-summary-title {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #4b5563;
  }

  /* header row containing title + export button */
  .wan-summary-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
    gap: 8px;
  }

  /* export button style */
  .wan-export-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background: #ffffff;
    color: #0b63c5;
    cursor: pointer;
    line-height: 1.2;
    box-shadow: 0 1px 2px rgba(15, 23, 42, .04);
  }

  .wan-export-btn:hover { background: #f3f4f6; }
  .wan-export-btn:active {
    background: #e5e7eb;
    box-shadow: 0 0 0 rgba(0,0,0,0);
  }

  .wan-export-btn-icon {
    width: 14px;
    height: 14px;
    display: inline-block;
    border-radius: 3px;
    border: 1px solid currentColor;
    position: relative;
  }

  .wan-export-btn-icon::after {
    content: '';
    position: absolute;
    left: 3px;
    right: 3px;
    bottom: 2px;
    height: 2px;
    background: currentColor;
    border-radius: 999px;
  }

  .wan-export-btn-icon::before {
    content: '';
    position: absolute;
    left: 5px;
    right: 5px;
    top: 3px;
    height: 5px;
    border-left: 2px solid currentColor;
    border-right: 2px solid currentColor;
    border-bottom: 2px solid currentColor;
    transform: translateY(2px);
  }

  .wan-summary-card {
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(15, 23, 42, .08);
    border: 1px solid #f3f4f6;
    padding: 14px 18px;
    display: flex;
    gap: 0;
  }

  .wan-summary-item {
    flex: 1 1 0;
    padding: 4px 18px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .wan-summary-item + .wan-summary-item {
    border-left: 1px solid #e5e7eb;
  }

  .wan-summary-label { font-size: 13px; color: #6b7280; }

  .wan-summary-main {
    display: flex;
    align-items: baseline;
    gap: 6px;
  }

  .wan-summary-value { font-size: 20px; font-weight: 700; color: #111827; }
  .wan-summary-unit { font-size: 12px; color: #9ca3af; }
  .wan-summary-sub  { font-size: 11px; color: #9ca3af; }

  .wan-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    display: inline-block;
    margin-right: 4px;
  }

  .wan-dot-green  { background: #22c55e; }
  .wan-dot-gray   { background: #9ca3af; }
  .wan-dot-silver { background: #d1d5db; }

  @media (max-width: 900px) {
    .wan-summary-card { flex-direction: column; }
    .wan-summary-item + .wan-summary-item {
      border-left: none;
      border-top: 1px solid #e5e7eb;
    }
    .wan-summary-header { align-items: flex-start; flex-direction: column; }
    .wan-export-btn { align-self: flex-start; }
  }

  /* ========= TABLE SHELL ========= */
  .home-wan-table-wrap {
    background: #fff;
    border: 1px solid #e5e7eb;
    box-shadow: 0 6px 18px rgba(15, 23, 42, .06);
    margin: 0 0 0;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
  }

  .home-wan-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 12px;
    min-width: 1100px;
  }

  .home-wan-table thead th {
    text-align: left;
    padding: 10px 12px;
    border-bottom: 1px solid #eef0f3;
    background: #f9fafb;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    color: #6b7280;
    white-space: nowrap;
  }

  .home-wan-table tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
    white-space: nowrap;
  }

  .home-wan-table tbody tr:last-child td { border-bottom: none; }

  .home-wan-status-cell { white-space: nowrap; }
  .home-wan-status-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 999px;
    margin-right: 6px;
    vertical-align: middle;
  }

  .home-wan-status-connected    { background: #22c55e; }
  .home-wan-status-disconnected { background: #9ca3af; }
  .home-wan-status-disabled     { background: #d1d5db; }

  .home-wan-linkish {
    color: #0b63c5;
    font-weight: 600;
    text-decoration: none;
  }
  .home-wan-linkish:hover { text-decoration: underline; }

  .home-wan-muted  { color: #9ca3af; }
  .home-wan-nowrap { white-space: nowrap; }

  .home-wan-empty-row td { text-align: center; }

  /* ========= PAGINATION ========= */
  .home-wan-pagination {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    padding: 8px 4px;
    margin-top: 6px;
  }

  .home-wan-page-btn {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background: #ffffff;
    cursor: pointer;
    font-size: 12px;
  }

  .home-wan-page-btn[disabled] {
    opacity: .5;
    cursor: default;
  }
</style>

{# ====== SINGLE SUMMARY CARD ====== #}
<div class="wan-summary-wrap">
  <div class="wan-summary-header">
    <div class="wan-summary-title">Summary</div>

    <button type="button" id="home-wan-export-btn" class="wan-export-btn">
      <span class="wan-export-btn-icon" aria-hidden="true"></span>
      <span>Download CSV</span>
    </button>
  </div>

  <div class="wan-summary-card">
    <!-- Total -->
    <div class="wan-summary-item">
      <div class="wan-summary-label">Total WAN Uplinks</div>
      <div class="wan-summary-main">
        <span class="wan-summary-value" id="home-wan-total">0</span>
        <span class="wan-summary-unit">links</span>
      </div>
      <div class="wan-summary-sub">All WAN interfaces</div>
    </div>

    <!-- Connected -->
    <div class="wan-summary-item">
      <div class="wan-summary-label">Connected</div>
      <div class="wan-summary-main">
        <span class="wan-dot wan-dot-green"></span>
        <span class="wan-summary-value" id="home-wan-connected">0</span>
      </div>
      <div class="wan-summary-sub">Currently online</div>
    </div>

    <!-- Disconnected + Disabled -->
    <div class="wan-summary-item">
      <div class="wan-summary-label">Disconnected</div>
      <div class="wan-summary-main">
        <span class="wan-dot wan-dot-gray"></span>
        <span class="wan-summary-value" id="home-wan-disconnected">0</span>
      </div>
      <div class="wan-summary-sub">
        <span class="wan-dot wan-dot-silver"></span>
        Disabled:
        <span id="home-wan-disabled">0</span>
      </div>
    </div>
  </div>
</div>

{# ========= TABLE ========= #}
<div class="home-wan-table-wrap">
  <table class="home-wan-table">
    <thead>
      <tr>
        <th>Status</th>
        <th>Hostname</th>
        <th>Serial Number</th>
        <th>Model</th>
        <th>Location</th>
        <th>Uplink</th>
        <th>Interface IP/Mask</th>
        <th>Ping Destination</th>
        <th>Latency</th>
        <th>Jitter</th>
        <th>Loss</th>
      </tr>
    </thead>
    <tbody id="home-wan-tbody">
      <tr class="home-wan-empty-row" data-empty="1">
        <td colspan="14" class="home-wan-nowrap home-wan-muted">Loading WAN uplink data...</td>
      </tr>
    </tbody>
  </table>
</div>

{# ========= PAGINATION CONTROLS ========= #}
<div id="home-wan-pagination" class="home-wan-pagination" style="display:none">
  <button type="button" class="home-wan-page-btn" data-dir="prev">&laquo; Prev</button>
  <span class="home-wan-page-info"></span>
  <button type="button" class="home-wan-page-btn" data-dir="next">Next &raquo;</button>
</div>

<script>
(function () {
  const tbody = document.getElementById('home-wan-tbody');
  if (!tbody) return;

  window.OW_HIDE_CHARTS = true;

  const totalEl        = document.getElementById('home-wan-total');
  const connectedEl    = document.getElementById('home-wan-connected');
  const disconnectedEl = document.getElementById('home-wan-disconnected');
  const disabledEl     = document.getElementById('home-wan-disabled');

  const paginationEl = document.getElementById('home-wan-pagination');
  const pageInfoEl   = paginationEl ? paginationEl.querySelector('.home-wan-page-info') : null;
  const prevBtn      = paginationEl ? paginationEl.querySelector('[data-dir="prev"]') : null;
  const nextBtn      = paginationEl ? paginationEl.querySelector('[data-dir="next"]') : null;

  const exportBtn = document.getElementById('home-wan-export-btn');

  const PAGE_SIZE = 10;
  let allRows = [];
  let currentPage = 1;
  let totalPages = 1;

  function formatBytes(bytes) {
    if (typeof bytes !== 'number' || isNaN(bytes) || bytes < 0) return '—';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let i = 0;
    let val = bytes;
    while (val >= 1024 && i < units.length - 1) {
      val /= 1024;
      i++;
    }
    return val.toFixed(2) + ' ' + units[i];
  }

  // Abnormal removed: treat unknown statuses as "disconnected"
  function normalizeStatus(status) {
    const s = String(status || '').toLowerCase();
    if (s === 'connected' || s === 'disabled' || s === 'disconnected') return s;
    // API may send "abnormal"/"degraded"/etc -> treat as disconnected
    return 'disconnected';
  }

  function humanizeStatus(status) {
    const s = normalizeStatus(status);
    if (s === 'connected') return 'Connected';
    if (s === 'disabled') return 'Disabled';
    return 'Disconnected';
  }

  function renderSummaryFromApi(summary) {
    let total = 0, connected = 0, disconnected = 0, disabled = 0;

    if (summary) {
      if (typeof summary.total === 'number') total = summary.total;
      if (typeof summary.connected === 'number') connected = summary.connected;

      // abnormal removed -> disconnected should include anything not connected/disabled
      if (typeof summary.disconnected === 'number') disconnected = summary.disconnected;

      // disabled not provided by API summary (as per your comment); compute below from rows
    } else {
      total = allRows.length;
    }

    // Always compute disabled + recompute disconnected safely from rows
    connected = 0; disabled = 0; disconnected = 0;
    allRows.forEach(row => {
      const st = normalizeStatus(row.status);
      if (st === 'connected') connected++;
      else if (st === 'disabled') disabled++;
      else disconnected++;
    });
    total = allRows.length;

    if (totalEl) totalEl.textContent = total;
    if (connectedEl) connectedEl.textContent = connected;
    if (disconnectedEl) disconnectedEl.textContent = disconnected;
    if (disabledEl) disabledEl.textContent = disabled;
  }

  function renderSummaryFromDom() {
    const rows = Array.from(tbody.querySelectorAll('tr'));
    let total = 0, connected = 0, disconnected = 0, disabled = 0;

    rows.forEach(row => {
      if (row.dataset.empty === '1') return;
      total++;
      const st = normalizeStatus(row.dataset.status);
      if (st === 'connected') connected++;
      else if (st === 'disabled') disabled++;
      else disconnected++;
    });

    if (totalEl) totalEl.textContent = total;
    if (connectedEl) connectedEl.textContent = connected;
    if (disconnectedEl) disconnectedEl.textContent = disconnected;
    if (disabledEl) disabledEl.textContent = disabled;
  }

  function createRowEl(row) {
    const tr = document.createElement('tr');

    const status = normalizeStatus(row.status);
    const statusLabel = humanizeStatus(status);

    const uplinkName = (row.interface_name || '').toUpperCase() || '—';
    const hostname = row.hostname || '—';
    const serial = row.serial_number || '—';
    const model = row.model || '—';
    const location = row.location || '—';

    let ipMask = '—';
    if (row.interface_ip) {
      ipMask = row.interface_ip;
      if (row.interface_mask !== null && row.interface_mask !== undefined) {
        ipMask += '/' + row.interface_mask;
      }
    }

    const pingDest = row.ping_dest || '—';
    const latency = (typeof row.ping_latency_ms === 'number') ? row.ping_latency_ms.toFixed(1) + ' ms' : '—';
    const jitter  = (typeof row.ping_jitter_ms === 'number') ? row.ping_jitter_ms.toFixed(1) + ' ms' : '—';
    const loss    = (row.ping_packet_loss !== null && row.ping_packet_loss !== undefined && row.ping_packet_loss !== '')
      ? row.ping_packet_loss
      : '—';

    // keep fields for CSV even if not shown in table
    const txRaw = (typeof row.throughput_tx_bytes === 'number') ? row.throughput_tx_bytes
                : ((typeof row.tx_bytes === 'number') ? row.tx_bytes : null);
    const rxRaw = (typeof row.throughput_rx_bytes === 'number') ? row.throughput_rx_bytes
                : ((typeof row.rx_bytes === 'number') ? row.rx_bytes : null);

    tr.dataset.status = status;
    tr.dataset.uplink = uplinkName;

    tr.innerHTML = `
      <td class="home-wan-status-cell">
        <span class="home-wan-status-dot home-wan-status-${status}"></span>
        ${statusLabel}
      </td>
      <td class="home-wan-nowrap">${hostname}</td>
      <td class="home-wan-nowrap">${serial}</td>
      <td class="home-wan-nowrap">${model}</td>
      <td class="home-wan-nowrap">${location}</td>
      <td class="home-wan-nowrap"><a class="home-wan-linkish">${uplinkName}</a></td>
      <td>
        ${ipMask !== '—'
          ? `<div>${ipMask} <span class="home-wan-muted">(IPV4)</span></div>`
          : `<span class="home-wan-muted">—</span>`}
      </td>
      <td class="home-wan-nowrap">${pingDest}</td>
      <td class="home-wan-nowrap">${latency}</td>
      <td class="home-wan-nowrap">${jitter}</td>
      <td class="home-wan-nowrap">${loss}</td>
    `;

    // attach raw bytes for export usage (optional)
    tr._txRaw = txRaw;
    tr._rxRaw = rxRaw;

    return tr;
  }

  function renderPage(page) {
    if (!tbody) return;

    if (!allRows.length) {
      tbody.innerHTML = `
        <tr class="home-wan-empty-row" data-empty="1">
          <td colspan="14" class="home-wan-nowrap home-wan-muted">No WAN uplink data found</td>
        </tr>
      `;
      if (paginationEl) paginationEl.style.display = 'none';
      return;
    }

    totalPages = Math.max(1, Math.ceil(allRows.length / PAGE_SIZE));
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;
    currentPage = page;

    tbody.innerHTML = '';

    const start = (currentPage - 1) * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const pageRows = allRows.slice(start, end);

    pageRows.forEach(row => tbody.appendChild(createRowEl(row)));

    if (paginationEl && allRows.length > PAGE_SIZE) {
      paginationEl.style.display = 'flex';
      if (pageInfoEl) pageInfoEl.textContent = `Page ${currentPage} of ${totalPages}`;
      if (prevBtn) prevBtn.disabled = currentPage === 1;
      if (nextBtn) nextBtn.disabled = currentPage === totalPages;
    } else if (paginationEl) {
      paginationEl.style.display = 'none';
    }
  }

  if (prevBtn) prevBtn.addEventListener('click', () => { if (currentPage > 1) renderPage(currentPage - 1); });
  if (nextBtn) nextBtn.addEventListener('click', () => { if (currentPage < totalPages) renderPage(currentPage + 1); });

  function escapeCsvValue(value) {
    if (value === null || value === undefined) value = '';
    value = String(value);
    const needsQuotes = /[",\r\n]/.test(value);
    return needsQuotes ? '"' + value.replace(/"/g, '""') + '"' : value;
  }

  function exportWanCsv() {
    if (!allRows.length) {
      alert('No WAN uplink data to export yet.');
      return;
    }

    const headers = [
      'Status',
      'Hostname',
      'Serial Number',
      'Model',
      'Location',
      'Uplink',
      'Interface IP/Mask',
      'Ping Destination',
      'Throughput TX',
      'Throughput RX',
      'Latency',
      'Jitter',
      'Loss'
    ];

    const rows = allRows.map(row => {
      const statusLabel = humanizeStatus(row.status);

      const uplinkName = (row.interface_name || '').toUpperCase() || '—';
      const hostname = row.hostname || '—';
      const serial = row.serial_number || '—';
      const model = row.model || '—';
      const location = row.location || '—';

      let ipMask = '—';
      if (row.interface_ip) {
        ipMask = row.interface_ip;
        if (row.interface_mask !== null && row.interface_mask !== undefined) {
          ipMask += '/' + row.interface_mask;
        }
      }

      const pingDest = row.ping_dest || '—';
      const latency = (typeof row.ping_latency_ms === 'number') ? row.ping_latency_ms.toFixed(1) + ' ms' : '—';
      const jitter  = (typeof row.ping_jitter_ms === 'number') ? row.ping_jitter_ms.toFixed(1) + ' ms' : '—';
      const loss    = (row.ping_packet_loss !== null && row.ping_packet_loss !== undefined && row.ping_packet_loss !== '')
        ? row.ping_packet_loss
        : '—';

      const txRaw = (typeof row.throughput_tx_bytes === 'number') ? row.throughput_tx_bytes
                  : ((typeof row.tx_bytes === 'number') ? row.tx_bytes : null);
      const rxRaw = (typeof row.throughput_rx_bytes === 'number') ? row.throughput_rx_bytes
                  : ((typeof row.rx_bytes === 'number') ? row.rx_bytes : null);

      const tx = txRaw !== null ? formatBytes(txRaw) : '—';
      const rx = rxRaw !== null ? formatBytes(rxRaw) : '—';

      return [
        statusLabel,
        hostname,
        serial,
        model,
        location,
        uplinkName,
        ipMask,
        pingDest,
        tx,
        rx,
        latency,
        jitter,
        loss
      ];
    });

    const lines = [];
    lines.push(headers.map(escapeCsvValue).join(','));
    rows.forEach(r => lines.push(r.map(escapeCsvValue).join(',')));

    const csvContent = lines.join('\r\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', 'wan_uplinks.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  if (exportBtn) exportBtn.addEventListener('click', exportWanCsv);

  async function init() {
    const API_BASE = window.location.origin;
    const API_URL = `${API_BASE}/api/v1/monitoring/wan-uplinks/`;

    let json;
    try {
      const fetchOptions = (typeof buildAuthFetchOptions === 'function')
        ? buildAuthFetchOptions(API_URL)
        : { credentials: 'include' };

      const res = await fetch(API_URL, fetchOptions);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      json = await res.json();
    } catch (e) {
      console.error('WAN uplinks API error:', e);
      if (typeof APIResponse !== 'undefined') {
        json = APIResponse;
      } else {
        renderSummaryFromDom();
        return;
      }
    }

    // Share WAN data globally for other tabs
    try {
      window.WAN_UPLINK_DATA = json;
      window.dispatchEvent(new CustomEvent('wanUplinkDataLoaded', { detail: json }));
    } catch (err) {
      console.warn('Unable to broadcast WAN_UPLINK_DATA:', err);
    }

    allRows = Array.isArray(json.rows) ? json.rows : [];
    renderSummaryFromApi(json.summary || null);
    renderPage(1);
  }

  init();
})();
</script>
