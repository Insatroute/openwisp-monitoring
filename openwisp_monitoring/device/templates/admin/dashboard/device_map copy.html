{% load leaflet_tags i18n %}
{% load i18n %}
{% load static %}
<script type="text/javascript">
  window._owGeoMapConfig = {
    geoJsonUrl: '{{ monitoring_location_geojson_url }}',
    locationDeviceUrl: '{{ monitoring_device_list_url }}?page_size=5'
  }
</script>

<!-- Chart.js v3+ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script type="text/javascript" src={%static 'monitoring/js/lib/netjsongraph.min.js' %}></script>
<script type="text/javascript" src={%static 'monitoring/js/lib/leaflet.fullscreen.min.js' %}></script>




<div id='leaflet-config'>
  {% autoescape on %}{% leaflet_json_config %}{% endautoescape %}
</div>


<div class="map-view">
  <div id="device-map-container">
  <div class="no-data">
    <p>{% trans 'No map data to show' %}.</p>
    <p><a class="button submit" href="#close">Close</a></p>
  </div>
  <div class="ow-loading-spinner"></div>
</div>
</div>


  <div class="card-grid">
    
      <div class="card data-card networks">
      <h4>
        <span>Total/Online/Offline</span>
        <button class="network-button device-btn">DEVICES</button>
      </h4>
      <div class="network-body">
        <span class="globe-icon">&#127760;</span>
       <span><span id="total-devices">Loading...</span> / <span id="monitoring-ok">Loading...</span> / <span id="monitoring-critical">Loading...</span></span>
      </div>
    </div>
      <div class="card data-card networks">
      <h4>
        <span>Total/Active/Pending</span>
        <button class="network-button tunnel-btn">TUNNELS</button>
      </h4>
      <div class="network-body">
        <span class="globe-icon">&#127760;</span>
        <span class="network-stats"><span id="spoke-total">Loading...</span> / <span id="spoke-active">Loading...</span> / <span id="spoke-pending">Loading...</span></span>
      </div>
    </div>
      <div class="card data-card networks">
      <h4>
        <button class="network-button link-btn">TOTAL LINKS</button>
      </h4>
      <div class="network-body">
        <span class="globe-icon">&#127760;</span>
        <span class="network-stats">10</span>
      </div>
    </div>
    <div class="card data-card networks">
      <h4>
        <button class="network-button activelink-btn">ACTIVE LINKS</button>
      </h4>
      <div class="network-body">
        <span class="globe-icon">&#127760;</span>
        <span class="network-stats">10</span>
      </div>
    </div>
  </div>

<div class="card-grid graph-grid">
    <div class="card-app top-apps">
      <h4>
        <span>Top Applications</span>
        
      </h4>
      <div class="chart-container">
          <div id="chart-loading" class="loading-text">Loading…/ No Data</div>
        <canvas id="topAppsChart"></canvas>
      </div>
    </div>
  </div>



  {% leaflet_js %}

<script>
  let cachedToken = sessionStorage.getItem('cachedToken') || '80ee082483ee2a41d520909e571a3970f06d5907'; // Use fallback token
Chart.register(ChartDataLabels);

  async function fetchAuthToken() {
    if (cachedToken) return cachedToken;
    // try {
    //   const response = await fetch('https://3.6.121.36/api/v1/users/token/', {
    //     method: 'POST',
    //     headers: {
    //       'Content-Type': 'application/x-www-form-urlencoded'
    //     },
    //     body: new URLSearchParams({
    //       'username': 'admin',
    //       'password': 'Nexapp@123'
    //     }),
    //     mode: 'cors'
    //   });

    //   if (!response.ok) throw new Error(`HTTP ${response.status}`);

    //   const data = await response.json();
    //   cachedToken = data.token;
    //   sessionStorage.setItem('cachedToken', cachedToken);
    //   return cachedToken;
    // } catch (error) {
    //   console.error('Token fetch failed:', error);
    //   return null;
    // }
  }

  async function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

async function fetchDeviceData() {
  const token = await fetchAuthToken();
  if (!token) {
    document.getElementById('total-devices').innerText = 'Auth error';
    document.getElementById('monitoring-ok').innerText = 'Auth error';
    document.getElementById('monitoring-critical').innerText = 'Auth error';
    return;
  }

  try {
    const response = await fetch('https://3.6.121.36/api/v1/monitoring/device', {
      headers: {
        'Accept': 'application/json',
        'Authorization': `Token ${token}`
      }
    });
    const data = await response.json();

    // Update total devices count
    const totalDevices = data.count ?? (Array.isArray(data.results) ? data.results.length : 0);
    document.getElementById('total-devices').innerText = totalDevices;

    // Count statuses
    let okStatusCount = 0;
    let criticalStatusCount = 0;
    const devices = data.results || [];
    devices.forEach(device => {
      const status = device.monitoring?.status;
      if (status === 'ok') {
        okStatusCount++;
      } else if (status === 'critical') {
        criticalStatusCount++;
      }
    });

    document.getElementById('monitoring-ok').innerText = okStatusCount;
    document.getElementById('monitoring-critical').innerText = criticalStatusCount;

  } catch (error) {
    console.error('Error fetching device data:', error);
    document.getElementById('total-devices').innerText = 'Error';
    document.getElementById('monitoring-ok').innerText = 'Error';
    document.getElementById('monitoring-critical').innerText = 'Error';
  }
}




async function fetchSpokeData() {
  // Cache your DOM elements and guard against missing IDs
  const elems = {
    total:   document.getElementById('spoke-total'),
    active:  document.getElementById('spoke-active'),
    pending: document.getElementById('spoke-pending'),
   
 
  };
  if (Object.values(elems).some(el => !el)) {
    console.error('One or more spoke DOM elements not found.');
    return;
  }

  // Show loading state
  Object.values(elems).forEach(el => el.innerText = 'Loading…');

  // 1️⃣ Fetch auth token
  let token;
  try {
    token = await fetchAuthToken();
  } catch (e) {
    console.error('Token fetch failed', e);
  }
  if (!token) {
    Object.values(elems).forEach(el => el.innerText = 'Auth error');
    return;
  }

  // 2️⃣ Fetch spoke data
  let json;
  try {
    const resp = await fetch('https://3.6.121.36/api/v1/spoke/', {
      headers: {
        'Accept': 'application/json',
        'Authorization': `Token ${token}`
      }
    });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    json = await resp.json();
  } catch (err) {
    console.error('Error fetching spoke data:', err);
    Object.values(elems).forEach(el => el.innerText = 'Error');
    return;
  }

  // 3️⃣ Count statuses
  const items = Array.isArray(json) ? json : [];
  const counts = items.reduce((acc, { status }) => {
    const st = status || 'error';  // treat missing/unknown as "error" if you like
    acc[st] = (acc[st] || 0) + 1;
    return acc;
  }, {});

  // 4️⃣ Update UI
  const result = {
    active:  counts.active  || 0,
    pending: counts.pending || 0,
    error:   counts.error   || 0,
  };
  result.total = Object.values(result).reduce((sum, v) => sum + v, 0);

  elems.total.innerText   = result.total;
  elems.active.innerText  = result.active;
  elems.pending.innerText = result.pending;
}






async function fetchAndDisplayTopAppsChart() {
  // 1. Retrieve an authentication token
  const token = await fetchAuthToken();
  const loadingEl = document.getElementById('chart-loading');
  const canvas = document.getElementById('topAppsChart');

  loadingEl.style.display = 'block';
  canvas.style.display = 'none';

  if (!token) {
    // Display auth error message
    const chartContainer = document.getElementById('top-apps-chart-container');
    if (chartContainer) {
      chartContainer.innerText = 'Auth error';
    }
    return;
  }

    try {
      // 2. Fetch the list of devices (UUIDs)
      const response = await fetch('https://3.6.121.36/api/v1/controller/device/', {
        headers: {
          'accept': 'application/json',
          'Authorization': `Token ${token}`
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status} – ${response.statusText}`);
      }

      const data = await response.json();
      const uuids = data.results.map(device => device.id);

      // 3. Aggregate "top_apps" values across all devices
      const aggregated = new Map();

      for (const uuid of uuids) {
        try {
          const res = await fetch(`https://3.6.121.36/api/v1/monitoring/device/${uuid}/real_traffic/`, {
            headers: {
              'accept': 'application/json',
              'Authorization': `Token ${token}`
            }
          });

          if (!res.ok) {
            console.warn(`Warning: real_traffic for ${uuid} returned ${res.status} ${res.statusText}`);
            continue;
          }

          const rtData = await res.json();
          const topApps = rtData.latest_raw?.talkers?.top_apps || [];

          topApps.forEach(entry => {
            const name = entry.name;
            const value = Number(entry.value) || 0;
            aggregated.set(name, (aggregated.get(name) || 0) + value);
          });
  
          // Delay between requests to avoid rate limiting
        
      loadingEl.remove();
      canvas.style.display = '';
        } catch (err) {
          console.warn(`Failed fetching real_traffic for device ${uuid}: ${err.message}`);
        }
      }

      // 4. Sort aggregated data and take top 5
      const sorted = Array.from(aggregated.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      // 5. Prepare data arrays for Chart.js
  const labels = sorted.map(item => {
    // take only the bit after the last “.”
    const fullName = item[0];
    return fullName.split('.').pop();
  });

// convert KB → MB (assuming your incoming values are KB)
const valuesMB = sorted.map(item => {
  const kb = item[1];
  return +(kb / 1024).toFixed(1);     // e.g. 77010 KB → 75.2 MB
});

const maxMB = Math.max(...valuesMB);
    // 6. Render horizontal bar chart using Chart.js
    // Ensure your HTML includes:
    // <div id="top-apps-chart-container">
    //   <canvas id="topAppsChart"></canvas>
    // </div>

    // Hide any loading text inside the container
    const chartContainer = document.getElementById('top-apps-chart-container');
    if (chartContainer) {
      const loadingElem = chartContainer.querySelector('.loading-text');
      if (loadingElem) loadingElem.style.display = 'none';
    }

    // Destroy existing chart instance if it exists
    const existingChart = Chart.getChart('topAppsChart');
    if (existingChart) {
      existingChart.destroy();
    }

    const ctx = document.getElementById('topAppsChart').getContext('2d');
new Chart(ctx, {
  type: 'bar',
  data: {
    labels,
    datasets: [
    
      {
        // colored value bars in MB
        data: valuesMB,
        backgroundColor: '#00acea',
        borderRadius: 10,
         barPercentage: 0.5,
      categoryPercentage: 0.5,
    barThickness: 8,
        stack: 'stack0',
        order: 2
      }
    ]
  },
  options: {
    indexAxis: 'y',
    scales: {
      x: {
        stacked: true,
        beginAtZero: true,
        title: {
          display: true,
          text: 'Total (MB)',
            font: { size: 10, weight: '500' } 
        },
        // turn your tick labels into “XX MB”
        ticks: {
          callback: val => `${val} MB`
        },
        grid: { display: false }
      },
      y: {
        stacked: true,
        grid: { display: false },
        ticks: {
          font: { size: 12, weight: '500' }
        }
      }
    },
    plugins: {
      legend: { display: false },
      title: {
        display: false,
        text: 'Top 5 Applications (Aggregated)'
      },
      tooltip: {
        callbacks: {
          label: ctx => ` ${ctx.parsed.x} MB`
        }
      },
      datalabels: {
        anchor: 'end',
        align: 'end',
         offset: 6,
        formatter: val => `${val} MB`,
        font: { weight: '500', size: 10 }
      }
    },
    responsive: true,
    maintainAspectRatio: false
  }
});
  } catch (error) {
    console.error('Error fetching top_apps:', error);
    const chartContainer = document.getElementById('top-apps-chart-container');
    if (chartContainer) chartContainer.innerText = 'Error loading top apps';
  }
}


fetchAndDisplayTopAppsChart();
fetchDeviceData();


document.addEventListener('DOMContentLoaded', () => {
  fetchSpokeData();
  setTimeout(() => map.invalidateSize(), 200);

  
});
  // Fetch device data every 30 seconds
  setInterval(() => {
    fetchDeviceData();

  }, 30000);

  // Fetch top apps chart every 30 seconds
  setInterval(fetchAndDisplayTopAppsChart, 30000);

 </script>

{% leaflet_css %}

<style>
  @media screen and (min-width: 1380px) and (max-width: 1500px) {
    .svg-container{
    width: 360px !important;
}
.toggle-menu #plot-container {

   
}
 
}

@media screen and (min-width: 1280px) and (max-width: 1379px) {
.svg-container{
          background-color: #ffffff !important;
    width: 337px !important;
}

.data-card{
  width: 85% ;
}
.card{
    width: 85% !important;

}

}


  #plot-container .system-type{
    display: none !important;
  }
   #plot-container .currently-active-wifi-sessions{
    display: none !important;
  }
  #plot-container {
    padding: 0.325rem 1.2rem !important;
    overflow-x: unset !important;
}
  
  .content{
        background-color: #d3d3d30f !important;
  }


    .card-grid {
      display: grid;
      grid-gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      max-width: 1800px;
      margin: 0 auto;
      padding: 25px 25px 25px 25px;
    }

  
    .card {
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem 1rem 1rem 2rem;
      text-align: center;
      width: 90%;
    }
    #map {
  width: 90% !important;
  height: 300px !important;    /* or whatever fits your layout */
}

      
    .card-app {
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem 1rem 1rem 2rem;
      text-align: center;
      width: 96%;
    }
    .data-card{
      width: 90% ;
    }

    .card-app h4 {
      margin-top: 0px;
      font-size: 1rem;
      margin-bottom: 1.5rem;
      color: #777;
      text-align: left;
    }

    .card-app p {
      font-size: 1.25rem;
      font-weight: bold;
      color: #555;
    }

    .card-app h4,
    .card-app p {
      word-wrap: break-word;
    }

      .card-app h4 {
      margin-top: 0px;
      font-size: 1rem;
      margin-bottom: 1.5rem;
      color: #777;
      text-align: left;
    }

    .card-app p {
      font-size: 1.25rem;
      font-weight: bold;
      color: #555;
    }

    .card-app h4,
    .card-app p {
      word-wrap: break-word;
    }


    /* 5) Networks card specific styling */
    .card.networks {
      text-align: left;
      padding: 1rem 1rem;
    }
    .card.networks h4 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }
    .network-button {
      
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      cursor: pointer;
      float: right;
    }
    .network-button:hover {
      background-color: #0056b3;
    }
    .network-body {
      display: flex;
      align-items: center;
      font-size: 1.25rem;
      color: #333;
      font-weight: 500;

    }
    .globe-icon {
      font-size: 1.5rem;
      margin-right: 0.5rem;
    }
    .network-stats {
      font-weight: 500;
    }
  .device-btn{
      background-color: #4a555f;
    }
    .tunnel-btn{
      background-color: #4a555f;
    }
    .link-btn{
      background-color: #4a555f;
    }
    .activelink-btn{
      background-color: #4a555f;
    }
    .chart-container canvas {
    
      width: 100% !important;
     height: 150px !important;
      
    }

    .card.devices { border-top: 4px solid #353b44; }
    .card.tunnels { border-top: 4px solid #353b44; }
    .card.total-links { border-top: 4px solid #353b44; }
    .card.link-active { border-top: 4px solid #353b44; }



     .toggle-menu .svg-container {
    width: 382px !important;
}


.toggle-menu #plot-container {

    margin-left: 0px;
}
   #content-main > div:not(.app-sdwan_tunnel) {
  display: none;
}

.percircle-container {
    margin-top: 50px;
}
.map-view{
  padding: 25px 40px 25px 40px;
}
#device-map-container{
  margin: 0 auto !important;
  width: 100% !important;
}
.graph-grid .card{
height: 230px !important;
}
#topAppsChart {
  height: 170px !important;
}
</style>