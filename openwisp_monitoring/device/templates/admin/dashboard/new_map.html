{% load leaflet_tags i18n %}
{% load i18n %}
{% load static %}
<script type="text/javascript">
    window._owGeoMapConfig = {
        geoJsonUrl: '{{ monitoring_location_geojson_url }}',
        locationDeviceUrl: '{{ monitoring_device_list_url }}?page_size=5'
    }
</script>

<div id='leaflet-config'>
    {% autoescape on %}{% leaflet_json_config %}{% endautoescape %}
</div>

<div class="map-view">
    <div id="device-map-container">
        <div class="no-data">
            <p>{% trans 'No map data to show' %}.</p>
            <p><a class="button submit" href="#close">Close</a></p>
        </div>
        <div class="ow-loading-spinner"></div>
    </div>
</div>

{% leaflet_js %}
{% leaflet_css %}

<style>
    /* Make the map wrapper fill the content area */
    .map-view {
        padding: 0px 40px 10px 40px;
        margin: 0 auto;
    }

    /* Main map container (card) */
    #device-map-container {
        width: 100%;
        height: 480px;
        /* adjust if you want taller/shorter */
        position: relative;
    }

    /* Ensure Leaflet canvas fills the container */
    #device-map-container .leaflet-container {
        width: 100% !important;
        height: 100% !important;
    }

    /* Optional: remove any min-width constraints from Leaflet */
    .leaflet-container {
        max-width: 100% !important;
    }
</style>

<script>
        (function () {
            // Helper: safely invalidate Leaflet map size
            function resizeLeafletMap() {
                if (window.map && typeof window.map.invalidateSize === 'function') {
                    window.map.invalidateSize();
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                // If Map tab happens to be active on initial load, fix size once
                var mapPane = document.getElementById('home-pane-map');
                if (mapPane && mapPane.classList.contains('home-active')) {
                    setTimeout(resizeLeafletMap, 200);
                }

                // When user clicks on the "Map" tab, fix the size after it becomes visible
                var mapTabBtn = document.getElementById('home-tab-map');
                if (mapTabBtn) {
                    mapTabBtn.addEventListener('click', function () {
                        // small delay so CSS display:block has applied
                        setTimeout(resizeLeafletMap, 200);
                    });
                }

                // Also keep it correct on window resize
                window.addEventListener('resize', function () {
                    setTimeout(resizeLeafletMap, 150);
                });
            });
        })();
</script>