<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <style>
      .form-container {
        margin-top: 30px;
        padding-left: 20px;
        font-size: 12px !important;
      }
      .form-row {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
      }
      .form-row label {
        width: 120px;
        font-weight: bold;
      }
      .form-row input[type="text"],
      .form-row select {
        flex: 1;
        height: 28px;

        padding: 0px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .form-actions {
        text-align: right;
      }
      .form-actions button {
        padding: 8px 16px;
        border: none;
        background: #007bff;
        color: white;
        border-radius: 4px;
        cursor: pointer;
      }
      .form-actions button:hover {
        background: #0056b3;
      }
      .form-row {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        border-bottom: 0px;
      }
      .form-row label {
        width: 120px;
        font-weight: bold;
      }
      /* container for switch + text */
      .ruletoggle-container {
        display: flex;
        align-items: center;
      }
      /* hidden checkbox */
      .ruletoggle-container input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }
      /* the track */
      .ruletoggle1-switch {
        position: relative;
        width: 50px !important;
        height: 24px;
        background: #ccc;
        border-radius: 12px;
        transition: background 0.2s;
        cursor: pointer;
      }
      /* the knob */
      .ruletoggle1-switch::before {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: transform 0.2s;
      }
      /* when checked */
      .ruletoggle-container input:checked + .ruletoggle1-switch {
        background: #007bff;
      }
      .ruletoggle-container input:checked + .ruletoggle1-switch::before {
        transform: translateX(26px);
      }
      /* the text */
      .ruletoggle-text {
        margin-left: 8px;
        font-size: 12px;
        user-select: none;
        color: #333;
      }

      /* disabled style */
      .ruletoggle-container input:disabled + .ruletoggle1-switch {
        background: #eee;
        cursor: not-allowed;
      }
      .ruletoggle-container input:disabled + .ruletoggle1-switch::before {
        background: #ddd;
      }
      .ruletoggle-container input:disabled ~ .ruletoggle-text {
        color: #999;
      }
      .multiselect-wrapper {
        flex: 1;
      }
      /* basic select styling */
      .multiselect-wrapper select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        /* keep it from showing too tall */
        max-height: 150px;
        overflow-y: auto;
      }
      /* tags container */
      .selected-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }
      .selected-tags .tag {
        background: #e0f3ff;
        color: #0366d6;
        border-radius: 12px;
        padding: 4px 8px;
        font-size: 13px;
        display: flex;
        align-items: center;
      }
      .selected-tags .tag .remove {
        display: inline-block;
        margin-left: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      #ruleRow #rulelabel,
      #rulesourceRow #rulesourcelabel,
      #ruleprotocolRow #ruleprotocollabel,
      #ruleportRow #ruleportlabel,
      #rulemodeRow #rulemodelabel,
      #ruleserviceRow #ruleservicelabel,
      #ruleinterfaceRow #ruleinterfacelabel,
      #ruledestinationRow #ruledestinationlabel {
        font-size: 13px !important;
      }
      #ruleinterfaceRow #cntrolinfo {
        font-size: 10px !important;
      }

      .ruletoggle1-switch {
        width: 40px !important;
        height: 20px;
        border-radius: 10px;
      }

      .ruletoggle1-switch::before {
        width: 16px;
        height: 16px;
        top: 2px;
        left: 2px;
      }

      .ruletoggle-container input:checked + .ruletoggle1-switch::before {
        transform: translateX(20px);
      }

      .cidrformat {
  display: none;
  color: #f02323;
  font-size: 8px;
  margin-top: 4px;
}

/* show helper only after user types something invalid */
#rulesourcename:invalid:not(:placeholder-shown) + .cidrformat { display: block; }
#ruledestinationname:invalid:not(:placeholder-shown) + .cidrformat { display: block; }
    </style>
  </head>
  <body>
  
    <div class="toolbar" style="margin-top: 20px ; margin-bottom: 30px; ">
      <button
        type="button"
        class="btn btn-secondary"
        data-bs-toggle="modal"
        data-bs-target="#ruleModal"
      >
        Add Rule
      </button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Source</th>
          <th>Destination</th>
          <th>Protocol</th>
          <th>Port</th>
          <th>Outgoing Mode</th>
          <th>Interface</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="rulesTableBody">
        <!-- Dynamically populated list of rules… -->
        <tr>
          <td colspan="7" style="text-align: center">No rules yet</td>
        </tr>
      </tbody>
    </table>
    <!--   
        <div class="form-container">
            <form id="ruleForm" action="#" method="post"></form>
            <div class="form-row" id="ruleserviceRow">
              <label id="ruleservicelabel" for="ruleservice">Service:</label>

              <div class="ruletoggle-container">
                <input type="checkbox" id="ruleservice" name="service" />
                <label class="ruletoggle1-switch" for="ruleservice"></label>
                <span class="ruletoggle-text">Enable</span>
              </div>
            </div>

            <div class="form-row" id="ruleRow">
              <label id="rulelabel" for="rulename"> Name :</label>
              <input type="text" id="rulename" name="rulename" />
            </div>
            <div class="form-row" id="rulesourceRow">
              <label id="rulesourcelabel" for="rulesourcename">Source :</label>
              <input type="text" id="rulesourcename" name="rulesourcename" />
            </div>
            <div class="form-row" id="ruledestinationRow">
              <label id="ruledestinationlabel" for="ruledestinationname"
                >Destination :</label
              >
              <input
                type="text"
                id="ruledestinationname"
                name="ruledestinationname"
              />
            </div>
            <div class="form-row" id="ruleprotocolRow">
              <label id="ruleprotocollabel" for="ruleprotocolname"
                >Protocol :</label
              >
              <select id="ruleprotocolname" name="ruleprotocolname">
                <option value="tcp">TCP</option>
                <option value="udp">UDP</option>
                <option value="all">All</option>
              </select>
            </div>
            <div class="form-row" id="ruleportRow">
              <label id="ruleportlabel" for="ruleportname">Port :</label>
              <input type="text" id="ruleportname" name="ruleportname" />
            </div>
            <div class="form-row" id="rulemodeRow">
              <label id="rulemodelabel" for="rulemodename">Outing Mode :</label>
              <select id="rulemodename" name="rulemodename">
                <option value="" selected>select</option>
                <option value="manual">Manual</option>
                <option value="quality">Quality (qua)</option>
                <option value="lowest cost">Lowest Cost</option>
                <option value="max bandwidth">Max Bandwidth</option>
              </select>
            </div>

            <div class="form-row" id="ruleinterfaceRow">
              <label id="ruleinterfacelabel" for="ruleinterface"
                >Outgoing Interface:</label
              >
              <select id="ruleinterface" name="ruleinterface">
                <option value="" disabled selected>Loading…</option>
              </select>
            </div>

            <div class="form-actions">
              <button type="button" id="cancelBtn">Cancel</button>

              <button type="button" id="rulesaveBtn">Save</button>
            </div>
          </form>
        </div>
      -->

    <div
      class="modal fade"
      id="ruleModal"
      tabindex="-1"
      aria-labelledby="ruleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <!-- header -->
          <div class="modal-header">
            <h5 class="modal-title" id="ruleModalLabel">Add Rule</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <!-- body: your existing form goes here -->
          <div class="modal-body">
            <div class="form-container">
              <form id="ruleForm" action="#" method="post">
                <!-- Service toggle -->
                <div class="form-row" id="ruleserviceRow">
                  <label id="ruleservicelabel" for="ruleservice"
                    >Service:</label
                  >
                  <div class="ruletoggle-container">
                    <input type="checkbox" id="ruleservice" name="service" />
                    <label class="ruletoggle1-switch" for="ruleservice"></label>
                    <span class="ruletoggle-text">Enable</span>
                  </div>
                </div>

                <!-- Name -->
                <div class="form-row" id="ruleRow">
                  <label id="rulelabel" for="rulename">Name:</label>
                  <input type="text" id="rulename" name="rulename" />
                </div>

                <!-- Source -->
                <div class="form-row" id="rulesourceRow">
                  <label id="rulesourcelabel" for="rulesourcename"
                    >Source:</label
                  >
                  <input
    type="text"
    id="rulesourcename"
    name="rulesourcename"
    placeholder="e.g. 0.0.0.0/0"
    inputmode="decimal"
    required
    title="IPv4 CIDR only, e.g. 192.168.1.0/24"
    pattern="^(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\/(?:[0-9]|[12]\d|3[0-2])$"
  />
  <div class="cidrformat">IPv4 CIDR only, e.g. 192.168.1.0/24</div>
                </div>

                <!-- Destination -->
                <div class="form-row" id="ruledestinationRow">
                  <label id="ruledestinationlabel" for="ruledestinationname"
                    >Destination:</label
                  >
                  <input
    type="text"
    id="ruledestinationname"
    name="ruledestinationname"
    placeholder="e.g. 0.0.0.0/0"
    inputmode="decimal"
    required
    title="IPv4 CIDR only, e.g. 10.0.0.0/8"
    pattern="^(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\/(?:[0-9]|[12]\d|3[0-2])$"
  />
  <div class="cidrformat">IPv4 CIDR only, e.g. 10.0.0.0/8</div>
                </div>

                <!-- Protocol -->
                <div class="form-row" id="ruleprotocolRow">
                  <label id="ruleprotocollabel" for="ruleprotocolname"
                    >Protocol:</label
                  >
                  <select id="ruleprotocolname" name="ruleprotocolname">
                    <option value="tcp">TCP</option>
                    <option value="udp">UDP</option>
                    <option value="all">All</option>
                  </select>
                </div>

                <!-- Port -->
                <div class="form-row" id="ruleportRow">
                  <label id="ruleportlabel" for="ruleportname">Port:</label>
                  <input type="number" id="ruleportname" name="ruleportname" />
                </div>

                <!-- Mode -->
                <div class="form-row" id="rulemodeRow">
                  <label id="rulemodelabel" for="rulemodename"
                    >Outing Mode:</label
                  >
                  <select id="rulemodename" name="rulemodename">
                    <option value="" selected>select</option>
                    <option value="manual">Manual</option>
                    <option value="quality">Quality (qua)</option>
                    <option value="lowest cost">Lowest Cost</option>
                    <option value="max bandwidth">Max Bandwidth</option>
                  </select>
                </div>

                <!-- Interface -->
                <div class="form-row" id="ruleinterfaceRow">
                  <label id="ruleinterfacelabel" for="ruleinterface"
                    >Outgoing Interface:</label
                  >
                  <select id="ruleinterface" name="ruleinterface">
                    <option value="" disabled selected>Loading…</option>
                  </select>
                </div>
              </form>
            </div>
          </div>

          <!-- footer: move your buttons here -->
          <div class="modal-footer">
            <!-- keep your IDs but add Bootstrap classes and dismissal -->
            <button
              type="button"
              id="cancelBtn"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" id="rulesaveBtn" class="btn btn-primary">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      // modal-----------

      // modal --------

      document.addEventListener("DOMContentLoaded", async () => {
        

        // grab all your elements
        const serviceToggle = document.getElementById("ruleservice");
        const toggleText = document.querySelector(".ruletoggle-text");
        const rulesaveBtn = document.getElementById("rulesaveBtn");
        const nameInput = document.getElementById("rulename");
        const sourceInput = document.getElementById("rulesourcename");
        const destInput = document.getElementById("ruledestinationname");
        const protocolSelect = document.getElementById("ruleprotocolname");
        const portInput = document.getElementById("ruleportname");
        const modeSelect = document.getElementById("rulemodename");
        const interfaceSelect = document.getElementById("ruleinterface");
        const ruleInterfaceRow = document.getElementById("ruleinterfaceRow");
        // keep enable/disable label in sync
        toggleText.textContent = serviceToggle.checked ? "Enable" : "Disable";
        serviceToggle.addEventListener("change", () => {
          toggleText.textContent = serviceToggle.checked ? "Enable" : "Disable";
        });

        function syncInterfaceRow() {
          ruleInterfaceRow.style.display =
            modeSelect.value === "manual" ? "flex" : "none";
        }

        function syncRows() {
          const show = serviceToggle.checked;
          ruleRow.style.display = show ? "flex" : "none";
          rulesourceRow.style.display = show ? "flex" : "none";
          ruleprotocolRow.style.display = show ? "flex" : "none";
          ruleportRow.style.display = show ? "flex" : "none";
          rulemodeRow.style.display = show ? "flex" : "none";
          ruleinterfaceRow.style.display = show ? "flex" : "none";
          ruledestinationRow.style.display = show ? "flex" : "none";
        }

        // initial setup
        syncRows();
        // initial setup
        syncInterfaceRow();

        // whenever the mode changes, re‐sync
        modeSelect.addEventListener("change", syncInterfaceRow);
        // whenever the toggle flips
        serviceToggle.addEventListener("change", syncRows);
const addBtn = document.querySelector('[data-bs-target="#ruleModal"]');
if (addBtn) {
  addBtn.addEventListener("click", () => {
    editingRule = null;                          // we're adding, not editing
    nameInput.disabled = false;                  // make it editable
    document.getElementById("ruleModalLabel").textContent = "Add Rule";
    document.getElementById("ruleForm").reset(); // optional
  });
}
        // ---------------------
        const CONTROLLER_API_URL =
          "https://3.6.121.36/api/v1/controller/device/";

        const AUTH_TOKEN =
          sessionStorage.getItem("cachedToken") ||
          "709a479602b572990248897cdf754a8dbc8411d5";

        // Extract deviceId from URL
        const match = window.location.pathname.match(
          /device\/([0-9a-fA-F\-]+)(?:\/|$)/
        );
        if (!match) {
          console.error("Cannot find device ID in URL");
          return;
        }
        const deviceId = match[1];

        // Fetch last_ip for this device
        async function rulefetchLastIpByDeviceId(id) {
          try {
            const res = await fetch(CONTROLLER_API_URL, {
              method: "GET",
              headers: {
                Accept: "application/json",
                Authorization: `Bearer ${AUTH_TOKEN}`,
              },
              credentials: "include",
            });
            if (!res.ok) {
              console.error(`Controller API HTTP ${res.status}`);
              return null;
            }
            const json = await res.json();
            const dev = (json.results || []).find((d) => d.id === id);
            return dev ? dev.last_ip : null;
          } catch (e) {
            console.error("Error fetching device list:", e);
            return null;
          }
        }

        const rulelastIp = await rulefetchLastIpByDeviceId(deviceId);
        if (!rulelastIp) return;

        // Proxy SLA call through Django
        let ruleslaJson;
        let editingRule = null;
        const ruletbody = document.getElementById("rulesTableBody");
        try {
          const ruleproxyRes = await fetch("/api/device-sla-proxy/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ last_ip: rulelastIp }),
          });
          if (!ruleproxyRes.ok) {
            console.error(`SLA proxy returned HTTP ${ruleproxyRes.status}`);
            return;
          }
          ruleslaJson = await ruleproxyRes.json();
        } catch (err) {
          console.error("Error calling SLA proxy:", err);
          return;
        }

        const upIfnames = ruleslaJson.data?.up_ifname || [];
        interfaceSelect.innerHTML = "";
        if (!upIfnames.length) {
          interfaceSelect.add(new Option("No interfaces up", ""));
        } else {
          upIfnames.forEach((name) =>
            interfaceSelect.add(new Option(name, name))
          );
        }

        const rules = ruleslaJson.data?.rules || [];
        ruletbody.innerHTML = "";
        if (rules.length === 0) {
          ruletbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center">No rules yet</td>
      </tr>
    `;
        } else {
          // 3) otherwise, render each rule
          rules.forEach((rule) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${rule.rule_name}</td>
        <td>${rule.rule_source}</td>
        <td>${rule.rule_destination}</td>
        <td>${rule.rule_protocol}</td>
        <td>${rule.port}</td>
        <td>${rule.outgoing_mode}</td>
        <td>${rule.manual_interface}</td>
        <td>
          <button type="button" class="btn btn-sm btn-secondary ruleedit-btn" style=" margin-right: 10px;" data-name="${rule.rule_name}">Edit</button>
          <button class="btn btn-sm btn-danger ruledelete-btn" data-name="${rule.rule_name}">Delete</button>
        </td>
      `;
            ruletbody.appendChild(tr);
          });
        }
        
        ruletbody.querySelectorAll(".ruleedit-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
             const name = e.currentTarget.dataset.name;
    const rule = rules.find(r => r.rule_name === name);
    if (!rule) return;

    editingRule = rule;           // remember which one we’re editing
    document.getElementById("ruleModalLabel").textContent = "Edit Rule";

    serviceToggle.checked = rule.rule_service === "enable";
    toggleText.textContent = serviceToggle.checked ? "Enable" : "Disable";

    nameInput.value       = rule.rule_name;
    sourceInput.value     = rule.rule_source;
    destInput.value       = rule.rule_destination;
    protocolSelect.value  = rule.rule_protocol;
    portInput.value       = rule.port;
    modeSelect.value      = rule.outgoing_mode;
    interfaceSelect.value = rule.manual_interface;
            // TODO: open modal pre-filled with rules.find(r=>r.rule_name===name)
           nameInput.disabled = true;
            syncRows();
    syncInterfaceRow();

    // open the Bootstrap modal
    new bootstrap.Modal(document.getElementById("ruleModal")).show();
  });
});

ruletbody.querySelectorAll(".ruledelete-btn").forEach((btn) => {
          btn.addEventListener("click", async e => {
  const ruleName = e.currentTarget.dataset.name;
  if (!confirm(`Delete rule “${ruleName}”?`)) return;

  const payload = {
    method: "delete-rule",
    payload: { rule_name: ruleName }
  };

  try {
    const res = await fetch("/api/device-sla-proxy/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ last_ip: rulelastIp, ...payload })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    // remove the row
    e.currentTarget.closest("tr").remove();
    alert("Rule deleted");
  } catch (err) {
    console.error("Delete failed:", err);
  }
});
        });


        function hideModal() {
           const modalEl = document.getElementById("ruleModal");
           bootstrap.Modal.getInstance(modalEl).hide();
         }

        rulesaveBtn.addEventListener("click", async (e) => {
          e.preventDefault();

          if (!sourceInput.checkValidity()) { sourceInput.reportValidity(); return; }
  if (!destInput.checkValidity()) { destInput.reportValidity(); return; }
          // gather all form values
          const rule_service = serviceToggle.checked ? "enable" : "disable";
          const rule_name = nameInput.value;
          const rule_source = sourceInput.value;
          const rule_destination = destInput.value;
          const rule_protocol = protocolSelect.value;
          const port = portInput.value;
          const outgoing_mode = modeSelect.value;
          const manual_interface = interfaceSelect.value;
          const method = editingRule ? "edit-rule" : "add-rule";

          // build your payload exactly as needed

          const payload = {
            method,
            payload: {
              rule_service,
              rule_name,
              rule_source,
              rule_destination,
              rule_protocol,
              port,
              outgoing_mode,
              manual_interface,
            },
          };

          try {
            const res = await fetch("/api/device-sla-proxy/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ last_ip: rulelastIp, ...payload }),
            });
            if (!res.ok) {
              throw new Error(`HTTP ${res.status}`);
            }
            const result = await res.json();
            console.log("✅ set-rule result:", result);
            alert("Rule saved successfully!");
             hideModal();
          } catch (err) {
            console.error("❌ Save failed:", err);
            alert("Save failed: " + err.message);
             hideModal();
          }
          editingRule = null;
          document.getElementById("ruleForm").reset();
          hideModal();
        });
      });
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
      integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
      integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
