{% load i18n tz %}

<style>
  .event-card {
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.06);
    overflow:hidden;
    margin-bottom: 1rem;
  }
  .event-card-hd {
    display:flex;
    align-items:center;
    padding:12px 14px;
    border-bottom:1px solid #e5e7eb;
    gap:.75rem;
    flex-wrap:wrap;
  }
  .event-title { font-weight:800; color:#111827; font-size:14px; }

  .event-hd-left {
    display:flex;
    align-items:center;
    gap:.75rem;
    flex-wrap:wrap;
  }

  .event-updated {
    margin-left:auto;
    color:#6b7280;
    font-size:12px;
    white-space:nowrap;
  }

  /* Range picker chip */
  .range-chip-wrap { position:relative;
      margin-right: 20px;

  }
  .range-chip-btn {
       padding: 5px 10px;
    border-radius: 4px;
    /* padding: 6px 10px; */
    font-size: 14px;
    border: 1px solid #d1d5db;
    background: #24415d;
    color: #f9fafb;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .range-chip-btn span { white-space:nowrap; }
  .range-chip-caret {
    border-left:4px solid transparent;
    border-right:4px solid transparent;
    border-top:5px solid #e5e7eb;
    margin-top:2px;
  }
  .range-panel {
    position:absolute;
    top:110%;
    left:0;
    z-index:20;
    background:#fff;
    border-radius:8px;
    box-shadow:0 10px 30px rgba(15,23,42,.25);
    border:1px solid #e5e7eb;
    min-width:180px;
    padding:4px 0;
    display:none;
  }
  .range-option {
    width:100%;
    padding:6px 10px;
    border:0;
    background:#fff;
    text-align:left;
    font-size:12px;
    cursor:pointer;
  }
  .range-option:hover,
  .range-option.active {
    background:#fee2e2;
  }
  .range-panel-divider {
    height:1px;
    background:#e5e7eb;
    margin:4px 0;
  }
  .range-custom {
    padding:8px 10px;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .range-custom label {
    display:block;
    font-size:11px;
    color:#6b7280;
    margin-bottom:1px;
  }
  .range-custom input[type="datetime-local"] {
    width:100%;
    border:1px solid #e5e7eb;
    border-radius:6px;
    padding:3px 6px;
    font-size:11px;
  }
  .range-custom-apply {
    margin-top:4px;
    display:flex;
    justify-content:flex-end;
    gap:6px;
  }
  .btn-xs {
    border-radius:6px;
    border:1px solid #d1d5db;
    padding:3px 8px;
    font-size:11px;
    cursor:pointer;
    background:#f9fafb;
  }
  .btn-xs-primary {
    background:#0f172a;
    color:#f9fafb;
    border-color:#0f172a;
  }

  /* Export buttons */
  .event-export-btns {
    display:flex;
    align-items:center;
    gap:6px;
  }
  .export-btn {
    {% comment %} border-radius:6px;
    border:1px solid #d1d5db;
    padding:4px 8px;
    font-size:11px;
    cursor:pointer;
    background:#f9fafb;
    color:#111827; {% endcomment %}
        padding: 5px 10px;
    border-radius: 4px;
    /* padding: 6px 10px; */
    font-size: 14px;
    border: 1px solid #d1d5db;
    background: #24415d;
    color: #f9fafb;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .event-summary {
    padding:8px 14px;
    border-bottom:1px solid #e5e7eb;
    font-size:12px;
    color:#4b5563;
    display:flex;
    flex-wrap:wrap;
    gap:.75rem;
  }
  .event-summary span strong { font-weight:600; }

  .event-wrap { overflow-x:auto; }
  .event-table { width:100%; border-collapse:separate; border-spacing:0; }
  .event-th, .event-td { padding:10px 12px; border-bottom:1px solid #e5e7eb; font-size:13px; white-space:nowrap; }
  .event-th { text-transform:uppercase; color:#6b7280; font-weight:700; background:#fff; position:sticky; top:0; z-index:1; }
  .event-td { color:#111827; }
  .event-dot { width:10px; height:10px; border-radius:50%; display:inline-block; vertical-align:middle; margin-right:8px; }
  .event-dot-up { background:#10b981; }
  .event-dot-down { background:#ef4444; }
  .event-dot-unknown { background:#9ca3af; }

  .event-empty {
    margin:16px;
    padding:24px;
    border:1px dashed #d1d5db;
    border-radius:8px;
    text-align:center;
    color:#6b7280;
    display:none;
  }

  .pager { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; gap:.75rem; flex-wrap:wrap; font-size:12px; }
  .pager-left { color:#475569; }
  .pager-right { display:flex; align-items:center; gap:.25rem; }
  .pager button, .pager .page-btn {
    min-width:2rem;
    height:2rem;
    padding:0 .5rem;
    border:1px solid #e5e7eb;
    background:#fff;
    border-radius:6px;
    cursor:pointer;
  }
  .pager .active { background:#0f172a; color:#fff; border-color:#0f172a; }
  .pager select { border:1px solid #e5e7eb; border-radius:6px; padding:2px 6px; }
  .ellipsis { padding:0 .25rem; color:#64748b; }

  @media (max-width: 640px) {
    .event-card-hd { align-items:flex-start; }
    .event-updated { margin-left:0; }
  }

  .event-filter{
    display:flex;
    margin-bottom:10px;
    padding:10px;
    justify-content:space-between;
  }
</style>

<div class="event-filter">
      <!-- Range picker chip -->
      <div class="range-chip-wrap">
        <button type="button" class="range-chip-btn" id="range-chip-btn">
          <span id="range-chip-label">{% trans "Last 24 hours" %}</span>
          <div class="range-chip-caret"></div>
        </button>

        <div class="range-panel" id="range-panel">
          <button type="button" class="range-option" data-range="24h">{% trans "Last 1 Day" %}</button>
          <button type="button" class="range-option" data-range="3d">{% trans "Last 3 Days" %}</button>
          <button type="button" class="range-option" data-range="7d">{% trans "Last 7 Days" %}</button>
          <button type="button" class="range-option" data-range="30d">{% trans "Last 30 Days" %}</button>
          <button type="button" class="range-option" data-range="365d">{% trans "Last 365 Days" %}</button>
          <div class="range-panel-divider"></div>
          <button type="button" class="range-option" data-range="custom" id="range-custom-toggle">
            {% trans "Custom Range" %}
          </button>

          <div class="range-custom" id="range-custom-block" style="display:none;">
            <div>
              <label for="range-start">{% trans "From" %}</label>
              <input type="datetime-local" id="range-start">
            </div>
            <div>
              <label for="range-end">{% trans "To" %}</label>
              <input type="datetime-local" id="range-end">
            </div>
            <div class="range-custom-apply">
              <button type="button" class="btn-xs" id="range-cancel">{% trans "Cancel" %}</button>
              <button type="button" class="btn-xs btn-xs-primary" id="range-apply-custom">{% trans "Apply" %}</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Export buttons -->
      <div class="event-export-btns">
        <button type="button" class="export-btn" id="export-excel">{% trans "Export Excel" %}</button>
        <button type="button" class="export-btn" id="export-pdf">{% trans "Export PDF" %}</button>
      </div>
</div>



<div class="event-card" id="event-card">
  <div class="event-card-hd">
    <div class="event-hd-left">
      <div class="event-title">{% trans "Events" %}</div>


    </div>

    <div class="event-updated">
      {% trans "Last Updated" %}:
      <span>{{ device_data.general.local_time|default:"â€”" }}</span>
    </div>
  </div>

  <div class="event-summary" id="event-summary">
    <!-- filled by JS -->
  </div>

  <div class="event-wrap" id="event-wrap">
    <table class="event-table" id="event-table">
      <thead>
        <tr>
          <th class="event-th">{% trans "Start" %}</th>
          <th class="event-th">{% trans "End" %}</th>
          <th class="event-th">{% trans "Status" %}</th>
          <th class="event-th">{% trans "Duration" %}</th>
        </tr>
      </thead>
      <tbody id="event-tbody"></tbody>
    </table>

    <div class="event-empty" id="event-empty">{% trans "No events available" %}</div>

    <div class="pager">
      <div class="pager-left">
        <span id="range-text"></span>
        &nbsp;{% trans "Show" %}&nbsp;
        <select id="page-size">
          <option selecteds>10</option>
          <option >25</option>
          <option>50</option>
          <option>100</option>
        </select>
      </div>
      <div class="pager-right">
        <button id="prev-btn" aria-label="{% trans 'Previous' %}">â€¹</button>
        <div id="page-buttons"></div>
        <button id="next-btn" aria-label="{% trans 'Next' %}">â€º</button>
      </div>
    </div>
  </div>
</div>

{# intervals always dumped, default [] to avoid JS errors #}
{{ device_data.availability.intervals|default:"[]"|json_script:"intervals-data" }}

<script>
  (function () {
    const jsonEl = document.getElementById('intervals-data');
    if (!jsonEl) return;

    let rawIntervals = [];
    try { rawIntervals = JSON.parse(jsonEl.textContent || '[]'); }
    catch (e) { rawIntervals = []; }

    const table = document.getElementById('event-table');
    const tbody = document.getElementById('event-tbody');
    const emptyBox = document.getElementById('event-empty');
    const rangeText = document.getElementById('range-text');
    const pageSizeSel = document.getElementById('page-size');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageBtnsWrap = document.getElementById('page-buttons');
    const summaryEl = document.getElementById('event-summary');

    const chipBtn = document.getElementById('range-chip-btn');
    const chipLabel = document.getElementById('range-chip-label');
    const panel = document.getElementById('range-panel');
    const rangeOptions = panel.querySelectorAll('.range-option');
    const customBlock = document.getElementById('range-custom-block');
    const rangeStartInput = document.getElementById('range-start');
    const rangeEndInput = document.getElementById('range-end');
    const customApplyBtn = document.getElementById('range-apply-custom');
    const customCancelBtn = document.getElementById('range-cancel');

    const exportExcelBtn = document.getElementById('export-excel');
    const exportPdfBtn = document.getElementById('export-pdf');

    function esc(s) {
      return String(s).replace(/[&<>"']/g, function (m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }

    if (!rawIntervals.length) {
      table.style.display = 'none';
      emptyBox.style.display = 'block';
      return;
    } else {
      table.style.display = '';
      emptyBox.style.display = 'none';
    }

    // Normalise & sort
    const allIntervals = rawIntervals.map(r => {
      const startMs = Date.parse(String(r.start).replace(' ', 'T'));
      const endMs = Date.parse(String(r.end).replace(' ', 'T'));
      return {
        start: String(r.start),
        end: String(r.end),
        status: r.status || 'unknown',
        _startMs: startMs,
        _endMs: endMs
      };
    }).filter(r => !isNaN(r._startMs) && !isNaN(r._endMs));

    if (!allIntervals.length) {
      table.style.display = 'none';
      emptyBox.style.display = 'block';
      return;
    }

    allIntervals.sort((a, b) => a._startMs - b._startMs);

    const lastEndMs = allIntervals.reduce((acc, r) => Math.max(acc, r._endMs), 0);
    const firstStartMs = allIntervals.reduce((acc, r) => Math.min(acc, r._startMs), lastEndMs);

    function fmtDuration(seconds) {
      seconds = Math.max(0, Math.round(seconds));
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      const parts = [];
      if (h) parts.push(h + 'h');
      if (m) parts.push(m + 'm');
      if (!h && !m) parts.push(s + 's');
      return parts.join(' ') || '0s';
    }

    function fmtDateTime(ms) {
      const d = new Date(ms);
      const pad = n => (n < 10 ? '0' + n : '' + n);
      return d.getFullYear() + '-' +
             pad(d.getMonth() + 1) + '-' +
             pad(d.getDate()) + ' ' +
             pad(d.getHours()) + ':' +
             pad(d.getMinutes()) + ':' +
             pad(d.getSeconds());
    }

    function fmtRangeLabel(startMs, endMs) {
      const d1 = new Date(startMs);
      const d2 = new Date(endMs);
      const month = m => d2.toLocaleString(undefined, { month: 'long' });
      const fmt = d => d.toLocaleDateString(undefined, {
        year:'numeric', month:'long', day:'numeric'
      });
      return fmt(d1) + ' â€“ ' + fmt(d2);
    }

    let page = 1;
    let pageSize = parseInt(pageSizeSel.value, 10) || 25;
    let filtered = [];
    let currentWindow = { startMs: firstStartMs, endMs: lastEndMs };
    let currentMode = '24h';  // default
    let currentSummary = null; // <-- keep latest summary for export

    function computeWindowForMode(mode) {
      const nowMs = lastEndMs || Date.now();
      let startMs, endMs;
      if (mode === '24h') {
        endMs = nowMs; startMs = endMs - 24*3600*1000;
      } else if (mode === '3d') {
        endMs = nowMs; startMs = endMs - 3*24*3600*1000;
      } else if (mode === '7d') {
        endMs = nowMs; startMs = endMs - 7*24*3600*1000;
      } else if (mode === '30d') {
        endMs = nowMs; startMs = endMs - 30*24*3600*1000;
      } else if (mode === '365d') {
        endMs = nowMs; startMs = endMs - 365*24*3600*1000;
      } else {
        endMs = nowMs; startMs = endMs - 24*3600*1000;
      }

      if (startMs < firstStartMs) startMs = firstStartMs;
      if (endMs > lastEndMs) endMs = lastEndMs;
      currentWindow = { startMs, endMs };
    }

    function computeWindowCustom() {
      const nowMs = lastEndMs || Date.now();
      let s = rangeStartInput.value ? Date.parse(rangeStartInput.value) : NaN;
      let e = rangeEndInput.value ? Date.parse(rangeEndInput.value) : NaN;

      if (!isNaN(s) && isNaN(e)) e = nowMs;
      if (isNaN(s) && !isNaN(e)) s = e - 24*3600*1000;
      if (isNaN(s) || isNaN(e) || s >= e) {
        computeWindowForMode('24h');
        currentMode = '24h';
        return;
      }
      let startMs = s, endMs = e;
      if (startMs < firstStartMs) startMs = firstStartMs;
      if (endMs > lastEndMs) endMs = lastEndMs;
      currentWindow = { startMs, endMs };
      currentMode = 'custom';
    }

    function filterAndSummarize() {
      const { startMs, endMs } = currentWindow;
      const rows = [];
      let upSec = 0;
      let downSec = 0;

      allIntervals.forEach(r => {
        if (r._endMs <= startMs || r._startMs >= endMs) return;
        const ovStart = Math.max(r._startMs, startMs);
        const ovEnd = Math.min(r._endMs, endMs);
        const sec = Math.max(0, Math.round((ovEnd - ovStart) / 1000));
        if (!sec) return;

        if (r.status === 'up') upSec += sec;
        else downSec += sec;

        rows.push({
          start: fmtDateTime(ovStart),
          end: fmtDateTime(ovEnd),
          status: r.status,
          duration_seconds: sec,
          duration_human: fmtDuration(sec)
          _startMs: ovStart
        });
      });


        // ðŸ”½ sort so latest interval appears first
      rows.sort((a, b) => b._startMs - a._startMs);
      rows.forEach(r => { delete r._startMs; });

      const totalSpanSec = Math.max(0, Math.round((endMs - startMs) / 1000));
      let uptimePct = null;
      if (totalSpanSec > 0) uptimePct = (upSec / totalSpanSec) * 100;

      return {
        rows,
        summary: {
          uptime_seconds: upSec,
          downtime_seconds: downSec,
          uptime_human: fmtDuration(upSec),
          downtime_human: fmtDuration(downSec),
          uptime_percent: uptimePct !== null ? uptimePct.toFixed(2) : null,
          window_start: fmtDateTime(startMs),
          window_end: fmtDateTime(endMs),
          label: fmtRangeLabel(startMs, endMs)
        }
      };
    }

       function renderSummary(summary) {
      currentSummary = summary;   // <-- remember for export

      if (!summary) {
        summaryEl.innerHTML = '';
        chipLabel.textContent = '{% trans "Last 24 hours" %}';
        return;
      }

      const upPct = summary.uptime_percent !== null ? summary.uptime_percent + '%' : 'n/a';
      summaryEl.innerHTML =
        '<span><strong>{% trans "Uptime" %}:</strong> ' + esc(upPct) + '</span>' +
        '<span><strong>{% trans "Total Up" %}:</strong> ' + esc(summary.uptime_human) + '</span>' +
        '<span><strong>{% trans "Total Down" %}:</strong> ' + esc(summary.downtime_human) + '</span>' +
        '<span><strong>{% trans "Window" %}:</strong> ' +
        esc(summary.window_start) + ' â†’ ' + esc(summary.window_end) + '</span>';

      chipLabel.textContent = summary.label;
    }


    function renderTable() {
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (page > totalPages) page = totalPages;

      const startIdx = (page - 1) * pageSize;
      const endIdx = Math.min(startIdx + pageSize, total);
      const rows = filtered.slice(startIdx, endIdx);

      tbody.innerHTML = rows.map(r => {
        const sts = (r.status || 'unknown').toLowerCase();
        let dotClass = 'event-dot-unknown';
        if (sts === 'up') dotClass = 'event-dot-up';
        else if (sts === 'down') dotClass = 'event-dot-down';

        return '<tr>' +
          '<td class="event-td event-mono">' + esc(r.start) + '</td>' +
          '<td class="event-td event-mono">' + esc(r.end) + '</td>' +
          '<td class="event-td"><span class="event-dot ' + dotClass + '"></span>' +
          esc(sts.charAt(0).toUpperCase() + sts.slice(1)) + '</td>' +
          '<td class="event-td">' + esc(r.duration_human) + '</td>' +
        '</tr>';
      }).join('');

      const left = total === 0 ? 0 : startIdx + 1;
      rangeText.textContent = left + 'â€“' + endIdx + ' {% trans "of" %} ' + total;

      renderPager(totalPages);
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = page >= totalPages;
    }

    function renderPager(totalPages) {
      const maxBtns = 7;
      let start = Math.max(1, page - Math.floor(maxBtns / 2));
      let end = start + maxBtns - 1;
      if (end > totalPages) { end = totalPages; start = Math.max(1, end - maxBtns + 1); }

      const parts = [];
      const mkBtn = p => '<button class="page-btn' + (p === page ? ' active' : '') +
                         '" data-page="' + p + '">' + p + '</button>';

      if (start > 1) {
        parts.push(mkBtn(1));
        if (start > 2) parts.push('<span class="ellipsis">â€¦</span>');
      }
      for (let p = start; p <= end; p++) parts.push(mkBtn(p));
      if (end < totalPages) {
        if (end < totalPages - 1) parts.push('<span class="ellipsis">â€¦</span>');
        parts.push(mkBtn(totalPages));
      }
      pageBtnsWrap.innerHTML = parts.join('');
    }

    pageBtnsWrap.addEventListener('click', function (e) {
      const p = e.target && e.target.dataset && e.target.dataset.page;
      if (p) { page = parseInt(p, 10) || 1; renderTable(); }
    });
    prevBtn.addEventListener('click', function () {
      if (page > 1) { page--; renderTable(); }
    });
    nextBtn.addEventListener('click', function () {
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      if (page < totalPages) { page++; renderTable(); }
    });
    pageSizeSel.addEventListener('change', function () {
      pageSize = parseInt(pageSizeSel.value, 10) || 25;
      page = 1;
      renderTable();
    });

    // Range picker interactions
    function openPanel() { panel.style.display = 'block'; }
    function closePanel() { panel.style.display = 'none'; customBlock.style.display = 'none'; }

    chipBtn.addEventListener('click', function (e) {
      e.stopPropagation();
      panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    });

    document.addEventListener('click', function (e) {
      if (!panel.contains(e.target) && e.target !== chipBtn) {
        closePanel();
      }
    });

    rangeOptions.forEach(function (btn) {
      btn.addEventListener('click', function () {
        const val = this.getAttribute('data-range');
        rangeOptions.forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        if (val === 'custom') {
          customBlock.style.display = 'block';
          return;
        }
        customBlock.style.display = 'none';
        currentMode = val;
        computeWindowForMode(val);
        const res = filterAndSummarize();
        filtered = res.rows;
        page = 1;
        renderSummary(res.summary);
        renderTable();
        closePanel();
      });
    });

    customApplyBtn.addEventListener('click', function () {
      computeWindowCustom();
      const res = filterAndSummarize();
      filtered = res.rows;
      page = 1;
      renderSummary(res.summary);
      renderTable();
      closePanel();
    });

    customCancelBtn.addEventListener('click', function () {
      customBlock.style.display = 'none';
    });
        function getSummaryForExport() {
      if (currentSummary) return currentSummary;
      // Fallback: recompute from current window
      const res = filterAndSummarize();
      currentSummary = res.summary;
      return currentSummary;
    }


    // Export Excel (CSV)
    // Export Excel (CSV)
    exportExcelBtn.addEventListener('click', function () {
      if (!filtered.length) return;

      const summary = getSummaryForExport();

      const metaRows = [
        ['Uptime', summary.uptime_percent !== null ? summary.uptime_percent + '%' : 'n/a'],
        ['Total Up', summary.uptime_human],
        ['Total Down', summary.downtime_human],
        ['Window Start', summary.window_start],
        ['Window End', summary.window_end],
        ['',''] // blank line before table
      ];

      const header = ['Start','End','Status','Duration'];
      const rows = filtered.map(r => [
        r.start, r.end, r.status, r.duration_human
      ]);

      const allRows = metaRows.concat([header]).concat(rows);

      const csvLines = allRows.map(cols => {
        return cols.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',');
      });

      const blob = new Blob([csvLines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'device-events.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Export PDF (printable view â€“ user can save as PDF)
    // Export PDF (printable view â€“ user can save as PDF)
    exportPdfBtn.addEventListener('click', function () {
      if (!filtered.length) return;

      const summary = getSummaryForExport();

      const rowsHtml = filtered.map(r => {
        return '<tr>' +
          '<td>' + esc(r.start) + '</td>' +
          '<td>' + esc(r.end) + '</td>' +
          '<td>' + esc(r.status) + '</td>' +
          '<td>' + esc(r.duration_human) + '</td>' +
        '</tr>';
      }).join('');

      const upPct = summary.uptime_percent !== null ? summary.uptime_percent + '%' : 'n/a';
      const summaryHtml =
        '<p><strong>Uptime:</strong> ' + esc(upPct) +
        ' &nbsp; <strong>Total Up:</strong> ' + esc(summary.uptime_human) +
        ' &nbsp; <strong>Total Down:</strong> ' + esc(summary.downtime_human) +
        '<br><strong>Window:</strong> ' + esc(summary.window_start) +
        ' â†’ ' + esc(summary.window_end) + '</p>';

      const win = window.open('', '_blank');
      win.document.write(
        '<html><head><title>Events</title>' +
        '<style>' +
        'body{font-family:system-ui,Arial,sans-serif;font-size:12px;}' +
        'h3{margin-bottom:4px;}' +
        'table{border-collapse:collapse;width:100%;font-size:12px;margin-top:8px;}' +
        'th,td{border:1px solid #000;padding:4px 6px;text-align:left;}' +
        '</style>' +
        '</head><body>' +
        '<h3>Device Events</h3>' +
        summaryHtml +
        '<table><thead><tr><th>Start</th><th>End</th><th>Status</th><th>Duration</th></tr></thead><tbody>' +
        rowsHtml +
        '</tbody></table>' +
        '</body></html>'
      );
      win.document.close();
      win.focus();
      win.print();  // user can "Save as PDF"
    });


    // Initial load: last 24h
    currentMode = '24h';
    computeWindowForMode('24h');
    const initial = filterAndSummarize();
    filtered = initial.rows;
    renderSummary(initial.summary);
    renderTable();
  })();
</script>
