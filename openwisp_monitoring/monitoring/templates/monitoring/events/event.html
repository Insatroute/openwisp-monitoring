{% load i18n l10n admin_urls static tz %}

{% if device_data.availability.intervals %}
  {{ device_data.availability.intervals|json_script:"intervals-data" }}

  <style>
    .avail-card { width: 100%; background: #fff; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.06); overflow: hidden; }
    .avail-table { width: 100%; border-collapse: collapse; }
    .avail-table thead th { text-align: left; font-weight: 600; padding: .75rem 1rem; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
    .avail-table tbody td { padding: .75rem 1rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    .status-dot { display: inline-block; width: .65rem; height: .65rem; border-radius: 9999px; margin-right: .5rem; vertical-align: middle; }
    .dot-up { background: #22c55e; }
    .dot-down { background: #ef4444; }
    .duration { font-weight: 700; }
    @media (max-width: 640px) {
      .avail-table thead { display: none; }
      .avail-table tbody tr { display: grid; grid-template-columns: 1fr; padding: .5rem .75rem; }
      .avail-table tbody td { border: 0; padding: .4rem 0; }
      .row-card { border-bottom: 1px solid #e5e7eb; }
    }
    .pager { display: flex; align-items: center; justify-content: space-between; padding: .75rem 0; gap: .75rem; flex-wrap: wrap; }
    .pager-left { color: #475569; font-size: .875rem; }
    .pager-right { display: flex; align-items: center; gap: .5rem; }
    .pager button, .pager .page-btn { min-width: 2rem; height: 2rem; padding: 0 .5rem; border: 1px solid #e5e7eb; background: #fff; border-radius: .5rem; cursor: pointer; }
    .pager .active { background: #0f172a; color: #fff; border-color: #0f172a; }
    .pager select { border: 1px solid #e5e7eb; border-radius: .5rem; padding: .25rem .5rem; }
    .ellipsis { padding: 0 .25rem; color: #64748b; }
    .empty-state {margin:16px;padding:24px;
    border:1px dashed #d1d5db;
    border-radius:8px;
    text-align:center;
    color:#6b7280;
  }
  </style>

  <div class="avail-card">
    <table class="avail-table">
      <thead>
        <tr>
          <th>{% trans "Interval (IST)" %}</th>  {# changed label #}
          <th>{% trans "Status" %}</th>
          <th>{% trans "Duration" %}</th>
        </tr>
      </thead>
      <tbody id="intervals-body"></tbody>
    </table>

    <div class="pager">
      <div class="pager-left">
        <span id="range-text"></span>
        &nbsp;{% trans "Show" %}&nbsp;
        <select id="page-size">
          <option>10</option><option>25</option><option>50</option><option>100</option>
        </select>
      </div>
      <div class="pager-right">
        <button id="prev-btn" aria-label="{% trans 'Previous' %}">‹</button>
        <div id="page-buttons"></div>
        <button id="next-btn" aria-label="{% trans 'Next' %}">›</button>
      </div>
    </div>
  </div>

<script>
  (function () {
    const rawIntervals = JSON.parse(document.getElementById('intervals-data').textContent || '[]');

    // Just keep the raw values – assume backend gives IST already
    const intervals = rawIntervals
      .map(r => ({
        ...r,
        _startMs: Date.parse(String(r.start).replace(' ', 'T')),
        _endMs: Date.parse(String(r.end).replace(' ', 'T'))
      }))
      .sort((a, b) => (b._endMs - a._endMs) || (b._startMs - a._startMs));

    function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    const bodyEl = document.getElementById('intervals-body');
    const rangeText = document.getElementById('range-text');
    const pageSizeSel = document.getElementById('page-size');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageBtnsWrap = document.getElementById('page-buttons');

    let page = 1;
    let pageSize = parseInt(pageSizeSel.value, 10) || 10;

    function fmtInterval(row) { return `${esc(row.start)} \u2192 ${esc(row.end)}`; }
    function statusCell(row) {
      const up = row.status === 'up';
      return `<span class="status-dot ${up ? 'dot-up' : 'dot-down'}"></span>${up ? '{% trans "Up" %}' : '{% trans "Down" %}'}`;
    }

    function renderTable() {
      const total = intervals.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (page > totalPages) page = totalPages;

      const startIdx = (page - 1) * pageSize;
      const endIdx = Math.min(startIdx + pageSize, total);
      const rows = intervals.slice(startIdx, endIdx);

      bodyEl.innerHTML = rows.map(r => `
        <tr class="row-card">
          <td>${fmtInterval(r)}</td>
          <td>${statusCell(r)}</td>
          <td><span class="duration">${esc(r.duration_human)}</span></td>
        </tr>
      `).join('');

      const left = total === 0 ? 0 : startIdx + 1;
      rangeText.textContent = `${left}\u2013${endIdx} {% trans "of" %} ${total}`;

      renderPager(totalPages);
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = page >= totalPages;
    }

    function renderPager(totalPages) {
      const maxBtns = 7;
      let start = Math.max(1, page - Math.floor(maxBtns / 2));
      let end = start + maxBtns - 1;
      if (end > totalPages) { end = totalPages; start = Math.max(1, end - maxBtns + 1); }

      const parts = [];
      const btn = p => `<button class="page-btn${p===page?' active':''}" data-page="${p}">${p}</button>`;
      if (start > 1) { parts.push(btn(1)); if (start > 2) parts.push(`<span class="ellipsis">…</span>`); }
      for (let p = start; p <= end; p++) parts.push(btn(p));
      if (end < totalPages) { if (end < totalPages - 1) parts.push(`<span class="ellipsis">…</span>`); parts.push(btn(totalPages)); }
      pageBtnsWrap.innerHTML = parts.join('');
    }

    pageBtnsWrap.addEventListener('click', (e) => {
      const p = e.target?.dataset?.page;
      if (p) { page = parseInt(p, 10); renderTable(); }
    });
    prevBtn.addEventListener('click', () => { if (page > 1) { page--; renderTable(); }});
    nextBtn.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(intervals.length / pageSize));
      if (page < totalPages) { page++; renderTable(); }
    });
    pageSizeSel.addEventListener('change', () => {
      pageSize = parseInt(pageSizeSel.value, 10) || 10;
      page = 1;
      renderTable();
    });

    renderTable();
  })();
</script>



{% else %}
  <p class="empty-state">No availability intervals found.</p>
{% endif %}