{% load i18n static %}
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>

<style>
  .nx-grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:12px;align-items:stretch}
  .nx-col-6{grid-column:span 6}.nx-col-12{grid-column:span 12}
  @media (max-width:1100px){.nx-col-6,.nx-col-12{grid-column:span 12}}

  .nx-card{background:#fff;border:1px solid #e8eaee;border-radius:16px;box-shadow:0 6px 24px rgba(16,24,40,.06);overflow:hidden;display:flex;flex-direction:column;height:100%}
  .nx-card-hd{padding:14px 18px;border-bottom:1px solid #e8eaee}
  .nx-title{margin:0;font:700 16px/1.3 ui-sans-serif,system-ui;color:#0f172a}
  .nx-card-bd{padding:16px 18px;display:flex;flex-direction:column;gap:12px;flex:1}

  .nx-chart-row{display:flex;justify-content:center}
  .nx-chart-row canvas{display:block;width:100% !important;max-width:420px;height:260px !important}

  .nx-legend{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;color:#475569;font:500 12px ui-sans-serif,system-ui}
  .nx-legend-dot{width:10px;height:10px;border-radius:999px;border:1px solid rgba(0,0,0,.08);display:inline-block;margin-right:6px}

  /* filter exactly like the image */
  .nx-filter{border:1px solid #e7e9ee;border-radius:10px;padding:8px 10px;font-size:13px;background:#fff}

  .nx-table-wrap{border:1px solid #edf0f5;border-radius:12px;overflow:hidden}
  .nx-table{width:100%;border-collapse:separate;border-spacing:0}
  .nx-thead th{background:#fbfcfe;color:#6b7280;text-transform:uppercase;letter-spacing:.04em;font:700 11px ui-sans-serif,system-ui;padding:10px 12px;border-bottom:1px solid #edf0f5}
  .nx-tbody tr:nth-child(even){background:#fafbff}.nx-tbody tr:hover{background:#f0f0f094}
  .nx-cell{padding:12px;font:500 13px ui-sans-serif,system-ui;color:#0f172a}
  .nx-cell-right{text-align:right;color:#525b70}

  .nx-foot{display:flex;align-items:center;justify-content:space-between;padding:8px 2px 0;color:#6b7280;font:500 12px ui-sans-serif,system-ui}
  .nx-pager{display:flex;gap:8px;align-items:center}
  .nx-btn{border:1px solid #e7e9ee;background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
  .nx-btn[disabled]{opacity:.5;cursor:default}
  .nx-select{border:1px solid #e7e9ee;border-radius:10px;padding:6px 8px;font-size:12px;background:#fff}
</style>

{{ device_data|json_script:"nx-device-data" }}

<div id="nx-traffic-ui" class="nx-wrap">
  <div class="nx-grid">
    <!-- Applications -->
    <section class="nx-card nx-col-6">
      <div class="nx-card-hd"><h3 class="nx-title">{% trans "Applications" %}</h3></div>
      <div class="nx-card-bd">
        <div class="nx-chart-row"><canvas id="nx-chart-apps"></canvas></div>
        <div class="nx-legend" id="nx-legend-apps"></div>
        <input id="nx-filter-apps" class="nx-filter" placeholder="{% trans 'Filter…' %}">
        <div class="nx-table-wrap">
          <table class="nx-table">
            <thead class="nx-thead"><tr><th>{% trans "Label" %}</th><th class="nx-cell-right">{% trans "Traffic" %}</th></tr></thead>
            <tbody id="nx-tbody-apps" class="nx-tbody"></tbody>
          </table>
        </div>
        <div class="nx-foot">
          <span id="nx-info-apps"></span>
          <div class="nx-pager">
            <select id="nx-pagesize-apps" class="nx-select"><option>8</option><option>10</option><option>20</option></select>
            <button id="nx-prev-apps" class="nx-btn">{% trans "Prev" %}</button>
            <button id="nx-next-apps" class="nx-btn">{% trans "Next" %}</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Remote Hosts -->
    <section class="nx-card nx-col-6">
      <div class="nx-card-hd"><h3 class="nx-title">{% trans "Remote Hosts" %}</h3></div>
      <div class="nx-card-bd">
        <div class="nx-chart-row"><canvas id="nx-chart-hosts"></canvas></div>
        <div class="nx-legend" id="nx-legend-hosts"></div>
        <input id="nx-filter-hosts" class="nx-filter" placeholder="{% trans 'Filter…' %}">
        <div class="nx-table-wrap">
          <table class="nx-table">
            <thead class="nx-thead"><tr><th>{% trans "Host" %}</th><th class="nx-cell-right">{% trans "Traffic" %}</th></tr></thead>
            <tbody id="nx-tbody-hosts" class="nx-tbody"></tbody>
          </table>
        </div>
        <div class="nx-foot">
          <span id="nx-info-hosts"></span>
          <div class="nx-pager">
            <select id="nx-pagesize-hosts" class="nx-select"><option>8</option><option>10</option><option>20</option></select>
            <button id="nx-prev-hosts" class="nx-btn">{% trans "Prev" %}</button>
            <button id="nx-next-hosts" class="nx-btn">{% trans "Next" %}</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Protocols -->
    <section class="nx-card nx-col-12">
      <div class="nx-card-hd"><h3 class="nx-title">{% trans "Protocols" %}</h3></div>
      <div class="nx-card-bd">
        <div class="nx-chart-row"><canvas id="nx-chart-prot"></canvas></div>
        <div class="nx-legend" id="nx-legend-prot"></div>
        <input id="nx-filter-prot" class="nx-filter" placeholder="{% trans 'Filter…' %}">
        <div class="nx-table-wrap">
          <table class="nx-table">
            <thead class="nx-thead"><tr><th>{% trans "Protocol" %}</th><th class="nx-cell-right">{% trans "Traffic" %}</th></tr></thead>
            <tbody id="nx-tbody-prot" class="nx-tbody"></tbody>
          </table>
        </div>
        <div class="nx-foot">
          <span id="nx-info-prot"></span>
          <div class="nx-pager">
            <select id="nx-pagesize-prot" class="nx-select"><option>8</option><option>10</option><option>20</option></select>
            <button id="nx-prev-prot" class="nx-btn">{% trans "Prev" %}</button>
            <button id="nx-next-prot" class="nx-btn">{% trans "Next" %}</button>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
(() => {
  const device_data = JSON.parse(document.getElementById('nx-device-data').textContent || '{}');
  const talkers = (((device_data||{}).realtimemonitor||{}).real_time_traffic||{}).data?.talkers || {};
  const APPS  = talkers.top_apps || [];
  const HOSTS = talkers.top_hosts || [];
  const PROTS = talkers.top_protocols || [];

  const palette=["#3b82f6","#ef4444","#f59e0b","#10b981","#8b5cf6","#06b6d4","#84cc16","#eab308","#ec4899","#14b8a6","#f97316","#4f46e5"];
  const colors=n=>Array.from({length:n},(_,i)=>palette[i%palette.length]);
  const fmtBytes=n=>{n=Number(n)||0;if(n>=1<<30)return(n/(1<<30)).toFixed(1)+' GB';if(n>=1<<20)return(n/(1<<20)).toFixed(1)+' MB';if(n>=1<<10)return(n/(1<<10)).toFixed(1)+' KB';return n.toFixed(0)+' B'};
  const toBytes=v=>Number(v)||0;
  const cleanAppLabel=(name)=>{const p=String(name||'').split('.');return p.length>=3?p.slice(2).join('.'):String(name||'')};

  function draw(canvas, labels, values){
    const cs=colors(values.length||1);
    new Chart(canvas.getContext('2d'),{
      type:'doughnut',
      data:{labels,datasets:[{data:values,backgroundColor:cs,borderWidth:1}]},
      options:{responsive:true,maintainAspectRatio:false,cutout:'58%',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.label}: ${fmtBytes(c.raw)}`}}}}
    });
    return cs;
  }

  function tableCtrl({data,filterEl,tbody,pageSel,prev,next,info,row}){
    let filtered=[...data], page=0;
    const size=()=>parseInt(pageSel.value,10)||8;
    const pages=()=>Math.max(1,Math.ceil(filtered.length/size()));
    function render(){
      const slice=filtered.slice(page*size(),page*size()+size());
      tbody.innerHTML=slice.map(row).join('');
      prev.disabled=page<=0; next.disabled=page>=pages()-1;
      info.textContent=`Page ${Math.min(page+1,pages())} of ${pages()} — ${filtered.length} rows`;
    }
    function apply(){
      const q=(filterEl.value||'').toLowerCase();
      filtered=data.filter(x=>JSON.stringify(x).toLowerCase().includes(q));
      page=0; render();
    }
    filterEl.addEventListener('input',apply);
    pageSel.addEventListener('change',()=>{page=0;render()});
    prev.addEventListener('click',()=>{if(page>0){page--;render()}});
    next.addEventListener('click',()=>{if(page<pages()-1){page++;render()}});
    render(); return {refresh:nd=>{data=nd;apply()}};
  }

  // Applications
  {
    const labels=(APPS.length?APPS:[{name:'—',value:0}]).map(a=>cleanAppLabel(a.name));
    const values=(APPS.length?APPS:[{value:0}]).map(a=>toBytes(a.value));
    const cs=draw(document.getElementById('nx-chart-apps'),labels,values);
    document.getElementById('nx-legend-apps').innerHTML=labels.map((t,i)=>`<span><i class="nx-legend-dot" style="background:${cs[i]}"></i>${t}</span>`).join('');
    tableCtrl({
      data:APPS,
      filterEl:document.getElementById('nx-filter-apps'),
      tbody:document.getElementById('nx-tbody-apps'),
      pageSel:document.getElementById('nx-pagesize-apps'),
      prev:document.getElementById('nx-prev-apps'),
      next:document.getElementById('nx-next-apps'),
      info:document.getElementById('nx-info-apps'),
      row:a=>`<tr><td class="nx-cell">${cleanAppLabel(a.name)}</td><td class="nx-cell nx-cell-right">${fmtBytes(toBytes(a.value))}</td></tr>`
    });
  }

  // Hosts
  {
    const labels=(HOSTS.length?HOSTS:[{ip:'—',totals:{}}]).map(h=>h.ip||h.host||h.mac||'—');
    const values=(HOSTS.length?HOSTS:[{totals:{}}]).map(h=>(h.totals?.download||0)+(h.totals?.upload||0));
    const cs=draw(document.getElementById('nx-chart-hosts'),labels,values);
    document.getElementById('nx-legend-hosts').innerHTML=labels.map((t,i)=>`<span><i class="nx-legend-dot" style="background:${cs[i]}"></i>${t}</span>`).join('');
    tableCtrl({
      data:HOSTS,
      filterEl:document.getElementById('nx-filter-hosts'),
      tbody:document.getElementById('nx-tbody-hosts'),
      pageSel:document.getElementById('nx-pagesize-hosts'),
      prev:document.getElementById('nx-prev-hosts'),
      next:document.getElementById('nx-next-hosts'),
      info:document.getElementById('nx-info-hosts'),
      row:h=>{const n=h.ip||h.host||h.mac||'—';const b=(h.totals?.download||0)+(h.totals?.upload||0);return `<tr><td class="nx-cell">${n}</td><td class="nx-cell nx-cell-right">${fmtBytes(b)}</td></tr>`;}
    });
  }

  // Protocols
  {
    const labels=(PROTS.length?PROTS:[{name:'—',value:0}]).map(p=>p.name);
    const values=(PROTS.length?PROTS:[{value:0}]).map(p=>toBytes(p.value));
    const cs=draw(document.getElementById('nx-chart-prot'),labels,values);
    document.getElementById('nx-legend-prot').innerHTML=labels.map((t,i)=>`<span><i class="nx-legend-dot" style="background:${cs[i]}"></i>${t}</span>`).join('');
    tableCtrl({
      data:PROTS,
      filterEl:document.getElementById('nx-filter-prot'),
      tbody:document.getElementById('nx-tbody-prot'),
      pageSel:document.getElementById('nx-pagesize-prot'),
      prev:document.getElementById('nx-prev-prot'),
      next:document.getElementById('nx-next-prot'),
      info:document.getElementById('nx-info-prot'),
      row:p=>`<tr><td class="nx-cell">${p.name}</td><td class="nx-cell nx-cell-right">${fmtBytes(toBytes(p.value))}</td></tr>`
    });
  }
})();
</script>