
{% if device_data.realtimemonitor.security %}
{{ device_data.realtimemonitor.security|json_script:"sec-data" }}
{% else %}
<script type="application/json" id="sec-data">{}</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .security-wrap { margin: 16px auto; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #2b2f38; }
  .security-row { display: grid; gap: 18px; }
  .security-row.kpis { grid-template-columns: repeat(3, minmax(0, 1fr)); }
  .security-row.single { grid-template-columns: minmax(0, 1fr); }

  .security-card, .security-tile {
    background: #fff; border-radius: 14px;
    box-shadow: 0 6px 20px rgba(22,34,51,.08);
    border: 1px solid #e5e7eb;
  }
  .security-tile { position: relative; padding: 18px 16px 22px; text-align: center; }
  .security-donut { width: 130px !important; height: 130px !important; display: block; margin: 2px auto 0; }
  .tile-sub { margin: 10px 0px; font-size: 12px; color:#6b7280; }
  .security-corner-note {
    position: absolute; right: 10px; bottom: 6px; font-size: 10px; color: #6b7280;
    background: #f8fafc; padding: 4px 8px; border-radius: 8px; border: 1px solid #e5e7eb;
  }
  .security-card { padding: 0; overflow: hidden; }

  /* Header matches your cellular header style */
  .chart-header {
    background: #f0f0f0; padding: 10px 12px; font-weight: 700; color: #1f2937;
    border-bottom: 1px solid #eee; border-top-left-radius: 10px; border-top-right-radius: 10px; font-size: 14px;
  }
  .security-chart-shell { height: 360px; padding: 16px; }
  .security-note { margin: 0 16px 16px; color: #6b7280; }

  @media (max-width: 1100px) { .security-row.kpis { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
  @media (max-width: 820px)  {
    .security-row.kpis { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .security-chart-shell { height:auto; aspect-ratio:16/10; min-height:260px; }
  }
  @media (max-width: 520px)  {
    .security-row.kpis { grid-template-columns: 1fr; }
    .security-chart-shell { aspect-ratio:4/3; min-height:220px; }
  }

  canvas { max-width: 100%; height: auto; }
</style>

<div class="security-wrap">
  <!-- ROW 1: KPI Donuts -->
  <div class="security-row kpis">
    <div class="security-tile">
      <canvas id="donutMalware" class="security-donut"></canvas>
      <div class="tile-sub">Total detections</div>
      <div id="noteMalware" class="security-corner-note"></div>
    </div>

    <div class="security-tile">
      <canvas id="donutAttacks" class="security-donut"></canvas>
      <div class="tile-sub">Brute-force attempts</div>
      <div id="noteAttacks" class="security-corner-note"></div>
    </div>

    <div class="security-tile">
      <canvas id="donutIPs" class="security-donut"></canvas>
      <div class="tile-sub">Blocked</div>
      <div id="noteIPs" class="security-corner-note"></div>
    </div>

    {% comment %} <div class="security-tile">
      <canvas id="donutAlerts" class="security-donut"></canvas>
      <div class="tile-sub">Need attention</div>
      <div id="noteAlerts" class="security-corner-note"></div>
    </div> {% endcomment %}
  </div>

  <!-- ROW 2 -->
  <div class="security-row single" style="margin-top:18px;">
    <div class="security-card">
      <div class="chart-header">Malware (by Hour)</div>
      <div class="security-chart-shell"><canvas id="chartMalwareByHour"></canvas></div>
      <p class="security-note">Bars show malware detections per hour.</p>
    </div>
  </div>

  <!-- ROW 3 -->
  <div class="security-row single" style="margin-top:18px;">
    <div class="security-card">
      <div class="chart-header">Brute-force Attacks (by Hour)</div>
      <div class="security-chart-shell"><canvas id="chartAttackByHour"></canvas></div>
      <p class="security-note">Bars show brute-force attempts per hour.</p>
    </div>
  </div>
</div>

<script>
  // --- Helpers for your schema ---
  const raw = JSON.parse(document.getElementById('sec-data').textContent || '{}');

  const pairsTo24 = (pairs) => {
    const out = Array.from({length:24}, ()=>0);
    if (Array.isArray(pairs)) {
      for (const item of pairs) {
        const [h, v] = Array.isArray(item) ? item : [];
        const hr = Number(h);
        const val = Number(v);
        if (Number.isInteger(hr) && hr >= 0 && hr < 24 && Number.isFinite(val)) {
          out[hr] = val;
        }
      }
    }
    return out;
  };

  const fmtEpochLocal = (ts) => {
    const n = Number(ts);
    if (!Number.isFinite(n) || n <= 0) return '—';
    return new Date(n * 1000).toLocaleString('en-IN', {
      timeZone: 'Asia/Kolkata',
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', hour12: false
    });
  };

  const bl = raw.blocklist || {};
  const bfa = raw.brute_force_attack || {};

  // Map your structure -> dashboard fields
  const securityData = {
    // Donut 1: malware (blocklist)
    malware_count: Number(bl.malware_count ?? 0),
    malware_first_seen: fmtEpochLocal(bl.first_seen),
    malware_by_hour: pairsTo24(bl.malware_by_hour),

    // Donut 2: brute-force
    attack_count: Number(bfa.attack_count ?? 0),
    attack_first_seen: fmtEpochLocal(bfa.first_seen),
    attack_by_hour: pairsTo24(bfa.attack_by_hour),

    // Donut 3: "Blocked / flagged" — using unique attacking IPs
    suspicious_ips: Object.keys(bfa.attack_by_ip || {}).length,
    suspicious_first_seen: fmtEpochLocal(bfa.first_seen),

    // Donut 4: "Need attention" — not in schema; keep as 0 unless you add it later
    open_alerts: 0,
    alerts_first_seen: '—'
  };

  const hours = Array.from({length:24}, (_,i)=> (i<10?'0':'') + i + ':00');

  // --- Chart.js center number plugin (unchanged) ---
  const centerTextPlugin = {
    id: 'centerText',
    afterDraw(chart, args, options) {
      const {ctx, chartArea} = chart;
      if (!chartArea) return;
      const {left, top, width, height} = chartArea;
      ctx.save();
      ctx.font = 'bold 22px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';
      ctx.fillStyle = '#111827';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(options.text, left + width/2, top + height/2);
      ctx.restore();
    }
  };

  const donutCfg = (value, max=20, color="#3b82f6") => ({
    type: "doughnut",
    data: {
      datasets: [{
        data: [value, Math.max(max - value, 0)],
        backgroundColor: [color, "#f3f4f6"],
        borderWidth: 0
      }]
    },
    options: {
      cutout: "72%",
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false },
        centerText: { text: String(value) }
      }
    },
    plugins: [centerTextPlugin]
  });

  const barCfg = (labels, data, labelName, color="#3b82f6") => ({
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: labelName,
        data,
        backgroundColor: color,
        borderRadius: 6,
        maxBarThickness: 22
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { autoSkip: true, maxTicksLimit: 12 } },
        y: { beginAtZero: true, grid: { color: "#f3f4f6" } }
      }
    }
  });

  // --- Render charts with your data ---
  new Chart(document.getElementById("donutMalware"), donutCfg(securityData.malware_count, 20, "#ef4444"));
  document.getElementById("noteMalware").textContent = `First seen: ${securityData.malware_first_seen}`;

  new Chart(document.getElementById("donutAttacks"), donutCfg(securityData.attack_count, 20, "#2563eb"));
  document.getElementById("noteAttacks").textContent = `First seen: ${securityData.attack_first_seen}`;

 new Chart(
  document.getElementById("donutIPs"),
  donutCfg(securityData.suspicious_ips, 20, "#f59e0b")
);
document.getElementById("noteIPs").textContent =
  `First seen: ${securityData.suspicious_first_seen}`;

// Only draw Alerts donut if the elements exist (they are commented out in HTML)
const alertsCanvas = document.getElementById("donutAlerts");
const alertsNoteEl = document.getElementById("noteAlerts");
if (alertsCanvas && alertsNoteEl) {
  new Chart(alertsCanvas, donutCfg(securityData.open_alerts, 20, "#10b981"));
  alertsNoteEl.textContent = `First seen: ${securityData.alerts_first_seen}`;
}

  new Chart(
    document.getElementById("chartMalwareByHour"),
    barCfg(hours, securityData.malware_by_hour, "Malware / hour", "#ef4444")
  );

  new Chart(
    document.getElementById("chartAttackByHour"),
    barCfg(hours, securityData.attack_by_hour, "Attacks / hour", "#2563eb")
  );
</script>
