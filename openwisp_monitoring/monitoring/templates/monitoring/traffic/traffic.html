<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Traffic</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root { --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f8fafc; --card:#fff; }

  h2 { margin:16px 0 8px; font-weight:800; letter-spacing:.2px; }
  h3 { 
         font-weight: 700 !important;
    font-size: 18px !important;
    margin-bottom: 0 !important;
    color: #334155 !important;
  }
  h4 { margin:0 0 8px; font-weight:700; color:#334155; }
  .wrap { max-width:1200px; margin:10px auto 28px; padding:0 12px; }

  .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:15px !important; }
  .tile {     
    border: 1px solid #e5e7eb !important;
    border-radius: 14px !important;
    box-shadow: 0 6px 20px rgba(22, 34, 51, .08) !important;
    padding: 16px !important;
  }
  .traffic-grid { display:grid; gap:14px; }
  .traffic-grid-2 { grid-template-columns: repeat(2, minmax(0,1fr));margin-top:16px; }
  #detailTab .traffic-grid-2 { grid-template-columns: 320px minmax(0,1fr); } 

  .grid-main { display:grid; gap:14px; grid-template-columns: 320px minmax(0,1fr); }
  @media (max-width: 980px) { .grid-2 { grid-template-columns: 1fr; } .grid-main { grid-template-columns: 1fr; } }

  .kpi { display:flex; align-items:center; justify-content:center; height:120px; font-size:24px; font-weight:800; }
  .muted { color:var(--muted); }
  .chart-shell { 
    position:relative;
    height:260px; 
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .chart-shell.tall { height:420px; } /* main hourly chart */
  .hourly-card { padding-bottom:18px; }

  .tbl-wrap { overflow:auto; border:1px solid var(--line); border-radius:12px; }
  table { width:100%; border-collapse:separate; border-spacing:0; }
  thead th { text-align:left; background:#f1f5f9; padding:10px 12px; position:sticky; top:0; z-index:1; font-weight:700; }
  tbody td { padding:10px 12px; border-top:1px solid var(--line); }
  tbody tr:hover { background:#f8fafc; }
  .num { text-align:right; font-variant-numeric: tabular-nums; }
  .clickable tbody tr { cursor:pointer; }

  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .grow { flex:1; }
  .input { width:100%; border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff; }
  .btn { display:inline-flex; align-items:center; gap:6px; border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
  .btn:hover { background:#f8fafc; }
  .hidden { display:none !important; }
  .pager { display:flex; align-items:center; gap:8px; padding:8px 0; }
  .select { border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 8px; }

  .seg { display:inline-flex; border:1px solid var(--line); border-radius:10px; overflow:hidden; }
  .seg button { padding:6px 10px; background:#fff; border:0; cursor:pointer; }
  .seg button.active { background:#eef2ff; font-weight:600; }

  #detailTab { max-width:1100px; margin:18px auto 0; }
  #todayDonut, #detailDonut { width:140px !important; height:140px !important; }
  #backBtn { width: 10%; background-color: #4a555f; }

  #apiError{display:none; color:#b91c1c; margin:8px 0;}
</style>
</head>
<body>
<div class="wrap">
  <div id="apiError"></div>

  <!-- HEADER -->
  <section class="recent-traffic-section grid-main">
    <div class="traffic-grid" style="grid-template-columns: 1fr;">
      <div class="tile">
        <h4>Total (today)</h4>
        <div style="display:flex; align-items:center; justify-content:center;">
          <canvas id="todayDonut" width="180" height="180"></canvas>
        </div>
      </div>
      <div class="tile">
        <h4>Total (today)</h4>
        <div class="kpi"><span id="kpiTodayText">0 GB</span></div>
      </div>
    </div>
    <div class="card hourly-card">
      <h4>Hourly traffic</h4>
      <div class="chart-shell tall"><canvas id="hourlyChart"></canvas></div>
    </div>
  </section>

  <!-- CARDS: 2 per row -->
  <section class="traffic-grid traffic-grid-2 recent-traffic-section">
    <div class="card">
      <h3>Applications</h3>
      <div class="chart-shell"><canvas id="appsChart"></canvas></div>
      <div class="row" style="margin-top:8px;">
        <input id="appsFilter" class="input grow" placeholder="Filter…" />
      </div>
      <div class="tbl-wrap" style="margin-top:8px;">
        <table id="appsTable" class="nice-table clickable">
          <thead><tr><th>Label</th><th class="num">Traffic</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pager" id="appsPager"></div>
    </div>

    <div class="card">
      <h3>Remote Hosts</h3>
      <div class="chart-shell"><canvas id="hostsChart"></canvas></div>
      <div class="row" style="margin-top:8px;">
        <input id="hostsFilter" class="input grow" placeholder="Filter…" />
      </div>
      <div class="tbl-wrap" style="margin-top:8px;">
        <table id="hostsTable" class="nice-table clickable">
          <thead><tr><th>Host</th><th class="num">Traffic</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pager" id="hostsPager"></div>
    </div>

    <div class="card">
      <h3>Protocols</h3>
      <div class="chart-shell"><canvas id="protocolsChart"></canvas></div>
      <div class="row" style="margin-top:8px;">
        <input id="protocolsFilter" class="input grow" placeholder="Filter…" />
      </div>
      <div class="tbl-wrap" style="margin-top:8px;">
        <table id="protocolsTable" class="nice-table clickable">
          <thead><tr><th>Protocol</th><th class="num">Traffic</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pager" id="protocolsPager"></div>
    </div>

    <div class="card">
      <h3>Clients</h3>
      <div class="chart-shell"><canvas id="clientsChart"></canvas></div>
      <div class="row" style="margin-top:8px;">
        <input id="clientsFilter" class="input grow" placeholder="Filter…" />
      </div>
      <div class="tbl-wrap" style="margin-top:8px;">
        <table id="clientsTable" class="nice-table clickable">
          <thead><tr><th>Client</th><th class="num">Traffic</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pager" id="clientsPager"></div>
    </div>
  </section>

  <!-- DETAIL TAB -->
  <section id="detailTab" class="hidden">
    <button id="backBtn" class="btn" type="button">← Back</button>
    <h3 id="detailTitle" style="margin:8px 0 12px;"></h3>

    <div class="traffic-grid traffic-grid-2">
      <div class="tile">
        <h4>Total (today)</h4>
        <div style="display:flex; align-items:center; justify-content:center;">
          <canvas id="detailDonut" width="180" height="180"></canvas>
        </div>
        <div id="detailTotalText" class="muted" style="text-align:center; margin-top:10px;"></div>
      </div>
      <div class="card">
        <h4>Hourly traffic</h4>
        <div class="chart-shell"><canvas id="detailHourly"></canvas></div>
      </div>
    </div>

    <div id="detailSwitcher" class="row hidden" style="margin-top:12px;">
      <span class="muted">View:</span>
      <div class="seg" id="seg">
        <button data-view="apps" class="active" type="button">Applications</button>
        <button data-view="hosts" type="button">Hosts</button>
        <button data-view="protocols" type="button">Protocols</button>
      </div>
    </div>

    <div style="margin-top:12px;">
      <h4 id="detailTableTitle"></h4>
      <div class="tbl-wrap">
        <table id="detailTable" class="nice-table">
          <thead><tr><th id="detailCol1">Item</th><th class="num">Traffic</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pager" id="detailPager"></div>
    </div>
  </section>
</div>

<script>
/* -------------------- UTILITIES -------------------- */
const bytesToGB = b => (Number(b||0) / (1024*1024*1024));
function fmtGB(bytes){
  const gb = bytesToGB(bytes);
  if (gb >= 0.1) return gb.toFixed(2) + " GB";
  const mb = Number(bytes||0) / (1024*1024);
  if (mb >= 1) return mb.toFixed(1) + " MB";
  const kb = Number(bytes||0) / 1024;
  if (kb >= 1) return kb.toFixed(0) + " KB";
  return (Number(bytes||0)) + " B";
}
const centerText = { id:'centerText', beforeDraw(chart, a, opts){ if(!opts||!opts.text) return; const {ctx,chartArea:{width,height}}=chart; ctx.save(); ctx.font='600 14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial'; ctx.fillStyle='#334155'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(opts.text,width/2,height/2); ctx.restore(); } };

/* -------------------- NORMALIZATION -------------------- */
function summaryOf(root){
  const s = root?.dpi_summery_v2 || root || {};
  return {
    hourly_traffic: s.hourly_traffic || [],
    total_traffic:  Number(s.total_traffic || 0),
    applications:   s.applications   || [],
    remote_hosts:   s.remote_hosts   || [],
    protocols:      s.protocols      || [],
    clients:        s.clients        || []
  };
}

/* -------------------- PAGINATION -------------------- */
function paginateAndRender({rows, tableBodyEl, pagerEl, pageSizeOptions=[6,10,25], defaultPageSize=6, rowRenderer}){
  let filteredRows = rows.slice(); let page = 1; let pageSize = defaultPageSize;
  function totalPages(){ return Math.max(1, Math.ceil(filteredRows.length / pageSize)); }
  function renderPager(){
    pagerEl.innerHTML = '';
    const sel = document.createElement('select'); sel.className = 'select';
    pageSizeOptions.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=`${n}/page`; if(n===pageSize) o.selected=true; sel.appendChild(o); });
    sel.onchange = (ev)=>{ ev.preventDefault(); ev.stopPropagation(); pageSize=Number(sel.value); page=1; render(); };
    const prev = document.createElement('button'); prev.className='btn'; prev.textContent='Prev'; prev.type='button';
    const next = document.createElement('button'); next.className='btn'; next.textContent='Next'; next.type='button';
    const info = document.createElement('span'); info.className='muted';
    const sync = ()=> info.textContent = `Page ${page} of ${totalPages()} — ${filteredRows.length} rows`;
    prev.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); if(page>1){ page--; renderBody(); sync(); } };
    next.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); if(page<totalPages()){ page++; renderBody(); sync(); } };
    pagerEl.appendChild(sel); pagerEl.appendChild(prev); pagerEl.appendChild(next); pagerEl.appendChild(info); sync();
  }
  function renderBody(){ const start=(page-1)*pageSize; const slice=filteredRows.slice(start,start+pageSize); tableBodyEl.innerHTML = slice.map(rowRenderer).join('') || '<tr><td colspan="99">No data</td></tr>'; }
  function render(){ renderBody(); renderPager(); }
  return { setFilter(fn){ filteredRows=rows.filter(fn); page=1; render(); }, refresh(){ render(); } };
}

/* -------------------- CHARTS -------------------- */
let hourlyChart=null, todayDonutChart=null, detailHourlyChart=null, detailDonutChart=null, smallCharts={};
function drawHourlyChart(hoursArr){
  const hours = Array.from({length:24}, (_,i)=> String(i).padStart(2,'0'));
  const dataGB = hours.map(h => { const hit = hoursArr.find(x => x.id === h); return (hit ? Number(hit.traffic) : 0) / (1024*1024*1024); });
  if (hourlyChart) hourlyChart.destroy();
  const maxY = Math.max(0.01, ...dataGB) * 1.25;
  hourlyChart = new Chart(document.getElementById('hourlyChart'), {
    type:'bar',
    data:{ labels: hours.map(h=>`${h}:00`), datasets:[{ label:'Hourly (GB)', data:dataGB, borderRadius:8, borderSkipped:false, categoryPercentage:0.9, barPercentage:0.9, maxBarThickness:28 }] },
    options:{ responsive:true, maintainAspectRatio:false, layout:{ padding:{ top:6, right:8, bottom:0, left:8 } },
      plugins:{ legend:{ display:true, position:'bottom' }, tooltip:{ callbacks:{ label:(c)=> `${c.dataset.label}: ${Number(c.raw).toFixed(3)} GB` } } },
      scales:{ x:{ grid:{display:true, drawTicks:false}, ticks:{ autoSkip:false, maxRotation:45, minRotation:45 } }, y:{ beginAtZero:true, suggestedMax:maxY, title:{display:true, text:'GB'}, grid:{drawBorder:false} } } }
  });
}
function drawTodayDonut(bytes){
  if (todayDonutChart) todayDonutChart.destroy();
  todayDonutChart = new Chart(document.getElementById('todayDonut'), { type:'doughnut', plugins:[centerText],
    data:{ datasets:[{ data:[bytes, 1], borderWidth:0 }] }, options:{ cutout:'70%', plugins:{ legend:{display:false}, centerText:{ text: fmtGB(bytes) } } } });
}
function drawSmallDonut(id, items, labelKey, valueKey){
  const labels = items.map(x => x[labelKey] || x.id);
  const data   = items.map(x => Number(x[valueKey] || 0));

  const MAX_LEGEND = 4;
  const COLORS = ['#3b82f6','#ef4444','#f59e0b','#22c55e','#8b5cf6','#06b6d4','#a3a3a3','#16a34a','#fb7185','#84cc16'];

  if (smallCharts[id]) smallCharts[id].destroy?.();

  smallCharts[id] = new Chart(document.getElementById(id), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: labels.map((_, i) => COLORS[i % COLORS.length]),
        borderWidth: 0
      }]
    },
    options: {
      cutout: '55%',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            usePointStyle: true,
            pointStyle: 'circle',
            boxWidth: 10,
            padding: 12,
            generateLabels(chart) {
              const {labels} = chart.data;
              const ds = chart.data.datasets[0] || {};
              const colors = ds.backgroundColor || [];
              const n = Math.min(MAX_LEGEND, labels.length);
              const out = [];
              for (let i = 0; i < n; i++) {
                out.push({
                  text: String(labels[i]),
                  fillStyle: colors[i] || '#ccc',
                  strokeStyle: colors[i] || '#ccc',
                  lineWidth: 0,
                  hidden: false,
                  index: i
                });
              }
              return out;
            }
          }
        },
        tooltip: {
          callbacks: {
            label: (c) => `${c.label}: ${fmtGB(c.raw)}`
          }
        }
      }
    }
  });
}

function drawDetailDonut(bytes){
  if (detailDonutChart) detailDonutChart.destroy();
  detailDonutChart = new Chart(document.getElementById('detailDonut'), { type:'doughnut', plugins:[centerText],
    data:{ datasets:[{ data:[bytes, 1], borderWidth:0 }] }, options:{ cutout:'70%', plugins:{ legend:{display:false}, centerText:{ text: fmtGB(bytes) } } } });
}
function drawDetailHourly(map){
  const hours = Array.from({length:24}, (_,i)=> String(i).padStart(2,'0'));
  const gb = hours.map(h => (map.get(h)||0)/(1024*1024*1024));
  if (detailHourlyChart) detailHourlyChart.destroy();
  detailHourlyChart = new Chart(document.getElementById('detailHourly'), { type:'bar',
    data:{ labels: hours.map(h => `${h}:00`), datasets:[{ label:'GB', data: gb, borderRadius:6 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{callbacks:{label:(c)=> `${Number(c.raw).toFixed(3)} GB`}}}, scales:{ x:{ grid:{display:false}}, y:{ beginAtZero:true, title:{display:true, text:'GB'}} } } });
}

/* -------------------- STATE -------------------- */
let RAW=null, SUM=null, pagers={};

/* -------------------- TABLES & DETAIL -------------------- */
function setupTable({tableId, pagerId, filterId, rows, labelKey, valueKey, clickHandler, defaultPageSize=6}){
  const tbody = document.querySelector(`#${tableId} tbody`);
  const pager = document.getElementById(pagerId);
  const filter = document.getElementById(filterId);
  const renderer = (x)=> `<tr data-id="${x.id}"><td>${x[labelKey] ?? x.id}</td><td class="num">${fmtGB(x[valueKey])}</td></tr>`;
  const p = paginateAndRender({ rows, tableBodyEl:tbody, pagerEl:pager, defaultPageSize, rowRenderer:renderer });
  pagers[tableId] = p; p.refresh();
  if (filter){ filter.addEventListener('input', ()=>{ const q=filter.value.toLowerCase(); p.setFilter(x => String(x[labelKey] ?? x.id).toLowerCase().includes(q)); }); }
  tbody.addEventListener('click', (e)=>{ const tr=e.target.closest('tr'); if(!tr) return; e.preventDefault(); e.stopPropagation(); const id=tr.getAttribute('data-id'); const label=tr.children[0].textContent.trim(); clickHandler(id,label); });
}
function showSection(selector, visible){ document.querySelectorAll(selector).forEach(s => s.classList.toggle('hidden', !visible)); }
function byHour_App(appId){ const m=new Map(); (RAW?.dpi_client_data||[]).forEach(r=>{ const h=String(r.hour??'').padStart(2,'0'); const v=Number(r?.data?.application?.[appId]||0); m.set(h,(m.get(h)||0)+v); }); return m; }
function byHour_Host(host){ const m=new Map(); (RAW?.dpi_client_data||[]).forEach(r=>{ const h=String(r.hour??'').padStart(2,'0'); const v=Number(r?.data?.host?.[host]||0); m.set(h,(m.get(h)||0)+v); }); return m; }
function byHour_Proto(proto){ const m=new Map(); (RAW?.dpi_client_data||[]).forEach(r=>{ const h=String(r.hour??'').padStart(2,'0'); const v=Number(r?.data?.protocol?.[proto]||0); m.set(h,(m.get(h)||0)+v); }); return m; }
function byHour_Client(client){ const m=new Map(); (RAW?.dpi_client_data||[]).forEach(r=>{ if(r.client!==client) return; const h=String(r.hour??'').padStart(2,'0'); const v=Number(r?.data?.total||0); m.set(h,(m.get(h)||0)+v); }); return m; }

let detailPager=null;
function openDetail({type,id,label}){
  document.getElementById('detailTitle').textContent = ({ application:`Application: ${label}`, host:`Host: ${label}`, protocol:`Protocol: ${label}`, client:`Client: ${label}` })[type];
  let totalBytes=0;
  if(type==='application') totalBytes = Number((SUM.applications||[]).find(a=>a.id===id)?.traffic||0);
  if(type==='host')       totalBytes = Number((SUM.remote_hosts||[]).find(h=>h.id===id)?.traffic||0);
  if(type==='protocol')   totalBytes = Number((SUM.protocols||[]).find(p=>p.id===id)?.traffic||0);
  if(type==='client')     totalBytes = Number((SUM.clients||[]).find(c=>c.id===id)?.traffic||0);
  drawDetailDonut(totalBytes); document.getElementById('detailTotalText').textContent = fmtGB(totalBytes);
  let hm=new Map(); if(type==='application') hm=byHour_App(id); if(type==='host') hm=byHour_Host(id); if(type==='protocol') hm=byHour_Proto(id); if(type==='client') hm=byHour_Client(id); drawDetailHourly(hm);

  const tableTitle=document.getElementById('detailTableTitle'); const col1=document.getElementById('detailCol1'); const tbody=document.querySelector('#detailTable tbody'); const pager=document.getElementById('detailPager');
  function rowsFor(view){ const out=new Map(); (RAW?.dpi_client_data||[]).forEach(r=>{ const add=(k,b)=> out.set(k,(out.get(k)||0)+(Number(b)||0)); if(type==='application'){ if(view!=='clients') return; const v=Number(r?.data?.application?.[id]||0); if(v>0) add(r.client,v); } else if(type==='host'){ if(view!=='clients') return; const v=Number(r?.data?.host?.[id]||0); if(v>0) add(r.client,v); } else if(type==='protocol'){ if(view!=='clients') return; const v=Number(r?.data?.protocol?.[id]||0); if(v>0) add(r.client,v); } else if(type==='client'){ if(r.client!==id) return; if(view==='apps'){ for(const [k,v] of Object.entries(r?.data?.application||{})) add(k,v); } if(view==='hosts'){ for(const [k,v] of Object.entries(r?.data?.host||{})) add(k,v); } if(view==='protocols'){ for(const [k,v] of Object.entries(r?.data?.protocol||{})) add(k,v); } } }); return Array.from(out.entries()).map(([k,v])=>({key:k,label:k,bytes:v})); }
  let view=(type==='client')?'apps':'clients';
  function applyTitles(){ if(type==='client'){ document.getElementById('detailSwitcher').classList.remove('hidden'); document.querySelectorAll('#seg button').forEach(b=> b.classList.toggle('active', b.dataset.view===view)); const ttl={apps:'Applications',hosts:'Hosts',protocols:'Protocols'}[view]; tableTitle.textContent=`Top ${ttl} for ${label}`; col1.textContent=ttl.slice(0,-1); } else { document.getElementById('detailSwitcher').classList.add('hidden'); tableTitle.textContent=`Top Clients for ${label}`; col1.textContent='Client'; } }
  applyTitles();
  function renderDetail(){ const rows=rowsFor(view).sort((a,b)=> b.bytes-a.bytes); const rowRenderer=r=> `<tr><td>${r.label}</td><td class="num">${fmtGB(r.bytes)}</td></tr>`; detailPager = paginateAndRender({ rows, tableBodyEl:tbody, pagerEl:pager, defaultPageSize:8, rowRenderer }); detailPager.refresh(); }
  renderDetail();
  document.querySelectorAll('#seg button').forEach(b=>{ b.onclick=(e)=>{ e.preventDefault(); e.stopPropagation(); view=b.dataset.view; applyTitles(); renderDetail(); }; });
  showSection('.recent-traffic-section', false); document.getElementById('detailTab').classList.remove('hidden');
}
document.getElementById('backBtn').onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); document.getElementById('detailTab').classList.add('hidden'); showSection('.recent-traffic-section', true); };

/* -------------------- INIT -------------------- */
async function init(){
  // Build API URL from UUID in the URL path
  const path = new URL(window.location.href).pathname;
  const match = path.match(/[0-9a-fA-F-]{36}/);
  const DEVICE_UUID = match ? match[0] : null;

  const apiError = document.getElementById('apiError');
  if (!DEVICE_UUID) {
    console.error('Device UUID not found in URL:', path);
    apiError.style.display = 'block';
    apiError.textContent = 'Device ID not found in URL.';
    return;
  }

  const API_URL = `https://controller.nexapp.co.in/api/v1/monitoring/device/${DEVICE_UUID}/traffic-summary/`;

  try{
    const resp = await fetch(API_URL, {cache:'no-store'});
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    RAW = await resp.json();
  }catch(e){
    console.error('API load failed:', e);
    apiError.style.display = 'block';
    apiError.textContent = 'Failed to load traffic summary.';
    return;
  }

  // EXPECTED SHAPE: { dpi_summery_v2: {...}, dpi_client_data: [...] }
  SUM = summaryOf(RAW?.dpi_summery_v2);

  drawTodayDonut(SUM.total_traffic);
  document.getElementById('kpiTodayText').textContent = fmtGB(SUM.total_traffic);
  drawHourlyChart(SUM.hourly_traffic);

  drawSmallDonut('appsChart',      SUM.applications, 'label', 'traffic');
  drawSmallDonut('hostsChart',     SUM.remote_hosts, 'id',    'traffic');
  drawSmallDonut('protocolsChart', SUM.protocols,    'label', 'traffic');
  drawSmallDonut('clientsChart',   SUM.clients,      'label', 'traffic');

  setupTable({ tableId:'appsTable',      pagerId:'appsPager',      filterId:'appsFilter',      rows:SUM.applications, labelKey:'label', valueKey:'traffic', clickHandler:(id,label)=> openDetail({type:'application', id, label}) });
  setupTable({ tableId:'hostsTable',     pagerId:'hostsPager',     filterId:'hostsFilter',     rows:SUM.remote_hosts, labelKey:'id',    valueKey:'traffic', clickHandler:(id,label)=> openDetail({type:'host',       id, label}) });
  setupTable({ tableId:'protocolsTable', pagerId:'protocolsPager', filterId:'protocolsFilter', rows:SUM.protocols,    labelKey:'label', valueKey:'traffic', clickHandler:(id,label)=> openDetail({type:'protocol',   id, label}) });
  setupTable({ tableId:'clientsTable',   pagerId:'clientsPager',   filterId:'clientsFilter',   rows:SUM.clients,      labelKey:'label', valueKey:'traffic', clickHandler:(id,label)=> openDetail({type:'client',     id, label}) });
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
