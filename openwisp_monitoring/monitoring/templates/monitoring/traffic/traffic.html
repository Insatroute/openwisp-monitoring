<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if device_data.realtimemonitor.traffic %}
{{ device_data.realtimemonitor.traffic|json_script:"traffic-data" }}
{% else %}
<script type="application/json" id="traffic-data">{}</script>
{% endif %}

<style>
  /* ===== Traffic Dashboard (namespaced) ===== */

  .traffic-wrap{margin:16px auto;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#2b2f38}
  .traffic-wrap *{box-sizing:border-box}

  /* Row grids */
  .traffic-row{display:grid;gap:18px}
  .traffic-row.top{grid-template-columns:260px 1fr;align-items:stretch}
  .traffic-row.two{grid-template-columns:1fr 1fr}

  @media (max-width:1100px){
    .traffic-row.top{grid-template-columns:1fr}
    .traffic-row.two{grid-template-columns:1fr}
  }

  /* Cards */
  .traffic-card{
    position:relative;overflow:hidden;
    background:#fff;border-radius:14px;border:1px solid #e5e7eb;
    box-shadow:0 6px 20px rgba(22,34,51,.08)
  }
  .traffic-card-pad{padding:16px}
  .traffic-header{
    background:#f0f0f0;padding:10px 12px;font-weight:700;color:#1f2937;
    border-bottom:1px solid #eee;font-size:14px
  }

  /* Donuts */
  .traffic-donut-shell{height:220px;display:flex;align-items:center;justify-content:center}
  .traffic-donut{width:180px !important;height:180px !important;display:block !important}

  /* Ensure canvases obey our sizing (neutralize global CSS) */
  .traffic-wrap canvas{position:static !important;display:block !important;max-width:100%;height:auto}

  /* KPI total text (inside Total card) */
  .traffic-kpi-big{font-size:18px;font-weight:700;text-align:center;padding:22px 8px;color:#111827}

  /* Vertical body layout: donut -> legend -> filter -> table -> pagination */
  .traffic-vert{display:flex;flex-direction:column;gap:8px}

  /* Legend */
  .traffic-legend{display:flex;flex-wrap:wrap;gap:8px;padding:0 2px}
  .traffic-legend-item{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:#334155;background:#f8fafc;border:1px solid #e5e7eb;padding:6px 8px;border-radius:10px}
  .traffic-swatch{width:10px;height:10px;border-radius:50%;display:inline-block}

  /* Filter + table */
  .traffic-filter-bar{padding:0}
  .traffic-filter-bar input{width:100%;padding:9px 10px;border:1px solid #e5e7eb;border-radius:10px;font-size:12px;background:#fff;outline:none}

  .traffic-table-wrap{padding:0;max-height:340px;overflow:auto}
  .traffic-table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:13px}
  .traffic-table thead th{text-align:left;font-weight:700;color:#475569;font-size:12px;padding:0 8px 6px}
  .traffic-table tbody td{padding:10px 8px;border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb}
  .traffic-table tbody tr td:first-child{border-left:1px solid #e5e7eb;border-top-left-radius:10px;border-bottom-left-radius:10px}
  .traffic-table tbody tr td:last-child{border-right:1px solid #e5e7eb;border-top-right-radius:10px;border-bottom-right-radius:10px;text-align:right;color:#111827;font-weight:600}

  .traffic-note{color:#6b7280;font-size:12px}

  /* Pagination footer */
  .traffic-pagination{
  margin-top:auto;      /* pushes footer to the bottom */
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 14px 12px;
  font-size:12px;
  color:#475569;
  border-top:1px solid #e5e7eb;
  border-bottom-left-radius:14px;
  border-bottom-right-radius:14px;

  /* optional: keep visible while the page scrolls within the card area */
  position: sticky;     
  bottom: 0;
  z-index: 1;
}
  .traffic-pagination .traffic-page-info{color:#64748b}
  .traffic-pagination .traffic-page-controls{display:flex;align-items:center;gap:6px}
  .traffic-pagination select{
    border:1px solid #e5e7eb;border-radius:6px;padding:3px 6px;font-size:12px;color:#334155;background:#fff;outline:none
  }
  .traffic-pagination button{
    border:1px solid #e5e7eb;border-radius:6px;background:#f3f4f6;color:#64748b;
    font-size:12px;padding:3px 8px;cursor:pointer;transition:.2s
  }
  .traffic-pagination button:hover:not(:disabled){background:#e5e7eb}
  .traffic-pagination button:disabled{opacity:.5;cursor:default}
</style>

<div class="traffic-wrap">

  <!-- ROW 1: Total + Hourly -->
  <div class="traffic-row top">
    <div class="traffic-card">
      <div class="traffic-header">Total (today)</div>
      <div class="traffic-donut-shell">
        <canvas id="traffic-donut-total" class="traffic-donut"></canvas>
      </div>
      <div class="traffic-kpi-big" id="traffic-total-text">—</div>
    </div>

    <div class="traffic-card">
      <div class="traffic-header">Hourly Traffic</div>
      <div class="traffic-card-pad" style="height:360px;">
        <canvas id="traffic-bar-hourly"></canvas>
      </div>
    </div>
  </div>

  <!-- ROW 2: Applications + Remote Hosts -->
  <div class="traffic-row two" style="margin-top:18px;">

    <!-- Applications -->
    <div class="traffic-card">
      <div class="traffic-header">Applications</div>
      <div class="traffic-card-pad traffic-vert">
        <div class="traffic-donut-shell">
          <canvas id="traffic-donut-apps" width="220" height="220"></canvas>
        </div>
        <div class="traffic-legend" id="traffic-legend-apps"></div>
        <div class="traffic-filter-bar"><input id="traffic-filter-apps" placeholder="Filter…"></div>

        <div class="traffic-table-wrap">
          <table class="traffic-table" id="traffic-table-apps">
            <thead><tr><th>Application</th><th>Traffic</th></tr></thead><tbody></tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="traffic-pagination" id="traffic-pager-apps"></div>
      </div>
    </div>

    <!-- Remote Hosts -->
    <div class="traffic-card">
      <div class="traffic-header">Remote Hosts</div>
      <div class="traffic-card-pad traffic-vert">
        <div class="traffic-donut-shell">
          <canvas id="traffic-donut-hosts" width="220" height="220"></canvas>
        </div>
        <div class="traffic-legend" id="traffic-legend-hosts"></div>
        <div class="traffic-filter-bar"><input id="traffic-filter-hosts" placeholder="Filter…"></div>

        <div class="traffic-table-wrap">
          <table class="traffic-table" id="traffic-table-hosts">
            <thead><tr><th>Host</th><th>Traffic</th></tr></thead><tbody></tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="traffic-pagination" id="traffic-pager-hosts"></div>
      </div>
    </div>
  </div>

  <!-- ROW 3: Protocols + Clients -->
  <div class="traffic-row two" style="margin-top:18px;">

    <!-- Protocols -->
    <div class="traffic-card">
      <div class="traffic-header">Protocols</div>
      <div class="traffic-card-pad traffic-vert">
        <div class="traffic-donut-shell">
          <canvas id="traffic-donut-protos" width="220" height="220"></canvas>
        </div>
        <div class="traffic-legend" id="traffic-legend-protos"></div>
        <div class="traffic-filter-bar"><input id="traffic-filter-protos" placeholder="Filter…"></div>

        <div class="traffic-table-wrap">
          <table class="traffic-table" id="traffic-table-protos">
            <thead><tr><th>Protocol</th><th>Traffic</th></tr></thead><tbody></tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="traffic-pagination" id="traffic-pager-protos"></div>
      </div>
    </div>

    <!-- Clients (combined IPv4+IPv6) -->
    <div class="traffic-card">
      <div class="traffic-header">Clients</div>
      <div class="traffic-card-pad traffic-vert">
        <div class="traffic-donut-shell">
          <canvas id="traffic-donut-clients" width="220" height="220"></canvas>
        </div>
        <div class="traffic-legend" id="traffic-legend-clients"></div>
        <div class="traffic-filter-bar"><input id="traffic-filter-clients" placeholder="Filter…"></div>

        <div class="traffic-table-wrap">
          <table class="traffic-table" id="traffic-table-clients">
            <thead><tr><th>Client</th><th>Traffic</th></tr></thead><tbody></tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="traffic-pagination" id="traffic-pager-clients"></div>
      </div>
    </div>
  </div>

</div>

<script>
(() => {
  /* ---------- Data ingest ---------- */
  const raw = JSON.parse(document.getElementById('traffic-data').textContent || '{}');
  const dpi = raw.dpi_summery_v2 || {};
  const hourlyPairs = Array.isArray(dpi.hourly_traffic) ? dpi.hourly_traffic : [];
  const apps   = Array.isArray(dpi.applications) ? dpi.applications : [];
  const hosts  = Array.isArray(dpi.remote_hosts) ? dpi.remote_hosts : [];
  const protos = Array.isArray(dpi.protocols) ? dpi.protocols : [];
  const clients= Array.isArray(dpi.clients) ? dpi.clients : [];
  const totalBytes = Number(dpi.total_traffic || 0);

  /* ---------- Utils ---------- */
  const colors = ["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#22c55e","#0ea5e9","#a78bfa","#f97316","#14b8a6","#eab308","#f43f5e"];
  const fmtBytes = (b)=>{const n=Number(b)||0,KB=1024,MB=KB*1024,GB=MB*1024;if(n>=GB)return(n/GB).toFixed(2)+" GB";if(n>=MB)return(n/MB).toFixed(2)+" MB";if(n>=KB)return(n/KB).toFixed(2)+" KB";return n+" B"};
  const toGB = (b)=>(Number(b)||0)/(1024**3);
  const sumTraffic=(arr)=>arr.reduce((s,x)=>s+Number(x.traffic||0),0);

  const hours=Array.from({length:24},(_,i)=>(i<10?"0":"")+i+":00");
  const byHour=Array.from({length:24},()=>0);
  for(const p of hourlyPairs){const h=parseInt(p.id,10);if(!isNaN(h)&&h>=0&&h<24)byHour[h]=Number(p.traffic||0);}

  /* ---------- Center text plugin for total donut ---------- */
  const centerTextPlugin={
    id:'trafficCenterText',
    afterDraw(chart,args,opts){
      const {ctx,chartArea}=chart;if(!chartArea)return;
      const {left,top,width,height}=chartArea;
      ctx.save();ctx.font='bold 22px system-ui,-apple-system,Segoe UI,Roboto,Arial';ctx.fillStyle='#111827';
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(opts.text,left+width/2,top+height/2);ctx.restore();
    }
  };

  /* ---------- Total donut ---------- */
  const totalGB=toGB(totalBytes);
  document.getElementById('traffic-total-text').textContent = "Today's Traffic";
  new Chart(document.getElementById('traffic-donut-total'),{
    type:'doughnut',
    data:{datasets:[{data:[totalGB,Math.max(0.01,1-(totalGB%1))],backgroundColor:["#60a5fa","#f3f4f6"],borderWidth:0}]},
    options:{responsive:false,maintainAspectRatio:false,cutout:"72%",plugins:{legend:{display:false},tooltip:{enabled:false},trafficCenterText:{text:totalGB.toFixed(2)+" GB"}}},
    plugins:[centerTextPlugin]
  });

  /* ---------- Hourly bar ---------- */
  new Chart(document.getElementById('traffic-bar-hourly'),{
    type:'bar',
    data:{labels:hours,datasets:[{label:"Hourly (GB)",data:byHour.map(toGB),backgroundColor:"#60a5fa",borderRadius:6,maxBarThickness:22}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{grid:{display:false},ticks:{autoSkip:true,maxTicksLimit:12}},y:{beginAtZero:true,grid:{color:"#eef2f7"}}}}
  });

  /* ---------- Donut + legend builder ---------- */
  function buildDonut(elCanvas,list,labelKey,legendEl,noteEl,topN=6){
    const sorted=[...list].sort((a,b)=>(b.traffic||0)-(a.traffic||0));
    const top=sorted.slice(0,topN);
    const others=sorted.slice(topN);
    const othersSum=others.reduce((s,x)=>s+Number(x.traffic||0),0);
    if(othersSum>0) top.push({[labelKey]:"Other",id:"other",traffic:othersSum,label:"Other"});
    const labels=top.map(x=>x.label||x[labelKey]||x.id);
    const data=top.map(x=>Number(x.traffic||0));
    const total=data.reduce((s,v)=>s+v,0)||1;

    new Chart(elCanvas,{
      type:'doughnut',
      data:{labels,datasets:[{data,backgroundColor:labels.map((_,i)=>colors[i%colors.length]),borderWidth:0}]},
      options:{responsive:false,maintainAspectRatio:false,cutout:"65%",
        plugins:{legend:{display:false},
          tooltip:{callbacks:{label:(ctx)=>{const v=ctx.parsed||0;const pct=(v/total*100).toFixed(1);return `${ctx.label}: ${fmtBytes(v)} (${pct}%)`;}}}}}
    });

    legendEl.innerHTML="";
    labels.forEach((name,i)=>{
      const d=document.createElement('div');
      d.className='traffic-legend-item';
      d.innerHTML=`<span class="traffic-swatch" style="background:${colors[i%colors.length]}"></span>${name}`;
      legendEl.appendChild(d);
    });

    if(noteEl) noteEl.textContent=`Total: ${fmtBytes(total)} • ${labels.length-(othersSum>0?1:0)} top items${othersSum>0?" (+ Other)":""}`;
  }

  /* ---------- Pagination helpers ---------- */
  function makePager({rootId, rows, nameKey, tableBodySel, filterInputSel, perPage=8}) {
    const pagerEl = document.getElementById(rootId);
    const tbody = document.querySelector(tableBodySel);
    const filterInput = document.querySelector(filterInputSel);

    let state = {
      all: rows,
      filtered: rows,
      page: 1,
      perPage
    };

    function pageCount(){ return Math.max(1, Math.ceil(state.filtered.length / state.perPage)); }
    function clampPage(){ state.page = Math.min(Math.max(1, state.page), pageCount()); }

    function renderTable(){
      clampPage();
      const start = (state.page-1)*state.perPage;
      const end = start + state.perPage;
      const slice = state.filtered.slice(start, end);

      tbody.innerHTML = "";
      slice.forEach(r=>{
        const tr=document.createElement('tr');
        const name=r.label || r[nameKey] || r.id;
        tr.innerHTML = `<td>${name}</td><td>${fmtBytes(r.traffic||0)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderPager(){
      const totalRows = state.filtered.length;
      const pc = pageCount();

      pagerEl.innerHTML = `
        <span class="traffic-page-info">Page ${state.page} of ${pc} — ${totalRows} ${totalRows===1?'row':'rows'}</span>
        <div class="traffic-page-controls">
          <select id="${rootId}-rpp">
            <option ${state.perPage===6?'selected':''}>6</option>
            <option ${state.perPage===12?'selected':''}>12</option>
            <option ${state.perPage===18?'selected':''}>18</option>
          </select>
          <button id="${rootId}-prev" ${state.page<=1?'disabled':''}>Prev</button>
          <button id="${rootId}-next" ${state.page>=pc?'disabled':''}>Next</button>
        </div>
      `;

      // hook controls
      pagerEl.querySelector(`#${rootId}-rpp`).onchange = (e)=>{
        state.perPage = parseInt(e.target.value,10) || 8;
        state.page = 1;
        renderTable(); renderPager();
      };
      pagerEl.querySelector(`#${rootId}-prev`).onclick = ()=>{
        if(state.page>1){ state.page--; renderTable(); renderPager(); }
      };
      pagerEl.querySelector(`#${rootId}-next`).onclick = ()=>{
        if(state.page<pageCount()){ state.page++; renderTable(); renderPager(); }
      };
    }

    function applyFilter(){
      const q = (filterInput?.value || "").trim().toLowerCase();
      state.filtered = q
        ? state.all.filter(r => String(r.label || r[nameKey] || r.id || "").toLowerCase().includes(q))
        : state.all;
      state.page = 1;
      renderTable(); renderPager();
    }

    // initial render
    applyFilter();
    if (filterInput) filterInput.addEventListener('input', applyFilter);

    // expose a tiny API if ever needed
    return { refresh: applyFilter };
  }

  /* ---------- Wire donuts ---------- */
  buildDonut(document.getElementById('traffic-donut-apps'),apps,"id",
             document.getElementById('traffic-legend-apps'),document.getElementById('traffic-note-apps'),6);

  buildDonut(document.getElementById('traffic-donut-hosts'),hosts,"id",
             document.getElementById('traffic-legend-hosts'),document.getElementById('traffic-note-hosts'),6);

  buildDonut(document.getElementById('traffic-donut-protos'),protos,"id",
             document.getElementById('traffic-legend-protos'),document.getElementById('traffic-note-protos'),6);

  buildDonut(document.getElementById('traffic-donut-clients'),clients,"id",
             document.getElementById('traffic-legend-clients'),document.getElementById('traffic-note-clients'),6);

  /* ---------- Wire tables + pagination (dynamic) ---------- */
  makePager({
    rootId: 'traffic-pager-apps',
    rows: [...apps].sort((a,b)=>(b.traffic||0)-(a.traffic||0)),
    nameKey: 'id',
    tableBodySel: '#traffic-table-apps tbody',
    filterInputSel: '#traffic-filter-apps',
    perPage: 6
  });

  makePager({
    rootId: 'traffic-pager-hosts',
    rows: [...hosts].sort((a,b)=>(b.traffic||0)-(a.traffic||0)),
    nameKey: 'id',
    tableBodySel: '#traffic-table-hosts tbody',
    filterInputSel: '#traffic-filter-hosts',
    perPage: 6
  });

  makePager({
    rootId: 'traffic-pager-protos',
    rows: [...protos].sort((a,b)=>(b.traffic||0)-(a.traffic||0)),
    nameKey: 'id',
    tableBodySel: '#traffic-table-protos tbody',
    filterInputSel: '#traffic-filter-protos',
    perPage: 6
  });

  makePager({
    rootId: 'traffic-pager-clients',
    rows: [...clients].sort((a,b)=>(b.traffic||0)-(a.traffic||0)),
    nameKey: 'id',
    tableBodySel: '#traffic-table-clients tbody',
    filterInputSel: '#traffic-filter-clients',
    perPage: 6
  });

})();
</script>
