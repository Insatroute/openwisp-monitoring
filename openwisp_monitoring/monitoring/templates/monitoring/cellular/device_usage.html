{% load i18n static %}
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<style>
  .dashboard-contain {
    /* max-width: 1200px; */
    margin: 20px auto
  }

  #apiError {
    display: none;
    color: #b91c1c;
    background: #fee2e2;
    border: 1px solid #fecaca;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px
  }

  .usage-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 30px
  }

  .usage-section {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
  }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb
  }

  #lastUpdated {
    font-size: 11px;
    color: #6b7280;
    margin-left: 6px
  }

  .total-summary {
    margin-bottom: 16px
  }

  .total-value {
    font-size: 28px;
    font-weight: 700;
    color: #059669;
    margin-bottom: 6px
  }

  .total-stats {
    font-size: 13px;
    color: #6b7280;
    line-height: 1.6
  }

  .interface-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px
  }

  .interface-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px
  }

  .interface-title {
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px
  }

  .interface-value {
    color: #111827;
    margin-bottom: 4px
  }

  .interface-stats {
    font-size: 12px;
    color: #6b7280;
    line-height: 1.5
  }

  .chart-container {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
  }

  .chart-title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 16px
  }

  .chart-title {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin: 0
  }

  #trafficCharts {
    width: 100%;
    max-width: 920px;
    margin: 0 auto;
    height: 380px
  }

  @media (max-width:900px) {
    .usage-grid {
      grid-template-columns: 1fr;
      gap: 16px
    }

    .interface-grid {
      grid-template-columns: 1fr
    }
  }

  @media (min-width:901px) and (max-width:1200px) {
    .usage-grid {
      grid-template-columns: repeat(2, 1fr)
    }
  }
  
</style>

{{ device_data|json_script:"device-usage-data" }}

<div class="dashboard-contain">
  <h1>Device Usage Information</h1>
  <div id="apiError"></div>

  <div class="usage-grid">
    <!-- Cellular -->
    <div class="usage-section">
      <div class="section-title">
        Cellular <span id="lastUpdated"></span>
      </div>
      <div class="total-summary" id="cellular-total-summary">
        <div class="total-value">—</div>
        <div class="total-stats">Upload: —<br>Download: —</div>
      </div>
      <div class="interface-grid">
        <div class="interface-card" id="modem1-card">
          <div class="interface-title">SIM1:</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
        <div class="interface-card" id="modem2-card">
          <div class="interface-title">SIM2:</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
      </div>
    </div>

    <!-- Wired -->
    <div class="usage-section">
      <div class="section-title">Wired</div>
      <div class="total-summary" id="wired-total-summary">
        <div class="total-value">—</div>
        <div class="total-stats">Upload: —<br>Download: —</div>
      </div>
      <div class="interface-grid">
        <div class="interface-card" id="eth0-card">
          <div class="interface-title">WAN1 (eth0):</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
        <div class="interface-card" id="eth1-card">
          <div class="interface-title">WAN2 (eth1):</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
      </div>
    </div>

    <!-- Wireless (placeholder until you have real values) -->
    <div class="usage-section">
      <div class="section-title">Wireless</div>
      <div class="total-summary" id="wireless-total-summary">
        <div class="total-value">40.00 MB</div>
        <div class="total-stats">Upload: 35.00 MB<br>Download: 5.00 MB</div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="chart-container">
    <div class="chart-title-row">
      <h3 class="chart-title">Data Usage Traffic</h3>
    </div>
    <div id="trafficCharts"></div>
  </div>
</div>

<script>
  (function () {
    'use strict';

    /* ---------- Get your server-provided JSON ---------- */
    const scriptEl = document.getElementById('device-usage-data');
    let source = {};
    try { source = scriptEl ? JSON.parse(scriptEl.textContent || '{}') : {}; } catch (_) { source = {}; }
    console.log('DJ_Source_Usage: ========', source);
    const ifaces = Array.isArray(source.interfaces) ? source.interfaces : [];
    const general = source.general || {};

    /* ---------- Helpers ---------- */
    const MB = 1024 * 1024;
    const toMB = v => (Number(v) || 0) / MB;

    // Format as MB or GB depending on size
    function fmtData(mb) {
      const v = Number(mb) || 0;
      if (v >= 1024) {
        return (v / 1024).toFixed(2) + ' GB';
      }
      return v.toFixed(2) + ' MB';
    }

    // Accept both shapes:
    // 1) statistics.rx_bytes / tx_bytes
    // 2) statistics.rx.bytes / tx.bytes
    function readStatsMB(iface) {
      if (!iface || !iface.statistics) return { rxMB: 0, txMB: 0, totalMB: 0 };
      const rx = (iface.statistics.rx_bytes != null)
        ? iface.statistics.rx_bytes
        : (iface.statistics.rx && iface.statistics.rx.bytes) || 0;
      const tx = (iface.statistics.tx_bytes != null)
        ? iface.statistics.tx_bytes
        : (iface.statistics.tx && iface.statistics.tx.bytes) || 0;
      const rxMB = toMB(rx);
      const txMB = toMB(tx);
      return { rxMB, txMB, totalMB: rxMB + txMB };
    }

    const get = (name) => ifaces.find(i => i && i.name === name);

    function formatTimeLabel(iso) {
      if (!iso) return new Date().toLocaleTimeString();
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      const pad = n => n.toString().padStart(2, '0');
      return pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
    }

    // Round a date string to the beginning of the hour
    function getHourStart(iso) {
      const d = iso ? new Date(iso) : new Date();
      if (isNaN(d.getTime())) return new Date();
      return new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), 0, 0, 0);
    }

    function formatHourLabel(isoHour) {
      const d = new Date(isoHour);
      if (isNaN(d.getTime())) return isoHour;
      const pad = n => n.toString().padStart(2, '0');
      return pad(d.getHours()) + ':00';
    }

    /* ---------- Compute sections ---------- */
    // Cellular: SIM1 = "modem", SIM2 = "modem2"
    const sim1 = readStatsMB(get('modem'));
    const sim2 = readStatsMB(get('modem2'));

    // Wired: eth0 + eth1 if present
    const eth0 = readStatsMB(get('eth0'));
    const eth1 = readStatsMB(get('eth1'));

    const cellularUp = sim1.txMB + sim2.txMB;
    const cellularDown = sim1.rxMB + sim2.rxMB;
    const wiredUp = eth0.txMB + eth1.txMB;
    const wiredDown = eth0.rxMB + eth1.rxMB;

    // Wireless placeholder values (in MB already)
    const wirelessUp = 35.0;
    const wirelessDown = 5.0;

    /* ---------- Fill cards (with MB/GB) ---------- */
    const lastUpdated = document.getElementById('lastUpdated');
    if (lastUpdated) {
      const label = general.local_time ? formatTimeLabel(general.local_time) : new Date().toLocaleTimeString();
      lastUpdated.textContent = `(Updated: ${label})`;
    }

    const sim1Card = document.getElementById('modem1-card');
    if (sim1Card) {
      sim1Card.querySelector('.interface-value').textContent = fmtData(sim1.totalMB);
      sim1Card.querySelector('.interface-stats').innerHTML =
        `Upload: ${fmtData(sim1.txMB)}<br>Download: ${fmtData(sim1.rxMB)}`;
    }

    const sim2Card = document.getElementById('modem2-card');
    if (sim2Card) {
      sim2Card.querySelector('.interface-value').textContent = fmtData(sim2.totalMB);
      sim2Card.querySelector('.interface-stats').innerHTML =
        `Upload: ${fmtData(sim2.txMB)}<br>Download: ${fmtData(sim2.rxMB)}`;
    }

    const cellularSummary = document.getElementById('cellular-total-summary');
    if (cellularSummary) {
      const total = cellularUp + cellularDown;
      cellularSummary.querySelector('.total-value').textContent = fmtData(total);
      cellularSummary.querySelector('.total-stats').innerHTML =
        `Upload: ${fmtData(cellularUp)}<br>Download: ${fmtData(cellularDown)}`;
    }

    const eth0Card = document.getElementById('eth0-card');
    if (eth0Card) {
      eth0Card.querySelector('.interface-value').textContent = fmtData(eth0.totalMB);
      eth0Card.querySelector('.interface-stats').innerHTML =
        `Upload: ${fmtData(eth0.txMB)}<br>Download: ${fmtData(eth0.rxMB)}`;
    }

    const eth1Card = document.getElementById('eth1-card');
    if (eth1Card) {
      eth1Card.querySelector('.interface-value').textContent = fmtData(eth1.totalMB);
      eth1Card.querySelector('.interface-stats').innerHTML =
        `Upload: ${fmtData(eth1.txMB)}<br>Download: ${fmtData(eth1.rxMB)}`;
    }

    const wiredSummary = document.getElementById('wired-total-summary');
    if (wiredSummary) {
      const total = wiredUp + wiredDown;
      wiredSummary.querySelector('.total-value').textContent = fmtData(total);
      wiredSummary.querySelector('.total-stats').innerHTML =
        `Upload: ${fmtData(wiredUp)}<br>Download: ${fmtData(wiredDown)}`;
    }

    const wirelessSummary = document.getElementById('wireless-total-summary');
    if (wirelessSummary) {
      const totalWireless = wirelessUp + wirelessDown;
      wirelessSummary.querySelector('.total-value').textContent = fmtData(totalWireless);
      wirelessSummary.querySelector('.total-stats').innerHTML =
        `Upload: ${fmtData(wirelessUp)}<br>Download: ${fmtData(wirelessDown)}`;
    }

    /* ---------- Build / store HOURLY history for chart (in MB) ---------- */
    const totals = {
      cellular: cellularUp + cellularDown,
      wired: wiredUp + wiredDown,
      wireless: wirelessUp + wirelessDown
    };

    const serial = general.serialnumber || 'default';
    const HISTORY_KEY = 'device_usage_hourly_' + serial;
    const MAX_HOURS = 50; // keep last 50 hourly buckets

    let hourly = [];
    try {
      hourly = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      if (!Array.isArray(hourly) || (hourly[0] && typeof hourly[0].hour === 'undefined')) {
        hourly = [];
      }
    } catch (e) {
      hourly = [];
    }

    // Determine the current hour bucket
    const hourStartDate = getHourStart(general.local_time);
    const hourKey = hourStartDate.toISOString();

    // Find or create bucket for this hour, then ADD the current totals (still in MB)
    let bucket = hourly.find(h => h.hour === hourKey);
    if (!bucket) {
      bucket = {
        hour: hourKey,
        cellular: 0,
        wired: 0,
        wireless: 0
      };
      hourly.push(bucket);
    }
    bucket.cellular += totals.cellular;
    bucket.wired += totals.wired;
    bucket.wireless += totals.wireless;

    // Sort by hour ascending
    hourly.sort((a, b) => new Date(a.hour) - new Date(b.hour));

    // keep only last MAX_HOURS buckets
    if (hourly.length > MAX_HOURS) {
      hourly = hourly.slice(hourly.length - MAX_HOURS);
    }

    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(hourly));
    } catch (e) {
      console.warn('Unable to save hourly usage history:', e);
    }

    const labels = hourly.map(h => formatHourLabel(h.hour));

    /* ---------- Decide chart unit: MB or GB ---------- */
    let maxMB = 0;
    hourly.forEach(h => {
      maxMB = Math.max(maxMB, h.cellular, h.wired, h.wireless);
    });

    let unitLabel = 'MB';
    let unitFactor = 1; // multiply MB by this to get chart values
    if (maxMB >= 1024) {
      unitLabel = 'GB';
      unitFactor = 1 / 1024; // convert MB -> GB
    }

    const cellularSeries = hourly.map(h => h.cellular * unitFactor);
    const wiredSeries = hourly.map(h => h.wired * unitFactor);
    const wirelessSeries = hourly.map(h => h.wireless * unitFactor);

    /* ---------- Data Usage Traffic chart: X axis = 1-hour buckets ---------- */
    const traces = [
      {
        type: 'bar',
        name: 'Cellular',
        x: labels,
        y: cellularSeries,
        marker: { color: '#2ca02c' },
        hovertemplate: `Cellular<br>Hour: %{x}<br>Total: %{y:.2f} ${unitLabel}<extra></extra>`
      },
      {
        type: 'bar',
        name: 'Wired',
        x: labels,
        y: wiredSeries,
        marker: { color: '#ff7f0e' },
        hovertemplate: `Wired<br>Hour: %{x}<br>Total: %{y:.2f} ${unitLabel}<extra></extra>`
      },
      {
        type: 'bar',
        name: 'Wireless',
        x: labels,
        y: wirelessSeries,
        marker: { color: '#1f77b4' },
        hovertemplate: `Wireless<br>Hour: %{x}<br>Total: %{y:.2f} ${unitLabel}<extra></extra>`
      }
    ];

    const layout = {
      barmode: 'stack',
      bargap: 0.7,
      bargroupgap: 0.8,
      margin: { l: 60, r: 20, t: 10, b: 60 },
      xaxis: { title: 'Time (per hour)', automargin: true },
      yaxis: { title: `${unitLabel} (hourly total)`, rangemode: 'tozero', automargin: true },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      legend: { orientation: 'h', yanchor: 'top', y: -0.25, x: 0.5, xanchor: 'center' }
    };

    Plotly.newPlot('trafficCharts', traces, layout, {
      displaylogo: false,
      responsive: true,
      modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d'],
      displayModeBar: false,
    });

  })();
</script>