{% load i18n static %}
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<style>
  .dashboard-contain {
    max-width: 1200px;
    margin: 20px auto
  }

  #apiError {
    display: none;
    color: #b91c1c;
    background: #fee2e2;
    border: 1px solid #fecaca;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px
  }

  .usage-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 30px
  }

  .usage-section {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
  }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb
  }

  #lastUpdated {
    font-size: 11px;
    color: #6b7280;
    margin-left: 6px
  }

  .total-summary {
    margin-bottom: 16px
  }

  .total-value {
    font-size: 28px;
    font-weight: 700;
    color: #059669;
    margin-bottom: 6px
  }

  .total-stats {
    font-size: 13px;
    color: #6b7280;
    line-height: 1.6
  }

  .interface-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px
  }

  .interface-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px
  }

  .interface-title {
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px
  }

  .interface-value {
    color: #111827;
    margin-bottom: 4px
  }

  .interface-stats {
    font-size: 12px;
    color: #6b7280;
    line-height: 1.5
  }

  .chart-container {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
  }

  .chart-title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 16px
  }

  .chart-title {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin: 0
  }

  #trafficCharts {
    width: 100%;
    max-width: 920px;
    margin: 0 auto;
    height: 380px
  }

  @media (max-width:900px) {
    .usage-grid {
      grid-template-columns: 1fr;
      gap: 16px
    }

    .interface-grid {
      grid-template-columns: 1fr
    }
  }

  @media (min-width:901px) and (max-width:1200px) {
    .usage-grid {
      grid-template-columns: repeat(2, 1fr)
    }
  }
</style>

{{ device_data|json_script:"device-usage-data" }}

<div class="dashboard-contain">
  <h1>Device Usage Information</h1>
  <div id="apiError"></div>

  <div class="usage-grid">
    <!-- Cellular -->
    <div class="usage-section">
      <div class="section-title">
        Cellular <span id="lastUpdated"></span>
      </div>
      <div class="total-summary" id="cellular-total-summary">
        <div class="total-value">—</div>
        <div class="total-stats">Upload: —<br>Download: —</div>
      </div>
      <div class="interface-grid">
        <div class="interface-card" id="modem1-card">
          <div class="interface-title">SIM1:</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
        <div class="interface-card" id="modem2-card">
          <div class="interface-title">SIM2:</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
      </div>
    </div>

    <!-- Wired -->
    <div class="usage-section">
      <div class="section-title">Wired</div>
      <div class="total-summary" id="wired-total-summary">
        <div class="total-value">—</div>
        <div class="total-stats">Upload: —<br>Download: —</div>
      </div>
      <div class="interface-grid">
        <div class="interface-card" id="eth0-card">
          <div class="interface-title">WAN1 (eth0):</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
        <div class="interface-card" id="eth1-card">
          <div class="interface-title">WAN2 (eth1):</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
      </div>
    </div>

    <!-- Wireless (placeholder until you have real values) -->
    <div class="usage-section">
      <div class="section-title">Wireless</div>
      <div class="total-summary" id="wireless-total-summary">
        <div class="total-value">40.00 MB</div>
        <div class="total-stats">Upload: 35.00 MB<br>Download: 5.00 MB</div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="chart-container">
    <div class="chart-title-row">
      <h3 class="chart-title">General Traffic</h3>
    </div>
    <div id="trafficCharts"></div>
  </div>
</div>

<script>
  (function () {
    'use strict';

    /* ---------- Get your server-provided JSON ---------- */
    const scriptEl = document.getElementById('device-usage-data');
    let source = {};
    try { source = scriptEl ? JSON.parse(scriptEl.textContent || '{}') : {}; } catch (_) { source = {}; }
    console.log('DJ_Source_Usage: ========', source);
    const ifaces = Array.isArray(source.interfaces) ? source.interfaces : [];

    /* ---------- Helpers ---------- */
    const MB = 1024 * 1024;
    const toMB = v => (Number(v) || 0) / MB;
    const fmtMB = n => `${(Number(n) || 0).toFixed(2)} MB`;

    // Accept both shapes:
    // 1) statistics.rx_bytes / tx_bytes
    // 2) statistics.rx.bytes / tx.bytes
    function readStatsMB(iface) {
      if (!iface || !iface.statistics) return { rxMB: 0, txMB: 0, totalMB: 0 };
      const rx = (iface.statistics.rx_bytes != null)
        ? iface.statistics.rx_bytes
        : (iface.statistics.rx && iface.statistics.rx.bytes) || 0;
      const tx = (iface.statistics.tx_bytes != null)
        ? iface.statistics.tx_bytes
        : (iface.statistics.tx && iface.statistics.tx.bytes) || 0;
      const rxMB = toMB(rx);
      const txMB = toMB(tx);
      return { rxMB, txMB, totalMB: rxMB + txMB };
    }

    const get = (name) => ifaces.find(i => i && i.name === name);

    /* ---------- Compute sections ---------- */
    // Cellular: SIM1 = "modem", SIM2 = "modem2"
    const sim1 = readStatsMB(get('modem'));
    const sim2 = readStatsMB(get('modem2'));

    // Wired: eth0 + eth1 if present
    const eth0 = readStatsMB(get('eth0'));
    const eth1 = readStatsMB(get('eth1'));

    const cellularUp = sim1.txMB + sim2.txMB;
    const cellularDown = sim1.rxMB + sim2.rxMB;
    const wiredUp = eth0.txMB + eth1.txMB;
    const wiredDown = eth0.rxMB + eth1.rxMB;

    /* ---------- Fill cards ---------- */
    const lastUpdated = document.getElementById('lastUpdated');
    if (lastUpdated) lastUpdated.textContent = `(Updated: ${new Date().toLocaleTimeString()})`;

    const sim1Card = document.getElementById('modem1-card');
    if (sim1Card) {
      sim1Card.querySelector('.interface-value').textContent = fmtMB(sim1.totalMB);
      sim1Card.querySelector('.interface-stats').innerHTML =
        `Upload: ${fmtMB(sim1.txMB)}<br>Download: ${fmtMB(sim1.rxMB)}`;
    }

    const sim2Card = document.getElementById('modem2-card');
    if (sim2Card) {
      sim2Card.querySelector('.interface-value').textContent = fmtMB(sim2.totalMB);
      sim2Card.querySelector('.interface-stats').innerHTML =
        `Upload: ${fmtMB(sim2.txMB)}<br>Download: ${fmtMB(sim2.rxMB)}`;
    }

    const cellularSummary = document.getElementById('cellular-total-summary');
    if (cellularSummary) {
      const total = cellularUp + cellularDown;
      cellularSummary.querySelector('.total-value').textContent = fmtMB(total);
      cellularSummary.querySelector('.total-stats').innerHTML =
        `Upload: ${fmtMB(cellularUp)}<br>Download: ${fmtMB(cellularDown)}`;
    }

    const eth0Card = document.getElementById('eth0-card');
    if (eth0Card) {
      eth0Card.querySelector('.interface-value').textContent = fmtMB(eth0.totalMB);
      eth0Card.querySelector('.interface-stats').innerHTML =
        `Upload: ${fmtMB(eth0.txMB)}<br>Download: ${fmtMB(eth0.rxMB)}`;
    }

    const eth1Card = document.getElementById('eth1-card');
    if (eth1Card) {
      eth1Card.querySelector('.interface-value').textContent = fmtMB(eth1.totalMB);
      eth1Card.querySelector('.interface-stats').innerHTML =
        `Upload: ${fmtMB(eth1.txMB)}<br>Download: ${fmtMB(eth1.rxMB)}`;
    }

    const wiredSummary = document.getElementById('wired-total-summary');
    if (wiredSummary) {
      const total = wiredUp + wiredDown;
      wiredSummary.querySelector('.total-value').textContent = fmtMB(total);
      wiredSummary.querySelector('.total-stats').innerHTML =
        `Upload: ${fmtMB(wiredUp)}<br>Download: ${fmtMB(wiredDown)}`;
    }

    /* ---------- General Traffic chart (single stacked bar) ---------- */
    const wirelessUp = 35.0;   // placeholder until you wire real values
    const wirelessDown = 5.0;  // placeholder
    const totals = {
      cellular: cellularUp + cellularDown,
      wired: wiredUp + wiredDown,
      wireless: wirelessUp + wirelessDown
    };

    const traces = [
      {
        type: 'bar', name: 'Cellular', x: ['Total'], y: [totals.cellular], marker: { color: '#2ca02c' },
        hovertemplate: 'Cellular<br>Total: %{y:.2f} MB<extra></extra>'
      },
      {
        type: 'bar', name: 'Wired', x: ['Total'], y: [totals.wired], marker: { color: '#ff7f0e' },
        hovertemplate: 'Wired<br>Total: %{y:.2f} MB<extra></extra>'
      },
      {
        type: 'bar', name: 'Wireless', x: ['Total'], y: [totals.wireless], marker: { color: '#1f77b4' },
        hovertemplate: 'Wireless<br>Total: %{y:.2f} MB<extra></extra>'
      }
    ];

    const layout = {
      barmode: 'stack',
      margin: { l: 60, r: 20, t: 10, b: 60 },
      xaxis: { title: 'Usage', automargin: true },
      yaxis: { title: 'MB', rangemode: 'tozero', automargin: true },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      legend: { orientation: 'h', yanchor: 'top', y: -0.25, x: 0.5, xanchor: 'center' }
    };

    Plotly.newPlot('trafficCharts', traces, layout, {
      displaylogo: false, responsive: true,
      modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d']
    });

  })();
</script>