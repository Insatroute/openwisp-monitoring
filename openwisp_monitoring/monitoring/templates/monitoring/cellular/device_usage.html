{% load i18n static %}
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<style>
  .dashboard-contain{max-width:1200px;margin:20px auto}
  #apiError{display:none;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:12px 16px;border-radius:8px;margin-bottom:20px;font-size:14px}
  .usage-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:30px}
  .usage-section{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
  .section-title{font-size:16px;font-weight:700;color:#111827;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #e5e7eb}
  #lastUpdated{font-size:11px;color:#6b7280;margin-left:6px}
  .total-summary{margin-bottom:16px}
  .total-value{font-size:28px;font-weight:700;color:#059669;margin-bottom:6px}
  .total-stats{font-size:13px;color:#6b7280;line-height:1.6}
  .interface-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .interface-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px}
  .interface-title{font-size:13px;font-weight:600;color:#374151;margin-bottom:6px}
  .interface-value{color:#111827;margin-bottom:4px}
  .interface-stats{font-size:12px;color:#6b7280;line-height:1.5}
  .chart-container{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
  .chart-title-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  .chart-title{font-size:16px;font-weight:700;color:#111827;margin:0}
  .chart-controls{display:flex;align-items:center;gap:8px}
  .range-select{border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;font-size:13px;background:#fff}
  #trafficCharts{width:100%;max-width:920px;margin:0 auto;height:380px}
  @media (max-width:900px){.usage-grid{grid-template-columns:1fr;gap:16px}.interface-grid{grid-template-columns:1fr}.chart-title-row{flex-direction:column;align-items:flex-start}}
  @media (min-width:901px) and (max-width:1200px){.usage-grid{grid-template-columns:repeat(2,1fr)}}
</style>

{{ device_data|json_script:"device-usage-data" }}

<div class="dashboard-contain">
  <h1>Device Usage Information</h1>
  <div id="apiError"></div>

  <div class="usage-grid">
    <!-- Cellular -->
    <div class="usage-section">
      <div class="section-title">
        Cellular <span id="lastUpdated"></span>
      </div>
      <div class="total-summary" id="cellular-total-summary">
        <div class="total-value">—</div>
        <div class="total-stats">Upload: —<br>Download: —</div>
      </div>
      <div class="interface-grid">
        <div class="interface-card" id="modem1-card">
          <div class="interface-title">SIM1:</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
        <div class="interface-card" id="modem2-card">
          <div class="interface-title">SIM2:</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
      </div>
    </div>

    <!-- Wired -->
    <div class="usage-section">
      <div class="section-title">Wired</div>
      <div class="total-summary" id="wired-total-summary">
        <div class="total-value">—</div>
        <div class="total-stats">Upload: —<br>Download: —</div>
      </div>
      <div class="interface-grid">
        <div class="interface-card" id="eth0-card">
          <div class="interface-title">WAN1 (eth0):</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
        <div class="interface-card" id="eth1-card">
          <div class="interface-title">WAN2 (eth1):</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
      </div>
    </div>

    <!-- Wireless -->
    <div class="usage-section">
      <div class="section-title">Wireless</div>
      <div class="total-summary" id="wireless-total-summary">
        <div class="total-value">40.00 MB</div>
        <div class="total-stats">Upload: 35.00 MB<br>Download: 5.00 MB</div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="chart-container">
    <div class="chart-title-row">
      <h3 class="chart-title">General Traffic</h3>
      <div class="chart-controls">
        <select id="rangeSelect" class="range-select" title="Time range">
          <option value="7">Last 7 days</option>
          <option value="15">Last 15 days</option>
          <option value="30" selected>Last 1 month</option>
          <option value="180">Last 6 months</option>
          <option value="365">Last 1 year</option>
        </select>
      </div>
    </div>
    <div id="trafficCharts"></div>
  </div>
</div>

<script>
  /* ---------- STATIC FALLBACK ---------- */
  // const FALLBACK_RESPONSE = {
  //   "type": "DeviceMonitoring",
  //   "general": {
  //     "serialnumber": "IRX400250500140",
  //     "local_time": 1762788233,
  //     "uptime": 665,
  //     "hostname": "SW-Dept-Test2"
  //   },
  //   "interfaces": [
  //     { "type": "mobile",   "name": "modem",  "statistics": { "rx_bytes": 22187150,  "tx_bytes": 45236625 } },
  //     { "type": "mobile",   "name": "modem2", "statistics": { "rx_bytes": 21218234,  "tx_bytes": 45236888 } },
  //     { "type": "ethernet", "name": "eth0",   "statistics": { "rx_bytes": 384568998, "tx_bytes": 49336767 } },
  //     { "type": "ethernet", "name": "eth1",   "statistics": { "rx_bytes": 86859089,  "tx_bytes": 249242488 } },
  //     { "type": "mobile", "name": "modem", "up": true,
  //       "mobile": { "operator_name": "Airtel","power_status": "on","operator_code": "40587","model": "EC25-AFW",
  //         "signal": { "lte": { "rsrq": -10, "rsrp": -97, "snr": 22, "csq": 31, "rssi": -51 } },
  //         "manufacturer": "Quectel","imei": "356789012345678","connection_status": "connected"}}
  //   ]
  // };

  /* ---------- Load source ---------- */
  const scriptEl = document.getElementById('device-usage-data');
  let source = {};
  try { source = scriptEl ? JSON.parse(scriptEl.textContent || '{}') : {}; } catch (_) {}
  // if (!source || !Array.isArray(source.interfaces) || !source.interfaces.length) source = FALLBACK_RESPONSE;

  /* ---------- Helpers ---------- */
  const BYTES_PER_MB = 1024 * 1024;
  const toMB  = v => (Number(v) || 0) / BYTES_PER_MB;
  const fmtMB = n => `${(Number(n) || 0).toFixed(2)} MB`;
  const findByName = (arr, name) => (arr || []).find(i => i && i.name === name) || null;
  const statsFrom = i => {
    if (!i || !i.statistics) return { rxMB:0, txMB:0, totalMB:0 };
    const rxMB = toMB(i.statistics.rx_bytes ?? i.statistics.rx?.bytes ?? 0);
    const txMB = toMB(i.statistics.tx_bytes ?? i.statistics.tx?.bytes ?? 0);
    return { rxMB, txMB, totalMB: rxMB + txMB };
  };
  const hourFloorMs = (epochSec) => {
    const d = new Date((Number(epochSec)||0) * 1000);
    if (isNaN(d.getTime())) return Date.now();
    d.setMinutes(0,0,0);
    return d.getTime();
  };

  /* ---------- Cards populate ---------- */
  const lastUpdated = document.getElementById('lastUpdated');
  if (lastUpdated) lastUpdated.textContent = `(Updated: ${new Date().toLocaleTimeString()})`;

  const ifaces = source.interfaces || [];
  const m1 = statsFrom(findByName(ifaces, 'modem'));
  const m2 = statsFrom(findByName(ifaces, 'modem2'));

  const modem1Card = document.getElementById('modem1-card');
  if (modem1Card) {
    modem1Card.querySelector('.interface-value').textContent = fmtMB(m1.totalMB);
    modem1Card.querySelector('.interface-stats').innerHTML =
      `Upload: ${fmtMB(m1.txMB)}<br>Download: ${fmtMB(m1.rxMB)}`;
  }
  const modem2Card = document.getElementById('modem2-card');
  if (modem2Card) {
    modem2Card.querySelector('.interface-value').textContent = fmtMB(m2.totalMB);
    modem2Card.querySelector('.interface-stats').innerHTML =
      `Upload: ${fmtMB(m2.txMB)}<br>Download: ${fmtMB(m2.rxMB)}`;
  }

  const cellularUp   = m1.txMB + m2.txMB;
  const cellularDown = m1.rxMB + m2.rxMB;
  const cellularTotalEl = document.getElementById('cellular-total-summary');
  if (cellularTotalEl) {
    cellularTotalEl.querySelector('.total-value').textContent = fmtMB(cellularUp + cellularDown);
    cellularTotalEl.querySelector('.total-stats').innerHTML =
      `Upload: ${fmtMB(cellularUp)}<br>Download: ${fmtMB(cellularDown)}`;
  }

  const e0 = statsFrom(findByName(ifaces, 'eth0'));
  const e1 = statsFrom(findByName(ifaces, 'eth1'));
  const eth0Card = document.getElementById('eth0-card');
  if (eth0Card) {
    eth0Card.querySelector('.interface-value').textContent = fmtMB(e0.totalMB);
    eth0Card.querySelector('.interface-stats').innerHTML =
      `Upload: ${fmtMB(e0.txMB)}<br>Download: ${fmtMB(e0.rxMB)}`;
  }
  const eth1Card = document.getElementById('eth1-card');
  if (eth1Card) {
    eth1Card.querySelector('.interface-value').textContent = fmtMB(e1.totalMB);
    eth1Card.querySelector('.interface-stats').innerHTML =
      `Upload: ${fmtMB(e1.txMB)}<br>Download: ${fmtMB(e1.rxMB)}`;
  }

  const wiredUp   = e0.txMB + e1.txMB;
  const wiredDown = e0.rxMB + e1.rxMB;
  const wiredTotalEl = document.getElementById('wired-total-summary');
  if (wiredTotalEl) {
    wiredTotalEl.querySelector('.total-value').textContent = fmtMB(wiredUp + wiredDown);
    wiredTotalEl.querySelector('.total-stats').innerHTML =
      `Upload: ${fmtMB(wiredUp)}<br>Download: ${fmtMB(wiredDown)}`;
  }

  // Static wireless card values (replace with real when available)
  const wirelessUp = 35.00, wirelessDown = 5.00;
  const wirelessTotalMB = wirelessUp + wirelessDown;

  /* ---------- Persist hourly series in localStorage ---------- */
  const STORAGE_KEY = 'du_usage_series_v1';
  const MAX_POINTS  = 24 * 365; // keep up to 1 year of hourly points (~8760)

  function loadSeries(){
    try{ const raw = localStorage.getItem(STORAGE_KEY); const arr = raw? JSON.parse(raw): []; return Array.isArray(arr)? arr: [] }catch(_){ return [] }
  }
  function saveSeries(arr){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)) }catch(_){} }
  function upsertPoint(series, pt){
    const i = series.findIndex(x => x.ts === pt.ts);
    if (i >= 0) series[i] = pt; else series.push(pt);
    series.sort((a,b)=>a.ts-b.ts);
    if (series.length > MAX_POINTS) series.splice(0, series.length - MAX_POINTS);
  }

  const epochSec = Number((source.general && source.general.local_time) || Date.now()/1000);
  const tsHour   = hourFloorMs(epochSec);

  const series = loadSeries();
  upsertPoint(series, {
    ts: tsHour,
    cellular: cellularUp + cellularDown,
    wired:    wiredUp + wiredDown,
    wireless: wirelessTotalMB
  });
  saveSeries(series);

  /* ---------- Filter + Chart ---------- */
  const rangeSelect = document.getElementById('rangeSelect');

  function computeTotals(days){
    const nowMs  = Date.now();
    const cutMs  = nowMs - (Number(days) * 24 * 60 * 60 * 1000);
    const pts    = series.filter(p => p.ts >= cutMs);
    // If nothing in range, show latest point if any
    const usePts = pts.length ? pts : (series.length ? [series[series.length-1]] : []);
    const sums = usePts.reduce((acc,p)=>{
      acc.cellular += Number(p.cellular)||0;
      acc.wired    += Number(p.wired)||0;
      acc.wireless += Number(p.wireless)||0;
      return acc;
    }, {cellular:0,wired:0,wireless:0});
    return sums;
  }

  function renderFor(days){
    const sums = computeTotals(days);
    const xLabel = ['Total'];
    const cellTrace = {
      type:'bar', name:'Cellular', x:xLabel, y:[sums.cellular],
      marker:{color:'#2ca02c'}, width:0.1,
      hovertemplate:'Cellular<br>Total: %{y:.2f} MB<extra></extra>'
    };
    const wiredTrace = {
      type:'bar', name:'Wired', x:xLabel, y:[sums.wired],
      marker:{color:'#ff7f0e'}, width:0.1,
      hovertemplate:'Wired<br>Total: %{y:.2f} MB<extra></extra>'
    };
    const wirelessTrace = {
      type:'bar', name:'Wireless', x:xLabel, y:[sums.wireless],
      marker:{color:'#1f77b4'}, width:0.1,
      hovertemplate:'Wireless<br>Total: %{y:.2f} MB<extra></extra>'
    };
    const layout = {
      barmode:'stack',
      margin:{l:60,r:20,t:10,b:60},
      xaxis:{title:'Usage', automargin:true},
      yaxis:{title:'MB', rangemode:'tozero', automargin:true},
      paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)',
      legend:{orientation:'h', yanchor:'top', y:-0.25, x:0.5, xanchor:'center'}
    };
    Plotly.newPlot('trafficCharts', [cellTrace, wiredTrace, wirelessTrace], layout, {
      displaylogo:false, responsive:true,
      modeBarButtonsToRemove:['select2d','lasso2d','autoScale2d']
    });
  }

  // initial render (default: 1 month)
  renderFor(rangeSelect.value);

  // re-render on change
  rangeSelect.addEventListener('change', () => renderFor(rangeSelect.value));
</script>
