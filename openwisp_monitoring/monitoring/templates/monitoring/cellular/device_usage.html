{% load i18n static %}
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<style>
  .dashboard-contain {
    max-width: 1200px;
    margin: 20px auto
  }

  #apiError {
    display: none;
    color: #b91c1c;
    background: #fee2e2;
    border: 1px solid #fecaca;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px
  }

  .usage-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 30px
  }

  .usage-section {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
  }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb
  }

  #lastUpdated {
    font-size: 11px;
    color: #6b7280;
    margin-left: 6px
  }

  .total-summary {
    margin-bottom: 16px
  }

  .total-value {
    font-size: 28px;
    font-weight: 700;
    color: #059669;
    margin-bottom: 6px
  }

  .total-stats {
    font-size: 13px;
    color: #6b7280;
    line-height: 1.6
  }

  .interface-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px
  }

  .interface-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px
  }

  .interface-title {
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px
  }

  .interface-value {
    color: #111827;
    margin-bottom: 4px
  }

  .interface-stats {
    font-size: 12px;
    color: #6b7280;
    line-height: 1.5
  }

  .chart-container {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, .1)
  }

  .chart-title {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin-bottom: 16px
  }

  #trafficCharts {
    width: 100%;
    max-width: 920px;
    margin: 0 auto;
    height: 380px
  }

  @media (max-width:900px) {
    .usage-grid {
      grid-template-columns: 1fr;
      gap: 16px
    }

    .interface-grid {
      grid-template-columns: 1fr
    }
  }

  @media (min-width:901px) and (max-width:1200px) {
    .usage-grid {
      grid-template-columns: repeat(2, 1fr)
    }
  }
</style>

{{ device_data|json_script:"device-usage-data" }}

<div class="dashboard-contain">
  <h1>Device Usage Information</h1>
  <div id="apiError"></div>

  <div class="usage-grid">
    <!-- Cellular -->
    <div class="usage-section">
      <div class="section-title">
        Cellular <span id="lastUpdated"></span>
      </div>
      <div class="total-summary" id="cellular-total-summary">
        <div class="total-value">—</div>
        <div class="total-stats">Upload: —<br>Download: —</div>
      </div>
      <div class="interface-grid">
        <div class="interface-card" id="modem1-card">
          <div class="interface-title">SIM1:</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
        <div class="interface-card" id="modem2-card">
          <div class="interface-title">SIM2:</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
      </div>
    </div>

    <!-- Wired -->
    <div class="usage-section">
      <div class="section-title">Wired</div>
      <div class="total-summary" id="wired-total-summary">
        <div class="total-value">—</div>
        <div class="total-stats">Upload: —<br>Download: —</div>
      </div>
      <div class="interface-grid">
        <div class="interface-card" id="eth0-card">
          <div class="interface-title">WAN1 (eth0):</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
        <div class="interface-card" id="eth1-card">
          <div class="interface-title">WAN2 (eth1):</div>
          <div class="interface-value">—</div>
          <div class="interface-stats">Upload: —<br>Download: —</div>
        </div>
      </div>
    </div>

    <!-- Wireless -->
    <div class="usage-section">
      <div class="section-title">Wireless</div>
      <div class="total-summary" id="wireless-total-summary">
        <div class="total-value">40.00 MB</div>
        <div class="total-stats">Upload: 35.00 MB<br>Download: 5.00 MB</div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="chart-container">
    <div class="chart-title">General Traffic</div>
    <div id="trafficCharts"></div>
  </div>
</div>

<script>
  /* ---------- STATIC FALLBACK (used only if device_data is missing/empty) ---------- */
  const FALLBACK_RESPONSE = {
    "type": "DeviceMonitoring",
    "interfaces": [
      { "type": "mobile", "name": "modem", "statistics": { "rx_bytes": 22187150, "tx_bytes": 45236625 } },
      { "type": "mobile", "name": "modem2", "statistics": { "rx_bytes": 21218234, "tx_bytes": 45236888 } },
      { "type": "ethernet", "name": "eth0", "statistics": { "rx_bytes": 384568998, "tx_bytes": 49336767 } },
      { "type": "ethernet", "name": "eth1", "statistics": { "rx_bytes": 86859089, "tx_bytes": 249242488 } },
      {
        "mobile": {
          "operator_name": "Airtel",
          "power_status": "on",
          "operator_code": "40587",
          "model": "EC25-AFW",
          "signal": {
            "lte": {
              "rsrq": -10,
              "rsrp": -97,
              "snr": 22,
              "csq": 31,
              "rssi": -51
            }
          },
          "manufacturer": "Quectel",
          "imei": "356789012345678",
          "connection_status": "connected"
        },
        "type": "mobile",
        "name": "modem",
        "up": true
      }
    ]
  };

  // Prefer JSON script (device_data); if missing or empty, use FALLBACK_RESPONSE
  const scriptEl = document.getElementById('device-usage-data');
  let source = {};
  try { source = scriptEl ? JSON.parse(scriptEl.textContent || '{}') : {}; } catch (_) { }
  console.log('Device Usage Source:====', source);
  if (!source || !Array.isArray(source.interfaces) || !source.interfaces.length) {
    source = FALLBACK_RESPONSE;
  }

  /* ---------- Helpers ---------- */
  const BYTES_PER_MB = 1024 * 1024;
  const toMB = b => (Number(b) || 0) / BYTES_PER_MB;
  const fmtMB = n => `${(Number(n) || 0).toFixed(2)} MB`;
  const findByName = (list, name) => (list || []).find(i => i && i.name === name) || null;
  const statsFrom = intf => {
    if (!intf || !intf.statistics) return { rxMB: 0, txMB: 0, totalMB: 0 };
    const rx = intf.statistics.rx_bytes ?? intf.statistics.rx?.bytes ?? 0;
    const tx = intf.statistics.tx_bytes ?? intf.statistics.tx?.bytes ?? 0;
    const rxMB = toMB(rx), txMB = toMB(tx);
    return { rxMB, txMB, totalMB: rxMB + txMB };
  };

  const lastUpdated = document.getElementById('lastUpdated');
  if (lastUpdated) lastUpdated.textContent = `(Updated: ${new Date().toLocaleTimeString()})`;

  const ifaces = source.interfaces || [];

  /* ---------- Cellular cards (modem / modem2) ---------- */
  const modem = findByName(ifaces, 'modem');
  const modem2 = findByName(ifaces, 'modem2');
  const m1 = statsFrom(modem);
  const m2 = statsFrom(modem2);

  const modem1Card = document.getElementById('modem1-card');
  if (modem1Card) {
    modem1Card.querySelector('.interface-value').textContent = fmtMB(m1.totalMB);
    modem1Card.querySelector('.interface-stats').innerHTML = `Upload: ${fmtMB(m1.txMB)}<br>Download: ${fmtMB(m1.rxMB)}`;
  }
  const modem2Card = document.getElementById('modem2-card');
  if (modem2Card) {
    modem2Card.querySelector('.interface-value').textContent = fmtMB(m2.totalMB);
    modem2Card.querySelector('.interface-stats').innerHTML = `Upload: ${fmtMB(m2.txMB)}<br>Download: ${fmtMB(m2.rxMB)}`;
  }
  const cellularTotal = document.getElementById('cellular-total-summary');
  if (cellularTotal) {
    const up = m1.txMB + m2.txMB, down = m1.rxMB + m2.rxMB;
    cellularTotal.querySelector('.total-value').textContent = fmtMB(up + down);
    cellularTotal.querySelector('.total-stats').innerHTML = `Upload: ${fmtMB(up)}<br>Download: ${fmtMB(down)}`;
  }

  /* ---------- Wired cards (eth0 / eth1) ---------- */
  const eth0 = findByName(ifaces, 'eth0');
  const eth1 = findByName(ifaces, 'eth1');
  const e0 = statsFrom(eth0);
  const e1 = statsFrom(eth1);

  const eth0Card = document.getElementById('eth0-card');
  if (eth0Card) {
    eth0Card.querySelector('.interface-value').textContent = fmtMB(e0.totalMB);
    eth0Card.querySelector('.interface-stats').innerHTML = `Upload: ${fmtMB(e0.txMB)}<br>Download: ${fmtMB(e0.rxMB)}`;
  }
  const eth1Card = document.getElementById('eth1-card');
  if (eth1Card) {
    eth1Card.querySelector('.interface-value').textContent = fmtMB(e1.totalMB);
    eth1Card.querySelector('.interface-stats').innerHTML = `Upload: ${fmtMB(e1.txMB)}<br>Download: ${fmtMB(e1.rxMB)}`;
  }
  const wiredTotal = document.getElementById('wired-total-summary');
  if (wiredTotal) {
    const up = e0.txMB + e1.txMB, down = e0.rxMB + e1.rxMB;
    wiredTotal.querySelector('.total-value').textContent = fmtMB(up + down);
    wiredTotal.querySelector('.total-stats').innerHTML = `Upload: ${fmtMB(up)}<br>Download: ${fmtMB(down)}`;
  }

  /* ---------- General Traffic chart (grouped bars; legend below; ~20px bars) ---------- */
  const labels = [];
  const rxMB = [];
  const txMB = [];
  if (eth0) { labels.push('eth0'); rxMB.push(e0.rxMB); txMB.push(e0.txMB); }
  if (eth1) { labels.push('eth1'); rxMB.push(e1.rxMB); txMB.push(e1.txMB); }
  const noData = labels.length === 0;

  const traceDownload = {
    type: 'bar',
    name: 'Download (RX)',
    x: labels,
    y: rxMB,
    marker: { color: '#1f77b4' },
    width: 0.10,
    hovertemplate: '%{x}<br>Download: %{y:.2f} MB<extra></extra>'
  };
  const traceUpload = {
    type: 'bar',
    name: 'Upload (TX)',
    x: labels,
    y: txMB,
    marker: { color: '#ff7f0e' },
    width: 0.10,
    hovertemplate: '%{x}<br>Upload: %{y:.2f} MB<extra></extra>'
  };

  const layout = {
    barmode: 'group',
    margin: { l: 60, r: 20, t: 10, b: 60 },
    xaxis: { title: 'Interface', automargin: true },
    yaxis: { title: 'MB', rangemode: 'tozero', automargin: true },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    legend: { orientation: 'h', yanchor: 'top', y: -0.25, x: 0.5, xanchor: 'center' },
    annotations: noData ? [{
      text: 'No eth0/eth1 ethernet data',
      xref: 'paper', yref: 'paper', x: 0.5, y: 0.5, showarrow: false,
      font: { size: 14, color: '#6b7280' }
    }] : []
  };

  Plotly.newPlot('trafficCharts', noData ? [] : [traceDownload, traceUpload], layout, {
    displaylogo: false, responsive: true, modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d']
  });
</script>