{% load i18n static %}
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<style>
  /* Page wrap */
  .du-wrap {
    max-width: 960px;
    margin: 24px auto;
    padding: 0 16px;
  }

  /* Card */
  .du-card {
    background: #fff;
    border: 1px solid #e8eaee;
    border-radius: 16px;
    box-shadow: 0 6px 24px rgba(16, 24, 40, .06);
    overflow: hidden;
  }

  .du-hd {
    padding: 16px 20px;
    border-bottom: 1px solid #e8eaee;
  }

  .du-title {
    margin: 0;
    font: 700 18px/1.3 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
    color: #0f172a;
  }

  .du-bd {
    padding: 18px 20px 22px;
  }

  /* Chart container: centered and sized nicely */
  .du-chart {
    margin: 0 auto;            /* center horizontally */
    width: 100%;
    max-width: 720px;          /* keep it compact */
    height: 340px;             /* fixed height for consistent look */
  }
</style>

{{ device_data|json_script:"device-usage-data" }}

<div class="du-wrap">
  <section class="du-card">
    <div class="du-hd">
      <h3 class="du-title">{% trans "Applications" %}</h3>
    </div>
    <div class="du-bd">
      <div id="du-chart-apps" class="du-chart"></div>
    </div>
  </section>
</div>

<script>
  // ---- Data ----
  const device_data = JSON.parse(document.getElementById('device-usage-data').textContent || '{}');
  const talkers = (((device_data || {}).realtimemonitor || {}).real_time_traffic || {}).data?.talkers || {};
  const APPS = Array.isArray(talkers.top_apps) ? talkers.top_apps : [];

  // Labels + values
  const labels = APPS.map(a => a?.name || 'Unknown');
  const values = APPS.map(a => Number(a?.bytes) || 0);

  // Simple palette
  const palette = ["#3b82f6", "#ef4444", "#f59e0b", "#10b981", "#8b5cf6", "#06b6d4", "#84cc16", "#eab308", "#ec4899", "#14b8a6", "#f97316", "#4f46e5"];
  const colors = values.map((_, i) => palette[i % palette.length]);

  // ---- Plotly bar chart ----
  const data = [{
    type: 'bar',
    x: labels,
    y: values,
    marker: { color: colors },
    hovertemplate: '%{x}<br>%{y} bytes<extra></extra>'
  }];

  const noData = labels.length === 0;

  const layout = {
    margin: { l: 50, r: 20, t: 10, b: 60 },
    xaxis: { title: '{% trans "Applications" %}', automargin: true },
    yaxis: { title: '{% trans "Traffic (Bytes)" %}', automargin: true, rangemode: 'tozero' },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    annotations: noData ? [{
      text: '{% trans "No application traffic data" %}',
      xref: 'paper', yref: 'paper', x: 0.5, y: 0.5,
      showarrow: false, font: { size: 14, color: '#6b7280' }
    }] : []
  };

  Plotly.newPlot('du-chart-apps', noData ? [] : data, layout, {
    displaylogo: false,
    responsive: true,
    modeBarButtonsToRemove: ['select2d','lasso2d','autoScale2d']
  });
</script>
