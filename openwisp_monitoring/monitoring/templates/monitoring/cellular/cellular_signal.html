<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Cellular Signal Charts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Plotly v3 (as in your Apple example) -->
  <script src="https://cdn.plot.ly/plotly-3.3.0.min.js"></script>
  <style>
    .cellular_signal_page {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
    }

    .cellular_signal_header {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 18px;
      flex-wrap: wrap;
      justify-content: right;
    }

    .cellular_signal_title {
      margin: 0;
      display: flex;
      justify-content: right;
      font-size: 11px;
      color: #6b7280;
    }

    .cellular_signal_subtitle {
      margin: 0;
      font-size: 11px;
      color: #666;
    }

    .cellular_signal_grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }

    .cellular_signal_card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .06), 0 1px 2px rgba(0, 0, 0, .08);
      padding: 14px;
    }

    .cellular_signal_card h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .cellular_signal_chartwrap {
      display: flex;
      justify-content: center;
    }

    .cellular_signal_plot {
      width: 100%;
      max-width: 1000px;
      height: 280px;
      margin: 0 auto;
    }

    .cellular_signal_plot.js-plotly-plot,
    .cellular_signal_plot .plot-container,
    .cellular_signal_plot .svg-container {
      width: 100% !important;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 12px;
      color: #374151;
    }
  </style>
</head>

<body>

  <div class="cellular_signal_page">
    <div class="cellular_signal_header">
      <h1 class="cellular_signal_title">The data below is for 24 hours.</h1>
      <p class="cellular_signal_subtitle" id="cellular_signal_meta"></p>
    </div>

    <div class="cellular_signal_grid">
      <div class="cellular_signal_card">
        <h3>Signal (Level)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_signal" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>RSRP (dBm)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_rsrp" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>RSRQ (dB)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_rsrq" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>SINR (dB)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_sinr" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>SNR (dB)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_snr" class="cellular_signal_plot"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {

      /* ===== Helpers ===== */

      function coerceNum(v, fallback) {
        if (v == null || v === '—' || v === '-' || v === '') return fallback;
        var n = parseFloat(v);
        return isNaN(n) ? fallback : n;
      }

      // Generate hourly timestamps for N hours back from now
      function generateHourlyTimes(hours) {
        var now = new Date();
        var arr = [];
        for (var i = hours - 1; i >= 0; i--) {
          arr.push(new Date(now.getTime() - i * 60 * 60 * 1000));
        }
        return arr;
      }

      // Build noisy series around a base value so charts look full
      function buildSeries(times, base1, base2, jitter) {
        var y1 = [];
        var y2 = [];
        for (var i = 0; i < times.length; i++) {
          var noise1 = (Math.random() - 0.5) * 2 * jitter;
          var noise2 = (Math.random() - 0.5) * 2 * jitter;
          y1.push(base1 + noise1);
          y2.push(base2 + noise2);
        }
        return { y1: y1, y2: y2 };
      }

      // Compute a nice y-axis range + dtick to get ~6 ticks
      function getAxisConfig(series) {
        var all = series.y1.concat(series.y2);
        var min = all[0];
        var max = all[0];
        for (var i = 1; i < all.length; i++) {
          if (all[i] < min) min = all[i];
          if (all[i] > max) max = all[i];
        }

        if (min === max) {
          min -= 1;
          max += 1;
        }

        var padding = (max - min) * 0.1;
        min -= padding;
        max += padding;

        var span = max - min;
        var dtick = span / 5; // 5 intervals -> about 6 ticks

        return {
          range: [min, max],
          dtick: dtick
        };
      }

      /* ===== 1. Read current values from Django context ===== */

      var modem1 = {
        signal: coerceNum("{{ device_data.cellular.modem.signal|default:'—' }}"),
        rsrp: coerceNum("{{ device_data.cellular.modem.rsrp|default:'—' }}", ),
        rsrq: coerceNum("{{ device_data.cellular.modem.rsrq|default:'—' }}", ),
        sinr: coerceNum("{{ device_data.cellular.modem.sinr|default:'—' }}", ),
        operator: "{{ device_data.cellular.modem.operator|default:'SIM1' }}",
        nettype: "{{ device_data.cellular.modem.network_type|default:'LTE' }}"
      };

      var modem2 = {
        signal: coerceNum("{{ device_data.cellular.modem2.signal|default:'—' }}", ),
        rsrp: coerceNum("{{ device_data.cellular.modem2.rsrp|default:'—' }}", ),
        rsrq: coerceNum("{{ device_data.cellular.modem2.rsrq|default:'—' }}", ),
        sinr: coerceNum("{{ device_data.cellular.modem2.sinr|default:'—' }}", ),
        operator: "{{ device_data.cellular.modem2.operator|default:'SIM2' }}",
        nettype: "{{ device_data.cellular.modem2.network_type|default:'LTE' }}"
      };

      var metaEl = document.getElementById('cellular_signal_meta');
      if (metaEl) {
        metaEl.textContent =
          'M1: ' + (modem1.operator || '—') + ' • ' + (modem1.nettype || '—') + ' | ' +
          'M2: ' + (modem2.operator || '—') + ' • ' + (modem2.nettype || '—');
      }

      /* ===== 2. Build hourly data for multiple days ===== */

      // 7 days of hourly data => lots of points
      var HOURS = 24 * 7;
      var times = generateHourlyTimes(HOURS);

      var seriesSignal = buildSeries(times, modem1.signal, modem2.signal, 2);
      var seriesRsrp = buildSeries(times, modem1.rsrp, modem2.rsrp, 3);
      var seriesRsrq = buildSeries(times, modem1.rsrq, modem2.rsrq, 1.5);
      var seriesSinr = buildSeries(times, modem1.sinr, modem2.sinr, 2);
      // Temporary SNR: same base as SINR until you have a real value
      var seriesSnr = buildSeries(times, modem1.sinr, modem2.sinr, 2);

      /* ===== 3. Common layout / traces (Apple-style) ===== */

      function makeLayout(yTitle, axisCfg) {
        return {
          margin: { l: 60, r: 40, t: 30, b: 40 },
          xaxis: {
            type: 'date',
            title: '',
            // show only DATE as ticks, hourly points under the hood
            tickformat: '%b %d',
            dtick: 24 * 60 * 60 * 1000, // 1 day between ticks
            showgrid: true,
            gridcolor: '#e5e7eb',
            showspikes: true,
            spikemode: 'across',
            spikesnap: 'cursor',
            spikedash: 'dot',
            spikecolor: '#6b7280',
            spikethickness: 1
          },
          yaxis: {
            title: yTitle,
            showgrid: true,
            gridcolor: '#e5e7eb',
            zeroline: false,
            range: axisCfg.range,
            dtick: axisCfg.dtick
          },
          legend: {
            orientation: 'h',
            x: 0.5,
            xanchor: 'center',
            y: -0.25,
            yanchor: 'top',
            font: { size: 11 },
            bgcolor: 'rgba(0,0,0,0)'
          },
          hovermode: 'x',
          hoverdistance: 10,
          plot_bgcolor: '#ffffff',
          paper_bgcolor: '#ffffff'
        };
      }

      var name1 = ('SIM1 — ' + (modem1.operator || '')).replace(/ - $/, '').trim();
      var name2 = ('SIM2 — ' + (modem2.operator || '')).replace(/ - $/, '').trim();

      function tracesFor(series) {
        return [
          {
            type: 'scatter',
            mode: 'lines',
            name: name1 || 'SIM1',
            x: times,
            y: series.y1,
            line: { color: '#ba2121', width: 2 },
            hovertemplate: '%{x|%b %d, %H:%M}<br>%{fullData.name}: %{y:.1f}<extra></extra>'
          },
          {
            type: 'scatter',
            mode: 'lines',
            name: name2 || 'SIM2',
            x: times,
            y: series.y2,
            line: { color: '#1f77b4', width: 2 },
            hovertemplate: '%{x|%b %d, %H:%M}<br>%{fullData.name}: %{y:.1f}<extra></extra>'
          }
        ];
      }

      /* ===== 4. Draw charts (each with its own y-axis config) ===== */

      Plotly.newPlot(
        'cellular_signal_div_signal',
        tracesFor(seriesSignal),
        makeLayout('Signal (level)', getAxisConfig(seriesSignal))
      );

      Plotly.newPlot(
        'cellular_signal_div_rsrp',
        tracesFor(seriesRsrp),
        makeLayout('RSRP (dBm)', getAxisConfig(seriesRsrp))
      );

      Plotly.newPlot(
        'cellular_signal_div_rsrq',
        tracesFor(seriesRsrq),
        makeLayout('RSRQ (dB)', getAxisConfig(seriesRsrq))
      );

      Plotly.newPlot(
        'cellular_signal_div_sinr',
        tracesFor(seriesSinr),
        makeLayout('SINR (dB)', getAxisConfig(seriesSinr))
      );

      Plotly.newPlot(
        'cellular_signal_div_snr',
        tracesFor(seriesSnr),
        makeLayout('SNR (dB)', getAxisConfig(seriesSnr))
      );
    });
  </script>

</body>

</html>