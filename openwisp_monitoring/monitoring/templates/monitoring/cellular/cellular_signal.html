<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Cellular Signal Charts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    .cellular_signal_page {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
    }

    .cellular_signal_header {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .cellular_signal_title {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }

    .cellular_signal_subtitle {
      margin: 0;
      font-size: 14px;
      color: #666;
    }

    .cellular_signal_grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }

    .cellular_signal_card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .06), 0 1px 2px rgba(0, 0, 0, .08);
      padding: 14px;
    }

    .cellular_signal_card h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .cellular_signal_chartwrap {
      display: flex;
      justify-content: center;
    }

    .cellular_signal_plot {
      width: 100%;
      max-width: 1000px;
      height: 280px;
      margin: 0 auto;
    }

    .cellular_signal_plot.js-plotly-plot,
    .cellular_signal_plot .plot-container,
    .cellular_signal_plot .svg-container {
      width: 100% !important;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 12px;
      color: #374151;
    }
  </style>
</head>

<body>

  <div class="cellular_signal_page">
    <div class="cellular_signal_header">
      <h1 class="cellular_signal_title">Cellular Metrics</h1>
      <p class="cellular_signal_subtitle" id="cellular_signal_meta"></p>
    </div>

    <div class="cellular_signal_grid">
      <div class="cellular_signal_card">
        <h3>Signal Strength (Level)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_csq" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>RSRP (dBm)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_rsrp" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>RSRQ (dB)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_rsrq" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>RSSI (dBm)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_rssi" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>SNR (dB)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_snr" class="cellular_signal_plot"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {

      /* ====== 1. Read one snapshot from Django (local_time + modem values) ====== */
      function getSampleData() {
        const rawLocalTime = "{{ device_data.general.local_time|default:'' }}";
        const device_data = "{{ device_data|default:'' }}";

        console.log("Raw local_time:====", rawLocalTime);
        console.log("Device data:====", device_data);
        let ts = new Date(rawLocalTime || '2025-11-12T21:32:54+05:30');
        if (isNaN(ts.getTime())) {
          ts = new Date(); // avoid "Invalid Date"
        }

        function coerceNum(v) {
          if (v == null || v === '—' || v === '-' || v === '') return 0;
          const n = parseFloat(v);
          return isNaN(n) ? 0 : n;
        }

        return {
          timestamp: ts,
          m1: {
            csq: coerceNum("{{ device_data.cellular.modem.csq|default:'—' }}"),
            rsrp: coerceNum("{{ device_data.cellular.modem.rsrp|default:'—' }}"),
            rsrq: coerceNum("{{ device_data.cellular.modem.rsrq|default:'—' }}"),
            rssi: coerceNum("{{ device_data.cellular.modem.rssi|default:'—' }}"),
            snr: coerceNum("{{ device_data.cellular.modem.sinr|default:'—' }}"),
            operator: "{{ device_data.cellular.modem.operator|default:'—' }}",
            nettype: "{{ device_data.cellular.modem.nettype|default:'—' }}"
          },
          m2: {
            csq: coerceNum("{{ device_data.cellular.modem2.csq|default:'—' }}"),
            rsrp: coerceNum("{{ device_data.cellular.modem2.rsrp|default:'—' }}"),
            rsrq: coerceNum("{{ device_data.cellular.modem2.rsrq|default:'—' }}"),
            rssi: coerceNum("{{ device_data.cellular.modem2.rssi|default:'—' }}"),
            snr: coerceNum("{{ device_data.cellular.modem2.sinr|default:'—' }}"),
            operator: "{{ device_data.cellular.modem2.operator|default:'—' }}",
            nettype: "{{ device_data.cellular.modem2.nettype|default:'—' }}"
          }
        };
      }

      /* ====== 2. Build 24 hourly points from local_time ====== */

      function formatHourLabel(d) {
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      function buildHourlySeries(sample) {
        const labels = [];
        const base = new Date(sample.timestamp);
        base.setMinutes(0, 0, 0); // snap to top of the current hour

        // last 24 hours: oldest → newest
        for (let i = 23; i >= 0; i--) {
          const d = new Date(base);
          d.setHours(base.getHours() - i);
          labels.push(formatHourLabel(d));
        }

        // repeat the same reading for each hour (only one snapshot available)
        const csq1 = labels.map(() => sample.m1.csq || 0);
        const csq2 = labels.map(() => sample.m2.csq || 0);
        const rsrp1 = labels.map(() => sample.m1.rsrp || 0);
        const rsrp2 = labels.map(() => sample.m2.rsrp || 0);
        const rsrq1 = labels.map(() => sample.m1.rsrq || 0);
        const rsrq2 = labels.map(() => sample.m2.rsrq || 0);
        const rssi1 = labels.map(() => sample.m1.rssi || 0);
        const rssi2 = labels.map(() => sample.m2.rssi || 0);
        const snr1 = labels.map(() => sample.m1.snr || 0);
        const snr2 = labels.map(() => sample.m2.snr || 0);

        return {
          labels,
          csq1, csq2,
          rsrp1, rsrp2,
          rsrq1, rsrq2,
          rssi1, rssi2,
          snr1, snr2,
          operator1: sample.m1.operator || '—',
          operator2: sample.m2.operator || '—',
          nettype1: sample.m1.nettype || '—',
          nettype2: sample.m2.nettype || '—'
        };
      }

      /* ====== 3. Draw charts with Plotly ====== */

      function drawCharts(series) {
        const labels = series.labels;

        const name1 = "Sim1 — " + series.operator1 +
          (series.nettype1 && series.nettype1 !== '—' ? " (" + series.nettype1 + ")" : "");
        const name2 = "Sim2 — " + series.operator2 +
          (series.nettype2 && series.nettype2 !== '—' ? " (" + series.nettype2 + ")" : "");

        const baseLayout = (ytitle, yRange, yDtick) => ({
          margin: { l: 60, r: 20, t: 50, b: 80 },
          yaxis: { title: ytitle, range: yRange, dtick: yDtick, zeroline: false, gridcolor: '#e5e7eb' },
          xaxis: {
            type: 'category',
            categoryorder: 'array',
            categoryarray: labels,
            gridcolor: '#e5e7eb',
            tickangle: -45
          },
          legend: { orientation: 'h', yanchor: 'bottom', y: 1.12, x: 0, xanchor: 'left' },
          plot_bgcolor: '#ffffff',
          paper_bgcolor: '#ffffff'
        });

        Plotly.newPlot('cellular_signal_div_csq', [
          {
            x: labels,
            y: series.csq1,
            type: 'scatter',
            mode: 'lines+markers',
            name: name1,
            line: { color: '#ff7f0e', width: 3 },
            marker: { size: 7 }
          },
          {
            x: labels,
            y: series.csq2,
            type: 'scatter',
            mode: 'lines+markers',
            name: name2,
            line: { color: '#1f77b4', width: 3 },
            marker: { size: 7 }
          }
        ], baseLayout('CSQ', [0, 40], 5));

        Plotly.newPlot('cellular_signal_div_rsrp', [
          {
            x: labels,
            y: series.rsrp1,
            type: 'scatter',
            mode: 'lines+markers',
            name: name1,
            line: { color: '#ff7f0e' },
            marker: { size: 6 }
          },
          {
            x: labels,
            y: series.rsrp2,
            type: 'scatter',
            mode: 'lines+markers',
            name: name2,
            line: { color: '#1f77b4' },
            marker: { size: 6 }
          }
        ], baseLayout('RSRP (dBm)', [-140, -44], 20));

        Plotly.newPlot('cellular_signal_div_rsrq', [
          {
            x: labels,
            y: series.rsrq1,
            type: 'scatter',
            mode: 'lines+markers',
            name: name1,
            line: { color: '#ff7f0e' },
            marker: { size: 6 }
          },
          {
            x: labels,
            y: series.rsrq2,
            type: 'scatter',
            mode: 'lines+markers',
            name: name2,
            line: { color: '#1f77b4' },
            marker: { size: 6 }
          }
        ], baseLayout('RSRQ (dB)', [-20, -3], 2));

        Plotly.newPlot('cellular_signal_div_rssi', [
          {
            x: labels,
            y: series.rssi1,
            type: 'scatter',
            mode: 'lines+markers',
            name: name1,
            line: { color: '#ff7f0e' },
            marker: { size: 6 }
          },
          {
            x: labels,
            y: series.rssi2,
            type: 'scatter',
            mode: 'lines+markers',
            name: name2,
            line: { color: '#1f77b4' },
            marker: { size: 6 }
          }
        ], baseLayout('RSSI (dBm)', [-120, -40], 10));

        Plotly.newPlot('cellular_signal_div_snr', [
          {
            x: labels,
            y: series.snr1,
            type: 'scatter',
            mode: 'lines+markers',
            name: name1,
            line: { color: '#ff7f0e' },
            marker: { size: 6 }
          },
          {
            x: labels,
            y: series.snr2,
            type: 'scatter',
            mode: 'lines+markers',
            name: name2,
            line: { color: '#1f77b4' },
            marker: { size: 6 }
          }
        ], baseLayout('SNR (dB)', [-5, 35], 5));
      }

      /* ====== 4. Initialise page ====== */

      const sample = getSampleData();
      const series = buildHourlySeries(sample);
      drawCharts(series);

      const metaEl = document.getElementById('cellular_signal_meta');
      if (metaEl) {
        metaEl.textContent =
          `M1: ${sample.m1.operator} • ${sample.m1.nettype} | ` +
          `M2: ${sample.m2.operator} • ${sample.m2.nettype}`;
      }
    });
  </script>

</body>

</html>