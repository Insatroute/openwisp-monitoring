<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Cellular Signal Charts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    .cellular_signal_page {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
    }

    .cellular_signal_header {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 18px;
      flex-wrap: wrap;
      justify-content: right;
    }

    .cellular_signal_title {
      margin: 0;
      display: flex;
      justify-content: right;
      font-size: 11px;
      color: #6b7280;
    }

    .cellular_signal_subtitle {
      margin: 0;
      font-size: 11px;
      color: #666;
    }

    .cellular_signal_grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }

    .cellular_signal_card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .06), 0 1px 2px rgba(0, 0, 0, .08);
      padding: 14px;
    }

    .cellular_signal_card h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .cellular_signal_chartwrap {
      display: flex;
      justify-content: center;
    }

    .cellular_signal_plot {
      width: 100%;
      max-width: 1000px;
      height: 280px;
      margin: 0 auto;
    }

    .cellular_signal_plot.js-plotly-plot,
    .cellular_signal_plot .plot-container,
    .cellular_signal_plot .svg-container {
      width: 100% !important;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 12px;
      color: #374151;
    }
  </style>
</head>

<body>

  <div class="cellular_signal_page">
    <div class="cellular_signal_header">
      <h1 class="cellular_signal_title">Cellular Metrics</h1>
      <p class="cellular_signal_subtitle" id="cellular_signal_meta"></p>
    </div>

    <div class="cellular_signal_grid">
      <div class="cellular_signal_card">
        <h3>Signal Strength (Level)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_csq" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>RSRP (dBm)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_rsrp" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>RSRQ (dB)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_rsrq" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>RSSI (dBm)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_rssi" class="cellular_signal_plot"></div>
        </div>
      </div>

      <div class="cellular_signal_card">
        <h3>SNR (dB)</h3>
        <div class="cellular_signal_chartwrap">
          <div id="cellular_signal_div_snr" class="cellular_signal_plot"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {

      /* ========= 0. Storage key per device ========= */
      const serialNumber = "{{ device_data.general.serialnumber|default:'unknown' }}";
      const STORAGE_KEY = "cellular_history_" + serialNumber;

      /* ---------- Helper to parse Django local_time ---------- */
      function parseLocalTime(raw) {
        if (!raw) return null;

        let d = new Date(raw);
        if (!isNaN(d.getTime())) return d;

        const m = raw.match(/(\d{1,2})\s+([A-Za-z]{3})\s+(\d{4}),\s+(\d{1,2}):(\d{2})\s*([ap]\.m\.)/i);
        if (m) {
          const day = parseInt(m[1], 10);
          const monthName = m[2].toLowerCase();
          const year = parseInt(m[3], 10);
          let hour = parseInt(m[4], 10);
          const minute = parseInt(m[5], 10);
          const ampm = m[6].toLowerCase();

          const monthMap = {
            jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5,
            jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11
          };
          const monthIdx = monthMap[monthName] ?? 0;

          if (ampm.startsWith('p') && hour < 12) hour += 12;
          if (ampm.startsWith('a') && hour === 12) hour = 0;

          d = new Date(year, monthIdx, day, hour, minute, 0, 0);
          if (!isNaN(d.getTime())) return d;
        }

        return new Date();
      }

      /* ====== 1. Snapshot from Django ====== */
      function getSampleFromDjango() {
        const rawLocalTime = "{{ device_data.general.local_time|default:'' }}";
        console.log("Raw local_time:====", rawLocalTime);

        const ts = parseLocalTime(rawLocalTime || '2025-11-12T21:32:54+05:30');

        function coerceNum(v) {
          if (v == null || v === '—' || v === '-' || v === '') return 0;
          const n = parseFloat(v);
          return isNaN(n) ? 0 : n;
        }

        return {
          timestamp: ts,
          m1: {
            csq: coerceNum("{{ device_data.cellular.modem.signal|default:'—' }}"),
            rsrp: coerceNum("{{ device_data.cellular.modem.rsrp|default:'—' }}"),
            rsrq: coerceNum("{{ device_data.cellular.modem.rsrq|default:'—' }}"),
            rssi: coerceNum("{{ device_data.cellular.modem.rssi|default:'—' }}"),
            snr: coerceNum("{{ device_data.cellular.modem.sinr|default:'—' }}"),
            operator: "{{ device_data.cellular.modem.operator|default:'—' }}",
            nettype: "{{ device_data.cellular.modem.nettype|default:'—' }}"
          },
          m2: {
            csq: coerceNum("{{ device_data.cellular.modem2.csq|default:'—' }}"),
            rsrp: coerceNum("{{ device_data.cellular.modem2.rsrp|default:'—' }}"),
            rsrq: coerceNum("{{ device_data.cellular.modem2.rsrq|default:'—' }}"),
            rssi: coerceNum("{{ device_data.cellular.modem2.rssi|default:'—' }}"),
            snr: coerceNum("{{ device_data.cellular.modem2.sinr|default:'—' }}"),
            operator: "{{ device_data.cellular.modem2.operator|default:'—' }}",
            nettype: "{{ device_data.cellular.modem2.nettype|default:'—' }}"
          }
        };
      }

      /* ====== 2. localStorage helpers ====== */
      function loadHistoryFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return [];
          return arr.map(function (s) {
            return {
              timestamp: new Date(s.timestamp),
              m1: s.m1 || {},
              m2: s.m2 || {}
            };
          }).filter(function (s) {
            return !isNaN(s.timestamp.getTime());
          });
        } catch (e) {
          console.error('Failed to load cellular history from storage:', e);
          return [];
        }
      }

      function saveHistoryToStorage(history) {
        try {
          const plain = history.map(function (s) {
            return {
              timestamp: s.timestamp.toISOString(),
              m1: s.m1,
              m2: s.m2
            };
          });
          localStorage.setItem(STORAGE_KEY, JSON.stringify(plain));
        } catch (e) {
          console.error('Failed to save cellular history to storage:', e);
        }
      }

      /* ====== 3. In-memory history (trim to last 24h) ====== */

      let history = loadHistoryFromStorage();

      function addSample(sample) {
        if (!sample || !sample.timestamp || isNaN(sample.timestamp.getTime())) return;

        history.push(sample);
        history.sort(function (a, b) {
          return a.timestamp - b.timestamp;
        });

        const lastTs = history[history.length - 1].timestamp;
        const cutoff = new Date(lastTs.getTime() - 24 * 60 * 60 * 1000);
        history = history.filter(function (s) {
          return s.timestamp >= cutoff;
        });

        if (history.length > 500) {
          history = history.slice(history.length - 500);
        }

        saveHistoryToStorage(history);
      }

      /* ====== 4. Aggregate history per HOUR ====== */
      function buildSeriesFromHistory() {
        if (!history.length) return null;

        // buckets keyed by hour
        const bucketMap = {}; // key ISO hour -> bucket object

        history.forEach(function (s) {
          const h = new Date(s.timestamp);
          h.setMinutes(0, 0, 0); // truncate to hour
          const key = h.toISOString();

          let b = bucketMap[key];
          if (!b) {
            b = {
              ts: h,
              csq1Sum: 0, csq2Sum: 0,
              rsrp1Sum: 0, rsrp2Sum: 0,
              rsrq1Sum: 0, rsrq2Sum: 0,
              rssi1Sum: 0, rssi2Sum: 0,
              snr1Sum: 0, snr2Sum: 0,
              count: 0
            };
            bucketMap[key] = b;
          }

          b.csq1Sum += (s.m1.csq || 0);
          b.csq2Sum += (s.m2.csq || 0);
          b.rsrp1Sum += (s.m1.rsrp || 0);
          b.rsrp2Sum += (s.m2.rsrp || 0);
          b.rsrq1Sum += (s.m1.rsrq || 0);
          b.rsrq2Sum += (s.m2.rsrq || 0);
          b.rssi1Sum += (s.m1.rssi || 0);
          b.rssi2Sum += (s.m2.rssi || 0);
          b.snr1Sum += (s.m1.snr || 0);
          b.snr2Sum += (s.m2.snr || 0);
          b.count += 1;
        });

        const buckets = Object.values(bucketMap).sort(function (a, b) {
          return a.ts - b.ts;
        });

        const labels = buckets.map(function (b) { return b.ts; });

        function avg(sum, count) {
          return count ? sum / count : 0;
        }

        const csq1 = buckets.map(function (b) { return avg(b.csq1Sum, b.count); });
        const csq2 = buckets.map(function (b) { return avg(b.csq2Sum, b.count); });
        const rsrp1 = buckets.map(function (b) { return avg(b.rsrp1Sum, b.count); });
        const rsrp2 = buckets.map(function (b) { return avg(b.rsrp2Sum, b.count); });
        const rsrq1 = buckets.map(function (b) { return avg(b.rsrq1Sum, b.count); });
        const rsrq2 = buckets.map(function (b) { return avg(b.rsrq2Sum, b.count); });
        const rssi1 = buckets.map(function (b) { return avg(b.rssi1Sum, b.count); });
        const rssi2 = buckets.map(function (b) { return avg(b.rssi2Sum, b.count); });
        const snr1 = buckets.map(function (b) { return avg(b.snr1Sum, b.count); });
        const snr2 = buckets.map(function (b) { return avg(b.snr2Sum, b.count); });

        const firstTs = labels[0];
        const lastTs = labels[labels.length - 1];
        const pad = 15 * 60 * 1000;
        const xMin = new Date(firstTs.getTime() - pad);
        const xMax = new Date(lastTs.getTime() + pad);

        const lastSample = history[history.length - 1];

        return {
          labels: labels,
          xMin: xMin,
          xMax: xMax,
          csq1: csq1, csq2: csq2,
          rsrp1: rsrp1, rsrp2: rsrp2,
          rsrq1: rsrq1, rsrq2: rsrq2,
          rssi1: rssi1, rssi2: rssi2,
          snr1: snr1, snr2: snr2,
          operator1: lastSample.m1.operator || '—',
          operator2: lastSample.m2.operator || '—',
          nettype1: lastSample.m1.nettype || '—',
          nettype2: lastSample.m2.nettype || '—'
        };
      }

      function formatTimeHHMM(d) {
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      /* ====== 5. Draw charts (x-axis ticks every 1 hour) ====== */

      function drawCharts(series) {
        if (!series) return;

        const labels = series.labels;

        const name1 = "Sim1 — " + series.operator1 +
          (series.nettype1 && series.nettype1 !== '—' ? " (" + series.nettype1 + ")" : "");
        const name2 = "Sim2 — " + series.operator2 +
          (series.nettype2 && series.nettype2 !== '—' ? " (" + series.nettype2 + ")" : "");

        // new minimal layout similar to screenshot
        const baseLayout = function (ytitle, yRange, yDtick) {
          return {
            margin: { l: 40, r: 10, t: 10, b: 40 },
            yaxis: {
              title: '',
              range: yRange,
              dtick: yDtick,
              zeroline: false,
              showgrid: false,
              tickfont: { size: 10, color: '#9ca3af' }
            },
            xaxis: {
              type: 'date',
              range: [series.xMin, series.xMax],
              showgrid: false,
              tickformat: '%b %-d',
              tickangle: 0,
              tickfont: { size: 10, color: '#9ca3af' }
            },
            showlegend: false,
            plot_bgcolor: '#ffffff',
            paper_bgcolor: '#ffffff'
          };
        };

        Plotly.newPlot('cellular_signal_div_csq', [
          {
            x: labels,
            y: series.csq1,
            type: 'scatter',
            mode: 'lines',
            name: name1,
            line: { color: '#1f77b4', width: 2, shape: 'spline' }
          },
          {
            x: labels,
            y: series.csq2,
            type: 'scatter',
            mode: 'lines',
            name: name2,
            line: { color: '#d62728', width: 2, shape: 'spline' }
          }
        ], baseLayout('CSQ', [0, 40], 5), {
          displayModeBar: false,
          displaylogo: false
        });

        Plotly.newPlot('cellular_signal_div_rsrp', [
          {
            x: labels,
            y: series.rsrp1,
            type: 'scatter',
            mode: 'lines',
            name: name1,
            line: { color: '#1f77b4', width: 2, shape: 'spline' }
          },
          {
            x: labels,
            y: series.rsrp2,
            type: 'scatter',
            mode: 'lines',
            name: name2,
            line: { color: '#d62728', width: 2, shape: 'spline' }
          }
        ], baseLayout('RSRP (dBm)', [-140, -44], 20), {
          displayModeBar: false,
          displaylogo: false
        });

        Plotly.newPlot('cellular_signal_div_rsrq', [
          {
            x: labels,
            y: series.rsrq1,
            type: 'scatter',
            mode: 'lines',
            name: name1,
            line: { color: '#1f77b4', width: 2, shape: 'spline' }
          },
          {
            x: labels,
            y: series.rsrq2,
            type: 'scatter',
            mode: 'lines',
            name: name2,
            line: { color: '#d62728', width: 2, shape: 'spline' }
          }
        ], baseLayout('RSRQ (dB)', [-20, -3], 2), {
          displayModeBar: false,
          displaylogo: false
        });

        Plotly.newPlot('cellular_signal_div_rssi', [
          {
            x: labels,
            y: series.rssi1,
            type: 'scatter',
            mode: 'lines',
            name: name1,
            line: { color: '#1f77b4', width: 2, shape: 'spline' }
          },
          {
            x: labels,
            y: series.rssi2,
            type: 'scatter',
            mode: 'lines',
            name: name2,
            line: { color: '#d62728', width: 2, shape: 'spline' }
          }
        ], baseLayout('RSSI (dBm)', [-120, -40], 10), {
          displayModeBar: false,
          displaylogo: false
        });

        Plotly.newPlot('cellular_signal_div_snr', [
          {
            x: labels,
            y: series.snr1,
            type: 'scatter',
            mode: 'lines',
            name: name1,
            line: { color: '#1f77b4', width: 2, shape: 'spline' }
          },
          {
            x: labels,
            y: series.snr2,
            type: 'scatter',
            mode: 'lines',
            name: name2,
            line: { color: '#d62728', width: 2, shape: 'spline' }
          }
        ], baseLayout('SNR (dB)', [-5, 35], 5), {
          displayModeBar: false,
          displaylogo: false
        });
      }

      /* ====== 6. Initial load ====== */

      const firstSample = getSampleFromDjango();
      addSample(firstSample);
      const initialSeries = buildSeriesFromHistory();
      drawCharts(initialSeries);

      const metaEl = document.getElementById('cellular_signal_meta');
      if (metaEl) {
        metaEl.textContent =
          `M1: ${firstSample.m1.operator} • ${firstSample.m1.nettype} | ` +
          `M2: ${firstSample.m2.operator} • ${firstSample.m2.nettype}`;
      }

      /* Optional helper if you later add samples dynamically */
      window.__addCellularSample = function (sample) {
        addSample(sample);
        drawCharts(buildSeriesFromHistory());
      };
    });
  </script>

</body>

</html>