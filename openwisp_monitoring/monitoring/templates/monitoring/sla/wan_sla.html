{% load i18n %}

<style>
  .sla-summary-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .sla-summary-card {
    background: #ffffff;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
    padding: 0.75rem 1rem;
  }
  .sla-summary-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #6b7280;
    margin-bottom: 4px;
    font-weight: 600;
  }
  .sla-summary-value {
    font-size: 0.95rem;
    font-weight: 500;
    color: #111827;
  }
  .sla-summary-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    background: #eff6ff;
    color: #1d4ed8;
  }

  .sla-intervals-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  .sla-intervals-table th,
  .sla-intervals-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.85rem;
  }
  .sla-intervals-table th {
    text-align: left;
    background: #f9fafb;
  }
  .sla-status-up {
    color: #16a34a;
    font-weight: 600;
  }
  .sla-status-down {
    color: #dc2626;
    font-weight: 600;
  }

  /* Empty-state pill, similar to WAN uplink “No active ...” box */
  .sla-empty-box {
    margin-top: 1rem;
    border-radius: 8px;
    border: 1px dashed #d1d5db;
    background: #f9fafb;
    padding: 8px 16px;
    text-align: center;
    color: #6b7280;
    font-size: 0.9rem;
  }
</style>

<form method="get" class="sla-filter-form" style="margin-bottom: 12px;">
  <label for="id_sla_window"><strong>{% trans "SLA window" %}:</strong></label>
  <select name="sla_window" id="id_sla_window">
    <option value="1d"  {% if sla_window_key == '1d' %}selected{% endif %}>{% trans "Last 1 day" %}</option>
    <option value="3d"  {% if sla_window_key == '3d' %}selected{% endif %}>{% trans "Last 3 days" %}</option>
    <option value="7d"  {% if sla_window_key == '7d' %}selected{% endif %}>{% trans "Last 7 days" %}</option>
    <option value="30d" {% if sla_window_key == '30d' %}selected{% endif %}>{% trans "Last 30 days" %}</option>
    <option value="custom" {% if sla_window_key == 'custom' %}selected{% endif %}>{% trans "Custom" %}</option>
  </select>

  <span id="sla-custom-range" {% if sla_window_key != 'custom' %}style="display:none"{% endif %}>
    &nbsp;&nbsp;
    {% trans "From" %}:
    <input type="text" name="sla_start" value="{{ sla_start }}" placeholder="YYYY-mm-dd HH:MM">
    {% trans "To" %}:
    <input type="text" name="sla_end"   value="{{ sla_end }}"   placeholder="YYYY-mm-dd HH:MM">
    <button type="submit">{% trans "Apply" %}</button>
  </span>
</form>

<div class="sla-summary-grid">
  <div class="sla-summary-card">
    <div class="sla-summary-label">{% trans "Effective SLA mode" %}</div>
    <div class="sla-summary-value">
      {% if sla_mode_effective %}
        <span class="sla-summary-badge">
          {{ sla_mode_effective|upper }}
        </span>
      {% else %}
        &mdash;
      {% endif %}
    </div>
  </div>

  <div class="sla-summary-card">
    <div class="sla-summary-label">{% trans "Uptime" %}</div>
    <div class="sla-summary-value">
      {% if sla_uptime is not None %}
        {{ sla_uptime }}%
      {% else %}
        &mdash;
      {% endif %}
    </div>
  </div>

  <div class="sla-summary-card">
    <div class="sla-summary-label">{% trans "Window" %}</div>
    <div class="sla-summary-value">
      {% if sla_window.start %}
        {{ sla_window.start }} → {{ sla_window.end }}
      {% else %}
        &mdash;
      {% endif %}
    </div>
  </div>
</div>

{# 1) No SLA profile at all → nice empty state #}
{% if not sla_profile %}
  <div class="sla-empty-box">
    {% trans "No SLA metrics are applied to this device. Configure one in 'SLA Metrics' to see SLA results here." %}
  </div>

{% else %}
  {# SLA profile exists → show details #}
  <h4 style="margin-top:0.5rem;">{% trans "SLA profile" %}</h4>
  <p style="font-size:0.9rem;">
    <strong>{{ sla_profile.name }}</strong><br>
    {% if sla_profile.sla_mode == 'business' %}
      {% trans "Business days" %}:
      {{ sla_profile.business_days }}<br>
      {% trans "Business time" %}:
      {{ sla_profile.business_start_time }} - {{ sla_profile.business_end_time }}
    {% else %}
      {% trans "24x7 coverage" %}
    {% endif %}
  </p>

  <h4 style="margin-top:1.5rem;">{% trans "Availability intervals in this window" %}</h4>

  {# 2) Profile exists but no intervals → another empty state box #}
  {% if sla_intervals %}
    <table class="sla-intervals-table">
      <thead>
        <tr>
          <th>{% trans "Start" %}</th>
          <th>{% trans "End" %}</th>
          <th>{% trans "Status" %}</th>
          <th>{% trans "Duration" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for it in sla_intervals %}
          <tr>
            <td>{{ it.start }}</td>
            <td>{{ it.end }}</td>
            <td>
              {% if it.status == 'up' %}
                <span class="sla-status-up">{% trans "Up" %}</span>
              {% else %}
                <span class="sla-status-down">{% trans "Down" %}</span>
              {% endif %}
            </td>
            <td>{{ it.duration_human }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="sla-empty-box">
      {% trans "No availability data found for the selected SLA window." %}
    </div>
  {% endif %}
{% endif %}

<script>
(function () {
  const select = document.getElementById('id_sla_window');
  if (!select) return;

  function disableAdminBeforeUnload() {
    if (window.django && django.jQuery) {
      try {
        django.jQuery(window).off('beforeunload.admin');
      } catch (e) {}
    }
    window.onbeforeunload = null;
  }

  // Toggle custom date range visibility
  select.addEventListener('change', function () {
    const customRange = document.getElementById('sla-custom-range');
    if (this.value === 'custom') {
      if (customRange) customRange.style.display = '';
    } else if (customRange) {
      customRange.style.display = 'none';
    }

    disableAdminBeforeUnload();

    const url = new URL(window.location.href);
    url.searchParams.set('sla_window', this.value);
    if (this.value !== 'custom') {
      url.searchParams.delete('sla_start');
      url.searchParams.delete('sla_end');
    }
    window.location.href = url.toString();
  });
})();
</script>
